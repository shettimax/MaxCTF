<?php

namespace App\Http\Middleware;

use App\Models\Student;
use Closure;
use Illuminate\Support\Facades\Auth;

class ConditionalMiddleware
{
    /**
     * Handle an incoming request.
     *
     * @param  \Illuminate\Http\Request $request
     * @param  \Closure $next
     * @return mixed
     */
    public function handle($request, Closure $next)
    {
        $student = Auth::user();

        if ($student instanceof Student) {
            $cm = $student->conditionalMessage();

            $messagesUnread = $cm->unread_conditional_messages();
            if (count($messagesUnread)) {
                return redirect()->route("notification.index", [$messagesUnread[0]->id]);
            }
            $messagesUnaccepted = $cm->unanswered_conditional_messages();
            if (count($messagesUnaccepted)) {
                return redirect()->route("notification.index", [$messagesUnaccepted[0]->id]);
            }
        }

        return $next($request);
    }
}
