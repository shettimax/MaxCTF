<?php

namespace App\Http\Controllers;

use App\Models\Accommodation;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use App\Models\Hostel;
use App\Models\Block;
use App\Models\RegistrationPeriod;
use App\Models\RoomConfig;
use App\Models\OldRoomConfig;
use App\Models\Room;

use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Validator;

class RoomConfigController extends Controller {

    public function __construct() {
        $this->middleware('auth:staff');
    }
    public function index(Request $request) {
        //
        $user = Auth::user();
        $permission = "accommodation.admin.roomconfig.index";
//        if (!$this->access($user,$permission)){
//            return response()->json(["status" => 401, "message" => "You have no permission to do this operation"]);
//        }
        return view('pages.staff.accommodation.roomconfig.index');

        //return view('pages.staff.accommodation.roomconfig.index');
    }

    /**
     */
    public function newRoomConfig(Request $request)
    {
        //
        $user = Auth::user();
        $permission = "accommodation.admin.roomconfig.roomconfigaction";
        if (!$this->access($user,$permission)){
            return response()->json(["status" => 401, "message" => "You have no permission to do this operation"]);
        }
        $accommodation = Accommodation::orderBy('id', 'desc')->first();
        $previousacc = Accommodation::where('id', '<>', $accommodation->id)->orderBy('id', 'desc')->limit(5)->get();
        $maxsessionobj = RoomConfig::orderBy('session', 'desc')->first();
        if (!$maxsessionobj) {
            $regPeriod = RegistrationPeriod::orderBy('session', 'desc')->first();
            $maxsession = $regPeriod->session -1;
        } else {
        $maxsession = $maxsessionobj->session;
    }
        return view('pages.staff.accommodation.roomconfig.newroomconfig', ['accommodation' => $accommodation, 'previousacc' => $previousacc, 'maxsession' => $maxsession]);
    }

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function roomconfigAction(Request $request, $bid = null) {
        //
        $user = Auth::user();
        $permission = "accommodation.admin.roomconfig.roomconfigaction";
//        if (!$this->access($user,$permission)){
//            return response()->json(["status" => 401, "message" => "You have no permission to do this operation"]);
//        }
        $arrdata = array();
//        return $bid;
        if ($bid != null) {
            $selectedblock = Block::find($bid);
            $arrdata['selectedblock'] = $selectedblock;
        }
        $hostels = Hostel::all();
        $arrdata['hostels'] = $hostels;
        return view('pages.staff.accommodation.roomconfig.roomconfigaction', $arrdata);
    }

    public function getRoomConfigHTMLList(Request $request) {
        $id = $request->query->get('blockid');
        //echo $id; exit;
        $accommodation = Accommodation::orderBy('id', 'desc')->first();
        $block = Block::findOrFail($id);
        $rooms = $block->getConfiguredRooms($accommodation->session);
        //var_dump($blocks); exit();
        return view('pages.staff.accommodation.roomconfig.roomconfiglist', array('rooms' => $rooms, 'block' => $block, 'accommodation' => $accommodation));
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create(Request $request, $id = null) {
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request) {
    }

    public function storeAllConfig(Request $request) {
        $validator = Validator::make($request->all(), [
                    'session' => 'required|numeric|min:2018',
                    'prototypesession' => 'required|numeric|min:2016'
        ]);
        if ($validator->fails()) {
            return redirect()->route('accommodation.admin.roomconfig.newroomconfig')
                            ->withErrors($validator)
                            ->withInput();
        }

        $session = $request->input('session');
        $prototypesession = $request->input('prototypesession');
        //transaction
        DB::transaction(function () use ($session, $prototypesession) {
            $rooms = Room::all();
            if (!$rooms) {
                throw new \Exception('Cannot load rooms.');
            }

            foreach ($rooms as $room) {
                $roomconfig = $room->roomconfig;


                if ($roomconfig) {
                    if ($roomconfig->session != $session) {
                        $newroomconfig = new RoomConfig();
                        $newroomconfig->session = $session;
                        $newroomconfig->occupied = 0;
                        $newroomconfig->bed_space = $roomconfig->bed_space;
                        $newroomconfig->reserved = $roomconfig->reserved;
                        $newroomconfig->status = $roomconfig->status;
                        $newroomconfig->room_id = $roomconfig->room_id;
                        $newroomconfig->save();
                    }
                } else {
                    $newroomconfig = new RoomConfig();
                    $newroomconfig->session = $session;
                    $newroomconfig->occupied = 0;
                    $newroomconfig->bed_space = $room->bed_space;
                    $newroomconfig->reserved = 0;
                    $newroomconfig->status = 1;
                    $newroomconfig->room_id = $room->id;
                    $newroomconfig->save();
                }
            }

            $roomconfigs = RoomConfig::where('session', '<>', $session)->get();
            foreach ($roomconfigs as $roomconfig) {
                //create a new record in oldroomconfig table
                $oldroomconfig = new OldRoomConfig();
                $oldroomconfig->session = $roomconfig->session;
                $oldroomconfig->room_no = $roomconfig->room->room_no;
                $oldroomconfig->block_name = $roomconfig->room->block->name;
                $oldroomconfig->hostel_name = $roomconfig->room->block->hostel->name;
                $oldroomconfig->bed_space = $roomconfig->bed_space;
                $oldroomconfig->occupied = $roomconfig->occupied;
                $oldroomconfig->reserved = $roomconfig->reserved;
                $oldroomconfig->status = $roomconfig->status;
                $oldroomconfig->occupants = $roomconfig->occupants;
                //delete the corresponding record in roomconfig table
                $oldroomconfig->save();
                $roomconfig->delete();
            }
        }, 5);

        return redirect()->route('accommodation.admin.roomconfig.roomconfigaction');
    }

    /**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function show(Request $request, $id = null) {
        if ($id == null) {
            $id = $request->query->get('id');
        }
        $roomconfig = RoomConfig::findOrFail($id);

        return view("pages.staff.accommodation.roomconfig.view", array("roomconfig" => $roomconfig));
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function edit(Request $request, $id = null) {
        $user = Auth::user();
        $permission = "accommodation.admin.roomconfig.edit";
        if (!$this->access($user,$permission)){
            return response()->json(["status" => 401, "message" => "You have no permission to do this operation"]);
        }
        if ($id == null) {
            $id = $request->query->get('id');
        }
        $roomconfig = RoomConfig::findOrFail($id);
        return view("pages.staff.accommodation.roomconfig.edit", array("roomconfig" => $roomconfig));
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request) {
        //accommodation.admin.roomconfig.modify
        $user = Auth::user();
        $permission = "accommodation.admin.roomconfig.modify";
        if (!$this->access($user,$permission)){
            return response()->json(["status" => 401, "message" => "You have no permission to do this operation"]);
        }
        $validator = Validator::make($request->all(), [
                    'reserved' => 'required',
                    'status' => 'required',
                    'bedspace' => 'required|numeric|min:1'
                    //'room_config_id'=>'required|numeric'
        ]);
        if ($validator->fails()) {
            return redirect()->route('accommodation.admin.roomconfig.edit', ['id' => $request->input('roomconfigid')])
                            ->withErrors($validator)
                            ->withInput();
        }

        $roomconfig = RoomConfig::findOrFail($request->input('roomconfigid'));
        $roomconfig->reserved = $request->input('reserved');
        $roomconfig->status = $request->input('status');
        $roomconfig->bed_space = $request->input('bedspace');
        $roomconfig->save();
        $request->session()->flash('success', 'Room update was successful!');
        return redirect()->route('accommodation.admin.roomconfig.show', array('id' => $roomconfig->id));
    }

    public function toggleStatus(Request $request, $id = null) {
        $user = Auth::user();
        $permission = "accommodation.admin.roomconfig.togglestatus";
        if (!$this->access($user,$permission)){
            return response()->json(["status" => 401, "message" => "You have no permission to do this operation"]);
        }

        if ($id == null) {
            $id = $request->query->get('id');
        }

        $roomconfig = RoomConfig::findOrFail($id);
        if ($roomconfig->status == '1') {
            $roomconfig->status = '0';
        } else {
            $roomconfig->status = '1';
        }
        $roomconfig->save();
        return view("pages.staff.accommodation.roomconfig.view", array("roomconfig" => $roomconfig));
    }
    public function toggleReservedStatus(Request $request, $id = null) {
        $user = Auth::user();
        $permission = "accommodation.admin.roomconfig.togglereservedstatus";
        if (!$this->access($user,$permission)){
            return response()->json(["status" => 401, "message" => "You have no permission to do this operation"]);
        }

        if ($id == null) {
            $id = $request->query->get('id');
        }

        $roomconfig = RoomConfig::findOrFail($id);
        if ($roomconfig->reserved == '1') {
            $roomconfig->reserved = '0';
        } else {
            $roomconfig->reserved = '1';
        }
        $roomconfig->save();
        if($request->query->get('type')=="ajax"){
            return "1";
        }
        return view("pages.staff.accommodation.roomconfig.view", array("roomconfig" => $roomconfig));
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id) {
        //
    }

    public function createRoomConfig()
    {
        // Get the highest session from accommodations
        $highestSession = DB::table('accommodations')->max('session');

        // Get all rooms that do not have a corresponding entry in room_configs
        $rooms = Room::leftJoin('room_configs', 'rooms.id', '=', 'room_configs.room_id')
            ->whereNull('room_configs.room_id')
            ->select('rooms.id as room_id', 'rooms.bed_space')
            ->get();

        if ($rooms->isEmpty()) {
            return response()->json(['message' => 'There are no new records to update.']);
        }

        // Prepare data for insertion
        $roomConfigs = $rooms->map(function ($room) use ($highestSession) {
            return [
                'room_id' => $room->room_id,
                'session' => $highestSession,
                'bed_space' => $room->bed_space,
                'occupied' => 0,
                'reserved' => '0',
                'owner' => 'all',
                'occupants' => null,
                'created_at' => now(),
                'updated_at' => now(),
            ];
        });

        // Insert the data into room_configs
        RoomConfig::insert($roomConfigs->toArray());

        return response()->json(['message' => 'Room configurations created successfully.']);
    }

}
