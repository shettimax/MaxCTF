<?php

namespace App\Http\Controllers;
use App\Models\SessionReg;;
use App\Models\StudentOlevel;;
use App\Models\Student;;
use Auth;
use App\Models\StudentBiodata;;
use App\Services\FileStorageMigrationService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;


class StudentBiodataController extends Controller
{
    protected FileStorageMigrationService $migrationService;

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function __construct(FileStorageMigrationService $migrationService)
    {
        $this->middleware(['auth:student',"mmode"]);
        $this->migrationService = $migrationService;
    }

    public function index()
    {
        //
        $studentid = Auth::id();
        //return Auth::user()->lga();
        $student=Student::where(["id"=>$studentid])->first();
        $session_reg = Auth::user()->sessionReg()->first();
        $studentbiodata = StudentBiodata::where(["student_id"=>$studentid])->first();
        if(!isset($studentbiodata->id)){
            $studentbiodata = new StudentBiodata;
        }
        return view('pages.student.profile.index',compact("studentbiodata","session_reg", "student"));
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create()
    {
        //
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request)
    {
        //

        $studentid = Auth::id();
        $this->validate($request,StudentBiodata::$rules);
        $student=Student::where(["id"=>$studentid])->first();
        $studentbiodata = StudentBiodata::where(["student_id"=>$studentid])->first();
        if(!isset($studentbiodata->id)){
//            return $request;
            $studentbiodata = new StudentBiodata;
        }
        $studentbiodata->student_id = $studentid;
        $studentbiodata->place_of_birth = $request->placeofbirth;
        $studentbiodata->home_town = $request->hometown;
        $studentbiodata->contact_address = $request->contactaddress;
        $studentbiodata->home_address = $request->homeaddress;
        $studentbiodata->nok_name = $request->nok;
        $studentbiodata->nok_address = $request->nokaddress;
        $studentbiodata->nok_gsm = $request->nokgsm;
        $studentbiodata->blood_group = $request->bloodgroup;
        $studentbiodata->genotype = $request->genotype;
        $studentbiodata->disability = $request->disability;
        $studentbiodata->sponsor = $request->sponsor;
        $studentbiodata->other_sponsor = $request->othersponsor;
        $studentbiodata->sport = $request->sport;
        $studentbiodata->other_phone = $request->otherphone;
        $studentbiodata->health_record = $request->healthrecord;
        $studentbiodata->email = $request->email;
        $studentbiodata->abu_mail = $request->abumail;
        $studentbiodata->gsm = $request->gsm;
        //return $studentbiodata;
        $studentbiodataid = $studentbiodata->save();

        $sessionreg=Auth::user()->sessionReg()->first();
        $sessionreg->marital_status=$request->maritalstatus;
        $sessionreg->save();

        $student->religion=$request->religion;
        if($student->religion=="C"){
            $student->christian_group = $request->christian_group;
        }else{
            $student->christian_group = null;
        }
//        $student->dob=$request->dob;
        $student->save();

        return redirect()->back()->withInput(["message"=>($studentbiodataid)?"Successful":"Not Successful"]);
    }

    /**
     * Display the specified resource.
     *
     * @param  \App\StudentBiodata  $studentBiodata
     * @return \Illuminate\Http\Response
     */
    public function show(StudentBiodata $studentBiodata)
    {
        //
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  \App\StudentBiodata  $studentBiodata
     * @return \Illuminate\Http\Response
     */
    public function edit(StudentBiodata $studentBiodata)
    {
        //
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  \App\StudentBiodata  $studentBiodata
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request, StudentBiodata $studentBiodata)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  \App\StudentBiodata  $studentBiodata
     * @return \Illuminate\Http\Response
     */
    public function destroy(StudentBiodata $studentBiodata)
    {
        //
    }

    public function profilepicture()
    {
        $student = Auth::user();
        $matricNumber = $student->matric_number;

        // Get photo URL using migration service (with fallback)
        $photoUrl = $this->migrationService->getStudentPhotoUrl($matricNumber);

        // If it's an external URL, redirect to it
        if (filter_var($photoUrl, FILTER_VALIDATE_URL) && !str_contains($photoUrl, request()->getHost())) {
            return redirect($photoUrl);
        }

        // If it's a local asset URL, serve the file directly
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        if (file_exists(public_path("studentpics/{$fileName}"))) {
            $pathToFile = public_path("studentpics/{$fileName}");
        } else {
            $pathToFile = public_path("studentpics/user.png");
        }

        return response()->file($pathToFile);
    }

    public function profilepicturebymatric($matric_number)
    {
        // Get photo URL using migration service (with fallback)
        $photoUrl = $this->migrationService->getStudentPhotoUrl($matric_number);

        // If it's an external URL, redirect to it
        if (filter_var($photoUrl, FILTER_VALIDATE_URL) && !str_contains($photoUrl, request()->getHost())) {
            return redirect($photoUrl);
        }

        // If it's a local asset URL, serve the file directly
        $fileName = str_replace("/", "_", strtoupper($matric_number)) . ".JPG";
        if (file_exists(public_path("studentpics/{$fileName}"))) {
            $pathToFile = public_path("studentpics/{$fileName}");
        } else {
            $pathToFile = public_path("studentpics/user.png");
        }

        return response()->file($pathToFile);
    }

    public function profilesignature()
    {
        $student = Auth::user();
        $matricNumber = $student->matric_number;

        // Get signature URL using migration service (with fallback)
        $signatureUrl = $this->migrationService->getStudentSignatureUrl($matricNumber);

        // If it's an external URL, redirect to it
        if (filter_var($signatureUrl, FILTER_VALIDATE_URL) && !str_contains($signatureUrl, request()->getHost())) {
            return redirect($signatureUrl);
        }

        // If it's a local asset URL, serve the file directly
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        if (file_exists(public_path("studentsigns/{$fileName}"))) {
            $pathToFile = public_path("studentsigns/{$fileName}");
        } else {
            $pathToFile = public_path("studentsigns/user.png");
        }

        return response()->file($pathToFile);
    }
    public function getolevelresults(Request $request)
    {
        $studentid = Auth::id();
        $olevels = StudentOlevel::where('student_id', '=', $studentid)
        ->join('olevel_exam_types', 'student_olevels.exam_type_id', '=', 'olevel_exam_types.id')
                ->where('student_olevels.student_id', '=', $studentid)
            ->join('student_olevel_results',"student_olevels.id","=","student_olevel_results.student_olevel_id")
            ->join('subjects',"student_olevel_results.subject_id","=","subjects.id")
            ->select('subjects.subject_description',"student_olevel_results.student_olevel_id AS grade_id", 'student_olevels.sitting', 'olevel_exam_types.exam_type_desc', 'student_olevels.exam_year', 'student_olevels.center_number', 'student_olevels.center_name', 'student_olevels.exam_number')
            ->orderBy("sitting","ASC")
        ->get();
        return view('pages.student.profile.studentolevel',compact('olevels'));
    }

    public function idcard(Request $request)
    {
        $studentid = Auth::id();
        $studentbiodata = StudentBiodata::where(["student_id"=>$studentid])->first();
        if(!isset($studentbiodata->id)){
            $studentbiodata = new StudentBiodata;
        }
        return view('pages.student.profile.idcard',compact("studentbiodata", 'id', 'idcad'));
    }
    public static $passwordrules = [
//        "currentpassword"=>"required|min:6",
        "newpassword"=>"required|min:6|confirmed",
    ];

    public function changepassword(Request $request)
    {
        //
        $studentid = Auth::id();
        $this->validate($request,StudentBiodataController::$passwordrules);
        $student = Student::where(['id'=>$studentid])->first();
        if(Hash::check($request->currentpassword,$student->password)){
            $student->password = bcrypt($request->newpassword);
            $student->save();
            return redirect()->back()->withErrors(['message'=>'Password Changed Successfully']);
        }
        return redirect()->back()->withErrors(["currentpassword"=>"Invalid Password"]);
    }

    public function showpasswordchange()
    {
        //
        return view('pages.student.profile.changepassword');
    }

    public function printprofile()
    {
        //
        $student = Auth::user();
        $studentid = $student->id;
//        $session_reg = $student->sessionReg()->first()->maritalstatus;
        $studentbiodata = StudentBiodata::where(["student_id"=>$studentid])->first();
        $reg = $student->sessionReg()->first();
        $marital_status = $reg?$reg->marital_status:'';
        if(!isset($studentbiodata->id)){
            $studentbiodata = new StudentBiodata;
        }
        return view('pages.student.profile.printprofile', compact("studentbiodata",'id', 'print','marital_status'));
    }
}




