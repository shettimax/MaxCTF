<?php

namespace App\Http\Controllers\Student;

use App\Models\Configuration;
use App\Models\FeeManager;
use App\Models\FormSetting;
use App\Http\Controllers\Controller;
use App\Http\Controllers\StudentBiodataController;

use App\Models\RegistrationPeriod;
use App\Models\Reservation;
use App\Models\Student;
use App\Models\Transaction;
use App\Models\WifiEmail;
use Endroid\QrCode\Label\Font\Font;
use Endroid\QrCode\Label\Font\FontInterface;
use Exception;
use Illuminate\Http\Response;
use Illuminate\Support\Carbon;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use setasign\Fpdi\Fpdi;
use Illuminate\Http\Request;
use App\Models\User;
use setasign\Fpdi\PDF_HTML;

//use SimpleSoftwareIO\QrCode;
//use QrCode;
use App\Models\CandidateForm;
use Endroid\QrCode\QrCode;
use Endroid\QrCode\Color\Color;
use Endroid\QrCode\Encoding\Encoding;
use Endroid\QrCode\ErrorCorrectionLevel\ErrorCorrectionLevelLow;
use Endroid\QrCode\Label\Label;
use Endroid\QrCode\Logo\Logo;
use Endroid\QrCode\RoundBlockSizeMode\RoundBlockSizeModeMargin;
use Endroid\QrCode\Writer\PngWriter;
use Endroid\QrCode\Writer\ValidationException;

class DashboardController extends Controller
{

    public function __construct()
    {
        $this->middleware(["auth:student", "mmode"]);
    }

    /**
     * Display a listing of the resource.
     *
     * @return Response
     */
    public function index()
    {
        //
        $user = Auth::user();
        $candidateForms = CandidateForm::where(["student_id" => $user->id])->get();

        $transactions = Transaction::where(["student_id" => $user->id,])->whereIn( "code",["REG","RST"])->get();

        $wifi = WifiEmail::where(["student_id" => $user->id])->first();

        foreach ($transactions as $transaction) {
            try {
                $response = $transaction->verify();
                $transaction->makeLogs();

            } catch (\Exception $e) {

            }

        }
        $resitSession = $user->resitSessions();
//        if ($candidateForm)
//            return redirect(route("transfers.interfaculty.buy.form.fs", [$candidateForm->form_setting_id, "fs"]));

        return view("pages.student.dashboard", compact('candidateForms','resitSession','wifi'));
    }

    public function ninUpdate(){
        $user = Auth::user();
        $wifi = WifiEmail::where(["student_id" => $user->id])->first();
        return view("pages.student.middleware.nin",compact('wifi','user'));
    }

    public function ninUpdatePost(Request $request){
        $student = Auth::user();
        $student->nin = $request->nin;
        $student->save();
        return redirect(route('student.dashboard'));
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return Response
     */

    public function printAdmissionLetterPg(Request $request){
        $student = Auth::user();
        try {
            $fileName = str_replace("/", "_", strtoupper($student->id));
            $file = public_path() . '/candidatepics/' . $fileName . '.JPG';
            $filePng = public_path() . '/candidatepics/' . $fileName . '.PNG';
//            if ($request->img_err) {
//                if (file_exists($file)) {
//                    $image_mime = image_type_to_mime_type(exif_imagetype($file));
//                    if (str_contains($image_mime, "png")) {
//                        rename($file, $filePng);
//                        $pathToFile = public_path() . "/candidatepics/" . $fileName . ".PNG";
//                    } else
//                        $pathToFile = public_path() . "/candidatepics/" . $fileName . ".JPG";
//                } elseif (file_exists($filePng)) {
//                    $pathToFile = public_path() . "/candidatepics/" . $fileName . ".PNG";
//                } else {
//                    $pathToFile = public_path() . "/studentpics/user.png";
//                }
//            } else {

            $mat = str_replace("/", "_", strtoupper($student->matric_number));
            // if (file_exists(public_path() . '/studentpics/' . $mat . '.JPG')) {
            //     $pathToFile = public_path() . "/studentpics/" . $mat . ".JPG";
            // } else {
            //     $pathToFile = public_path() . "/studentpics/user.png";
            // }
            $pathToFile = public_path() . "/studentpics/user.png";
//                $pathToFile = public_path() . "/studentpics/user.png";
//            }
//            $pathToFile = public_path() . "/studentpics/user.png";
            $photoUrl = 'https://static.abu.edu.ng/uploads/student/photos/' . strtoupper($student->matric_number) . '.JPG';
            $app_no = str_pad($student->matric_number, 10, " ", STR_PAD_LEFT);
            $fullName = $student->getFullName();
            $programme = $student->programme();
            $admissionPath = "admissions/";
            $config = $programme->getConfig(Configuration::ADMISSION_LETTER);
            $secretary_sign = $config->signature;
            $signature = !empty($secretary_sign) && $secretary_sign[0] == '/' ? substr($secretary_sign, 1) : $secretary_sign;
            $signatory = strtoupper($config->config);
            $signatoryPst = $config->position;
            $session = $student->entry_session;
            $regPeriod = RegistrationPeriod::where(['session'=>$session,'nature'=>'FEE'])->first();
            $reg = Carbon::parse($regPeriod->start_date);
            $sessionName = "$session/" . ($session + 1);
            $faculty = $student->faculty();
            $facultyName =$faculty->name;
            $progName = $programme->name;
            $duration = ($programme->duration * 12)." Months";
            $admissionTemplate = $admissionPath . "pg_adm.pdf";
            $pdf = new Fpdi('P', 'mm', 'A4');
            $today = today();
            // add a page
            $pdf->AddPage();
            // set the source file
            $pdf->setSourceFile($admissionTemplate);
            // import page 1
            $tplId = $pdf->importPage(1);
            // use the imported page and place it at point 0,0 with a width of 210 mm
            $pdf->useTemplate($tplId, 0, 0, 210, null, 1);
            $pdf->SetFont('Courier', '', 11);
            $pdf->SetTextColor(60, 60, 60);
            $x = 60;
            $y = 108;
            $h = 0;
            //student picture
            if (@getimagesize($photoUrl)) {
                $pdf->Image($photoUrl, 176, 3, 22);
            } else {
                $pdf->Image(public_path('studentpics/user.png'), 176, 3, 22);
            }
            //serial number
            $pdf->SetXY(172, 40);
            $pdf->Write($h, $today->format('d M Y'));
            $pdf->SetFont('Helvetica', '', 10);
            $pdf->SetXY(30, 43);
            $pdf->Write($h, $fullName);
            $pdf->SetFont('Courier', 'BI', strlen($progName) > 30 ? 8 : 9);
            $pdf->SetXY(37, 73);
            $pdf->Write($h, $progName);
            $pdf->SetFont('Courier', 'B', 9);
            $pdf->SetXY(108, 84.8);
            $pdf->Write($h, $reg->format('jS \of M Y'));
            $pdf->SetFont('Courier', 'B', 9);
            $pdf->SetXY(96, 78.8);
            $pdf->Write($h, $facultyName);
            $pdf->SetXY(155, 79);
            $pdf->Write($h, $duration);
            $pdf->SetXY(76, 95.5);
            $pdf->Write($h, $app_no);

            $writer = new PngWriter();
            // Create QR code
            $qrCode = QrCode::create(trim($app_no))
                ->setEncoding(new Encoding('UTF-8'))
                ->setErrorCorrectionLevel(new ErrorCorrectionLevelLow())
                ->setSize(300)
                ->setRoundBlockSizeMode(new RoundBlockSizeModeMargin())
                ->setForegroundColor(new Color(0, 136, 34, 0));
            $result = $writer->write($qrCode);
            $dataUri = $result->getDataUri();
            $base64 = explode(",", $dataUri);
            $encodedImg = $base64[1];
            $decodedImg = base64_decode($encodedImg);
            
            // Create temporary file in memory and display QR code
            if ($decodedImg !== false) {
                $tempFile = tempnam(sys_get_temp_dir(), 'qr_') . '.png';
                if (file_put_contents($tempFile, $decodedImg) !== false) {
                    $pdf->Image($tempFile, 169, 198, 25);
                    unlink($tempFile); // Clean up temporary file
                }
            }
            $pdf->Image($signature, 51, 197, 26);
            $pdf->SetFont('Courier', 'B', 12);
            $pdf->SetXY(42, 214);
            $pdf->Write($h, $signatory);
            $pdf->SetFont('Courier', '', 12);
            $pdf->SetXY(42, 221);
            $pdf->Write($h, $signatoryPst);

            // use the imported page and place it at point 0,0 with a width of 210 mm
//            $pdf->useTemplate($tplId, 0, 0, 210, null, 1);
            $pdf->Output();
        } catch (\Exception $exception) {
            return $exception->getMessage();
        }
    }
    public function printAdmissionLetter()
    {
        //
        /*$student = Auth::user();
        $data = new \stdClass();
        $data->nationality = $student->country_id==156?"Nigerian":"Non-Nigerian";
        $data->gender = $student->gender;
        $data->state = $student->state()->name;
        $data->lga = $student->lga()->name;
        $data->level = $student->level()->short_name;
        $data->country = $student->nationality()->name;
        $data->faculty = $student->faculty()->name;
        $data->programme = $student->programme()->name;
        $data->jamb_number = $student->jamb_number;
//        return [$data];
        return view("pages.student.dashboard.admission_letter",compact("student","data"));*/

        //information on admission
        $student = Auth::user();
        $entrySession = $student->entry_session . '/' . ((int)$student->entry_session + 1);
        $matric = strtoupper($student->matric_number);
        $app_no = strtoupper($student->application_number);
        $gender = strtoupper($student->gender == "Male" ? "M" : "F");
        $fullname = $student->getFullName();//strtoupper($student->surname . ' ' . $student->firstname . ' ' . $student->other_names);
        $nationality = strtoupper($student->nationality()->name);
        $state = strtoupper($student->state()->name);
        $lga = strtoupper($student->lga()->name);
        $jamb_number = strtoupper($student->jamb_number);
        $level = $student->level()->short_name;
        //TODO: change with utme score record
        $score = CandidateForm::find($app_no);
        $programme = $student->programme();
        $config = $programme->getConfig(Configuration::ADMISSION_LETTER);
        $utme_score = $score->jamb_score;
        $faculty = strtoupper($student->faculty()->name);
        $department = strtoupper($student->department()->name);
        $couse = strtoupper($programme->name);
        $tranparent_image = "admissions/transparent.png";
        //TODO: change name and signature here
        $secretary = strtoupper($config->config);
        $secretary_sign = $config->signature;
        $secretary_sign = !empty($secretary_sign) && $secretary_sign[0] == '/' ? substr($secretary_sign, 1) : $secretary_sign;
        $copy_stamp = "admissions/copy.jpg";
        //TODO: change with provided cc
        $cc_string = 'Vice Chancellor | Chairman Special Admission Committee | Registrar | Dean, Faculty of [Faculty] | Head, Department of [Department] | Dean, Student Affair Division | Director, Academic Planning and Monitoring Unit | Finance Officer | Chief Security Officer | Student\'s File (Academic Division)';
        $cc_string = str_replace('[Faculty]', ucwords(strtolower($faculty)), $cc_string);
        $cc_string = str_replace('[Department]', ucwords(strtolower($department)), $cc_string);
        $cc = explode(' | ', $cc_string);
        $template = "";
        $lvl = $level;//preg_replace('/\D/', '', $level);
        switch ($lvl) {
            case "100L":
            case "200L":
            case "Contact 1":
            case "Contact 2":
                $template = "fresh_adm.pdf";
                break;
            case "300L":
                $template = "special_adm.pdf";
                break;
            default:
                $template = "dip_adm.pdf";
                break;
        }
        $admissionPath = "admissions/";
        $admissionTemplate = $admissionPath . $template;


        //student picture
        $mat = str_replace("/", "_", strtoupper($student->matric_number));
        $photoUrl = 'https://static.abu.edu.ng/uploads/student/photos/' . strtoupper($student->matric_number) . '.JPG';
        $pathToFile = public_path() . "/studentpics/user.png"; // fallback image
        if (!file_exists($secretary_sign)) {
            $secretary_sign = $tranparent_image;
        }

        // initiate FPDI
        $pdf = new Fpdi('P', 'mm', 'A4');
//        $pdf = new PDF_HTML('P','mm','A4');
        // add a page
        $pdf->AddPage();
        // set the source file
        $pdf->setSourceFile($admissionTemplate);
        // import page 1
        $tplId = $pdf->importPage(1);
        // use the imported page and place it at point 0,0 with a width of 210 mm
        $pdf->useTemplate($tplId, 0, 0, 210);
        //setting default font family
        $pdf->AddFont('AmericanTypewriter', '', 'AmericanTypewriterRegular.php'); //Regular
        $pdf->AddFont('AmerTypewriterITCbyBT-Bold', '', 'AmericanTypewriterBoldBT.php'); //Bold
        $pdf->SetFont('AmericanTypewriter', '', 12);
        $pdf->SetTextColor(60, 60, 60);
        //100 and 200 level students
        if ($lvl == "100L" || $lvl == "200L" || $lvl=="Contact 1" || $lvl=="Contact 2") {
            $x = 60;
            $y = 108;
            $h = 0;
            //student picture
            if (@getimagesize($photoUrl)) {
                $pdf->Image($photoUrl, 160, 34, 22);
            } else {
                $pdf->Image($pathToFile, 160, 34, 22);
            }
            //serial number
            $pdf->SetXY(160, 66.5);
            $pdf->Write($h, $matric);
            //row 1
            $pdf->SetXY($x, $y);
            $pdf->Write($h, $fullname);
            $pdf->SetXY(175, $y);
            $pdf->Write($h, $gender);
            //row 2
            $y = 119.4;
            $pdf->SetXY($x-3, $y);
            $pdf->Write($h, $nationality);
            if(strlen($jamb_number) > 10){
                $pdf->SetFont('AmericanTypewriter', '', 10);
            }
            $pdf->SetXY(150, $y);
            $pdf->Write($h, $jamb_number);
            $pdf->SetFont('AmericanTypewriter', '', 12);
            //row 3
            $y = 130.6;
            $pdf->SetXY($x, $y);
            $pdf->Write($h, $state);
            $pdf->SetXY(150, $y);
            $pdf->Write($h, $utme_score);
            //row 4
            $y = 141.7;
            $pdf->SetXY($x, $y);
            $pdf->Write($h, $lga);
            $pdf->SetXY(150, $y);
            $pdf->Write($h, $level);
            //row 5
            $pdf->SetXY($x, 153.7);
            $pdf->Write($h, $faculty);
            //row 6
            $pdf->SetXY($x, 165);
            $pdf->Write($h, $couse);
            //row 7
            $y = 211.8;
            $pdf->SetXY(60, $y);
            $pdf->Write($h, $secretary);
            $pdf->SetXY(150, $y);
            $pdf->Image($secretary_sign, 140, 200, 40);
            //title
            $pdf->SetFont('AmerTypewriterITCbyBT-Bold', '', 18);
            $pdf->SetTextColor(0, 136, 34);
            $pdf->SetXY(37, 85.3);
            $pdf->Write($h, $entrySession);
        }
        //special/transfer students
        if ($lvl == 300) {
            $x = 22.3;
            $h = 0;
            //
            $pdf->SetFont('Arial', '', 12);
            $pdf->SetXY(164, 58);
            $pdf->Write($h, $matric);
            $pdf->SetXY(161, 65);
            $pdf->Write($h, $app_no);
            $pdf->SetXY(161, 72);
            $pdf->Write($h, date('d/m/Y'));
            //
            $pdf->SetXY($x, 76);
            $pdf->Write($h, $fullname);
            $pdf->SetXY($x, 81);
            $pdf->Write($h, "C/O Faculty of " . ucfirst(strtolower($faculty)) . ',');
            $pdf->SetXY($x, 86);
            $pdf->Write($h, "Ahmadu Bello University,");
            $pdf->SetXY($x, 91);
            $pdf->Write($h, "Zaria.");
            //
            $pdf->SetFont('Arial', 'B', 12);
            $pdf->SetTextColor(0, 136, 34);
            $pdf->SetXY($x, 130);
            $pdf->Write($h, "Course: " . $couse);
            $pdf->SetXY($x, 136);
            $pdf->Write($h, "Faculty: " . $faculty);
            //
            $pdf->SetTextColor(0) /*set the below text color black*/
            ;
            /*$pdf->SetFont('Arial','B');*/
            $pdf->Image($secretary_sign, $x, 158, 30);
            $pdf->SetXY($x, 177);
            $pdf->Write($h, $secretary);
            //generate cc
            $pdf->SetFont('Arial', '', 11);
            $pdf->SetXY($x, 190);
            $pdf->Write($h, "Cc:");
            $y = 190;
            $i = 0;
            while ($i < count($cc)) {
                $pdf->SetXY(($x + 10), $y);
                $pdf->Write($h, $cc[$i]);
                $y += 5;
                $i++;
            }
            $pdf->SetXY($x, 190);
            $pdf->Write($h, "Cc:");
            //title
            $pdf->SetFont('AmerTypewriterITCbyBT-Bold', '', 16);
            $pdf->SetTextColor(0, 136, 34);
            $pdf->SetXY(131.5, 104.5);
            $pdf->Write($h, $entrySession);
        }
        /*TODO: change with condition when admitted is
            printed once other will come with "COPY" stamp.
            That may verify original from copy in the case of lost.
        */
        $printed = "No";
        if ($printed == "Yes") {
            $pdf->Image($copy_stamp, 150, 35, 30);
        }
        $writer = new PngWriter();
        // Create QR code
        $qrCode = QrCode::create($matric)
            ->setEncoding(new Encoding('UTF-8'))
            ->setErrorCorrectionLevel(new ErrorCorrectionLevelLow())
            ->setSize(300)
//            ->setMargin(10)
            ->setRoundBlockSizeMode(new RoundBlockSizeModeMargin())
            ->setForegroundColor(new Color(0, 136, 34, 0))
            ->setBackgroundColor(new Color(255, 255, 255));
        // Create generic logo
        $logo = Logo::create(public_path('admissions/abu_logo.png'))
            ->setResizeToWidth(150)
            ->setResizeToHeight(150)
            ->setPunchoutBackground(false);
        // Create generic label
        $label = Label::create($matric)
            ->setTextColor(new Color(255, 0, 0));
        $font = $label->getFont();
        $label->setFont(new Font($font->getPath(), 35));
        $output_file = 'admissions/' . $matric . '.png';
        $result = $writer->write($qrCode, $logo, $label);
        $dataUri = $result->getDataUri();
        $result->saveToFile($output_file);
        $base64 = explode(",", $dataUri);
        $encodedImg = $base64[1];
        $decodedImg = base64_decode($encodedImg);
        if ($decodedImg !== false) {
            //  Save image to a temporary location
            if (file_put_contents($output_file, $decodedImg) !== false) {
                //  Open new PDF document and print image
                $pdf->Image($output_file, 164, 230, 25);
                //  Delete image from server
                unlink($output_file);
            }
        }
        //out the final result
        $pdf->Output();
    }


    /**
     * Store a newly created resource in storage.
     *
     * @param Request $request
     * @return Response
     */
    public function store(Request $request)
    {
        //
        try {
//            return $request;
            $this->validate($request, [
                "name" => "required|min:3",
                "email" => "required|email"
            ]);
            if ($request->userId) {
                $user = User::find($request->userId);
            }

            if (!isset($user))
                $user = new User;

            $user->name = $request->name;
            $user->email = $request->email;
            $user->save();
            return redirect()->back()->withInput(["message" => "successful"]);

        } catch (Exception $e) {
            return $e->getMessage();
        }

    }


    /**
     * Remove the specified resource from storage.
     *
     * @param int $id
     * @return Response
     */
    public function destroy(Request $request)
    {
        //
        try {
//            return $request;
            $user = User::find($request->userId);
            $user->delete();
            return redirect()->back()->withErrors(["message" => "successful"]);

        } catch (Exception $e) {
            return $e->getMessage();
        }
    }

    public function printDiplomaAdmissionLetter()
    {
        try {
            //information on admission
            $student = Auth::user();
            $entrySession = $student->entry_session . '/' . ((int)$student->entry_session + 1);
            $student = Student::find($student->id);
            $matric = strtoupper($student->matric_number);
            $app_no = strtoupper($student->application_number);
            $gender = strtoupper($student->gender == "Male" ? "M" : "F");
            $fullname = strtoupper($student->firstname . ' ' . $student->surname . ' ' . $student->other_names);
            $state = strtoupper($student->state()->name);
            $lga = strtoupper($student->lga()->name);
            $level = $student->level()->short_name;
            $programme = $student->programme();
            $config = $programme->getConfig(Configuration::ADMISSION_LETTER);
            //TODO: change with utme score record
            $faculty = strtoupper($student->faculty()->name);
            $department = strtoupper($student->department()->name);
            $couse = strtoupper($student->programme()->name);
            $tranparent_image = "admissions/transparent.png";
            //TODO: change name and signature here
            $secretary = strtoupper($config->config);
            $secretary_sign = $config->signature;
            $secretary_sign = !empty($secretary_sign) && $secretary_sign[0] == '/' ? substr($secretary_sign, 1) : $secretary_sign;
            $copy_stamp = "admissions/copy.jpg";
            //TODO: change with provided cc

            $admissionTemplate = "admissions/dip_adm.pdf";
            //student picture
            $mat = str_replace("/", "_", strtoupper($student->matric_number));
            $photoUrl = 'https://static.abu.edu.ng/uploads/student/photos/' . strtoupper($student->matric_number) . '.JPG';
            $pathToFile = public_path() . "/studentpics/user.png"; // fallback image
            //academic secretary signature
            if (!file_exists($secretary_sign)) {
                $secretary_sign = $tranparent_image;
            }

            // initiate FPDI
            $pdf = new Fpdi('P', 'mm', 'A4');
            //$pdf = new PDF_HTML('P','mm','A4');
            // add a page
            $pdf->AddPage();
            // set the source file
            $pdf->setSourceFile($admissionTemplate);
            // import page 1
            $tplId = $pdf->importPage(1);
            // use the imported page and place it at point 0,0 with a width of 210 mm
            $pdf->useTemplate($tplId, 0, 0, 210);
            //setting default font family
            $pdf->AddFont('AmericanTypewriter', '', 'AmericanTypewriterRegular.php'); //Regular
            $pdf->AddFont('AmerTypewriterITCbyBT-Bold', '', 'AmericanTypewriterBoldBT.php'); //Bold
            $pdf->SetFont('AmericanTypewriter', '', 11);
            $pdf->SetTextColor(60, 60, 60);
            //Diploma I students
            $x = 25;
            $y = 108;
            $h = 0;

//            reference
            $pdf->SetXY(35, 76.5);
            $pdf->Write($h, $app_no);
            $pdf->SetXY($x, 82);
            $pdf->Write($h, $fullname);
            $pdf->SetXY($x, 88);
            $pdf->Write($h, $lga . ', ' . $state);
            //student picture
            if (@getimagesize($photoUrl)) {
                $pdf->Image($photoUrl, 153, 72, 28, 30);
            } else {
                $pdf->Image($pathToFile, 153, 72, 28, 30);
            }
            //row 2
            $pdf->SetXY($x + 1, 136);
            $pdf->Write($h, $couse);
            //matric number
            $pdf->SetXY(160, 66.5);
            $pdf->Write($h, $matric);

            $pdf->SetXY(150, $y);
            $pdf->Write($h, $level);
            //row 5
            $pdf->SetXY(25, 250);
            $pdf->Write($h, $secretary);
            $pdf->SetXY(150, $y);
            $pdf->Image($secretary_sign, 25, 233, 40);
            //title
            $pdf->SetFont('AmerTypewriterITCbyBT-Bold', '', 17);
            $pdf->SetTextColor(0, 136, 34);
            $pdf->SetXY(143, 114.8);
            $pdf->Write($h, 2023);
            //
            $pdf->SetXY(10, 50);
            $pdf->Cell(0, 10, $faculty, 0, 0, 'C');
            //special/transfer students
            /*TODO: change with condition when admitted is
                printed once other will come with "COPY" stamp.
                That may verify original from copy in the case of lost.
            */
            $printed = "No";
            if ($printed == "Yes") {
                $pdf->Image($copy_stamp, 150, 35, 30);
            }

            //admission qrcode
            $writer = new PngWriter();
            // Create QR code
            $qrCode = QrCode::create($matric)
                ->setEncoding(new Encoding('UTF-8'))
                ->setErrorCorrectionLevel(new ErrorCorrectionLevelLow())
                ->setSize(300)
//            ->setMargin(10)
                ->setRoundBlockSizeMode(new RoundBlockSizeModeMargin())
                ->setForegroundColor(new Color(0, 136, 34, 0))
                ->setBackgroundColor(new Color(255, 255, 255));
            // Create generic logo
            $logo = Logo::create(public_path('admissions/abu_logo.png'))
                ->setResizeToWidth(150)
                ->setResizeToHeight(150)
                ->setPunchoutBackground(false);
            // Create generic label
            $label = Label::create($matric)
                ->setTextColor(new Color(255, 0, 0));
            $font = $label->getFont();
            $label->setFont(new Font($font->getPath(), 35));
            $output_file = 'admissions/' . $matric . '.png';
            $result = $writer->write($qrCode, $logo, $label);
            $dataUri = $result->getDataUri();
            $result->saveToFile($output_file);
            $base64 = explode(",", $dataUri);
            $encodedImg = $base64[1];
            $decodedImg = base64_decode($encodedImg);
            if ($decodedImg !== false) {
                //  Save image to a temporary location
                if (file_put_contents($output_file, $decodedImg) !== false) {
                    //  Open new PDF document and print image
                    $pdf->Image($output_file, 22, 250, 25);
                    //  Delete image from server
                    unlink($output_file);
                }
            }
            //out the final result
            $pdf->Output();
        } catch (Exception $e) {
            return $e->getMessage();
        }
    }

    public function printIoeAdmissionLetter()
    {
        try {
            //information on admission
            $student = Auth::user();
            $entrySession = $student->entry_session . '/' . ((int)$student->entry_session + 1);
            $matric = strtoupper($student->matric_number);
            $app_no = strtoupper($student->application_number);
            $gender = strtoupper($student->gender == "Male" ? "M" : "F");
            $fullname = strtoupper($student->firstname . ' ' . $student->surname . ' ' . $student->other_names);
            $state = strtoupper($student->state()->name);
            $lga = strtoupper($student->lga()->name);
            $level = $student->level()->short_name;
            //TODO: change with utme score record
            $faculty = strtoupper($student->faculty()->name);
            $department = strtoupper($student->department()->name);
            $couse = strtoupper($student->programme()->name);
            $duration = strtoupper($student->programme()->duration) . ' Years';
            $tranparent_image = "admissions/transparent.png";
            //TODO: change name and signature here

            $programme = $student->programme();
            $config = $programme->getConfig(Configuration::ADMISSION_LETTER);
            $secretary = strtoupper($config->config);
            $secretary_sign = $config->signature;
            $secretary_sign = !empty($secretary_sign) && $secretary_sign[0] == '/' ? substr($secretary_sign, 1) : $secretary_sign;
            $copy_stamp = "admissions/copy.jpg";
            //TODO: change with provided cc

            $admissionTemplate = "admissions/ioe_dip_adm.pdf";
            //student picture
            $mat = str_replace("/", "_", strtoupper($student->matric_number));
            $photoUrl = 'https://static.abu.edu.ng/uploads/student/photos/' . strtoupper($student->matric_number) . '.JPG';
            $pathToFile = public_path() . "/studentpics/user.png"; // fallback image
            //academic secretary signature
            if (!file_exists($secretary_sign)) {
                $secretary_sign = $tranparent_image;
            }

            // initiate FPDI
            $pdf = new Fpdi('P', 'mm', 'A4');
            //$pdf = new PDF_HTML('P','mm','A4');
            // add a page
            $pdf->AddPage();
            // set the source file
            $pdf->setSourceFile($admissionTemplate);
            // import page 1
            $tplId = $pdf->importPage(1);
            // use the imported page and place it at point 0,0 with a width of 210 mm
            $pdf->useTemplate($tplId, 0, 0, 210);
            //setting default font family
            $pdf->AddFont('AmericanTypewriter', '', 'AmericanTypewriterRegular.php'); //Regular
            $pdf->AddFont('AmerTypewriterITCbyBT-Bold', '', 'AmericanTypewriterBoldBT.php'); //Bold
            $pdf->SetFont('AmericanTypewriter', '', 12);
            $pdf->SetTextColor(60, 60, 60);
            //Diploma I students
            $x = 25;
            $y = 106;
            $h = 0;

//            reference
            $pdf->SetXY(30, 70.5);
            $pdf->Write($h, $app_no);
            $pdf->SetXY($x, 76);
            $pdf->Write($h, $fullname);
            $pdf->SetXY($x, 81);
            $pdf->Write($h, $lga . ', ' . $state);
            //student picture
            if (@getimagesize($photoUrl)) {
                $pdf->Image($photoUrl, 158, 68, 28, 30);
            } else {
                $pdf->Image($pathToFile, 158, 68, 28, 30);
            }
            //row 2
            $pdf->SetXY($x + 1, 135);
            $pdf->Write($h, $couse);
            //matric number
            $pdf->SetXY(160, 60.5);
            $pdf->Write($h, $matric);

            $pdf->SetXY(155, $y - 5);
            $pdf->Write($h, $level);

            $pdf->SetXY(95, 189);
            $pdf->Write($h, $duration);

            $pdf->SetXY(90, 195);
            $pdf->Write($h, $matric);
            //row 5
            $pdf->SetXY(23, 262);
            $pdf->Write(0, $secretary);

            $pdf->SetXY(170, $y);
            $pdf->Image($secretary_sign, 25, 245, 40);
            //title
            $pdf->SetFont('AmerTypewriterITCbyBT-Bold', '', 17);
            $pdf->SetTextColor(0, 136, 34);
            $pdf->SetXY(147, 111.8);
            $pdf->Write($h, $entrySession);
            //
            $pdf->SetXY(10, 45);
            $pdf->Cell(0, 10, $faculty, 0, 0, 'C');
            //special/transfer students
            /*TODO: change with condition when admitted is
                printed once other will come with "COPY" stamp.
                That may verify original from copy in the case of lost.
            */
            $printed = "No";
            if ($printed == "Yes") {
                $pdf->Image($copy_stamp, 150, 35, 30);
            }

            //admission qrcode
            $writer = new PngWriter();
            // Create QR code
            $qrCode = QrCode::create($matric)
                ->setEncoding(new Encoding('UTF-8'))
                ->setErrorCorrectionLevel(new ErrorCorrectionLevelLow())
                ->setSize(300)
//            ->setMargin(10)
                ->setRoundBlockSizeMode(new RoundBlockSizeModeMargin())
                ->setForegroundColor(new Color(0, 136, 34, 0))
                ->setBackgroundColor(new Color(255, 255, 255));
            // Create generic logo
            $logo = Logo::create(public_path('admissions/abu_logo.png'))
                ->setResizeToWidth(150)
                ->setResizeToHeight(150)
                ->setPunchoutBackground(false);
            // Create generic label
            $label = Label::create($matric)
                ->setTextColor(new Color(255, 0, 0));
            $font = $label->getFont();
            $label->setFont(new Font($font->getPath(), 35));
            $output_file = 'admissions/' . $matric . '.png';
            $result = $writer->write($qrCode, $logo, $label);
            $dataUri = $result->getDataUri();
            $result->saveToFile($output_file);
            $base64 = explode(",", $dataUri);
            $encodedImg = $base64[1];
            $decodedImg = base64_decode($encodedImg);
            if ($decodedImg !== false) {
                //  Save image to a temporary location
                if (file_put_contents($output_file, $decodedImg) !== false) {
                    //  Open new PDF document and print image
                    $pdf->Image($output_file, 22, 250, 25);
                    //  Delete image from server
                    unlink($output_file);
                }
            }
            //out the final result
            $pdf->Output();
        } catch (Exception $e) {
            return $e->getMessage();
        }
    }

    public function interFacultyTransfer()
    {
        if (!Auth::user()->canApplyForTransfer())
            abort(503);

        $student = Auth::user();
        $candidateForms = CandidateForm::where(["student_id" => $student->id])->orderBy('id','desc')->get();
//        if ($candidateForm)
//            return redirect(route("transfers.interfaculty.buy.form.fs", [$candidateForm->form_setting_id, "fs"]));

        $programmes = DB::table("form_settings")
            ->join("programmes", "programmes.id", "=", "form_settings.programme_id")
            ->join("candidate_form_types", "candidate_form_types.id", "=", "form_settings.candidate_form_type_id")
            ->join('departments', 'departments.id', '=', 'programmes.department_id')
            ->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
            ->where(['candidate_form_type_id' => 10])
            ->whereDate("start_date", "<=", today())
            ->whereDate("end_date", ">=", today())
            ->whereNotIn("candidate_form_type_id", [1, 2])
            ->select(["programmes.name AS programme", "form_price", "session", "short_desc",
                "start_date", "late_start_date", "end_date", "duration", "department_id",
                "candidate_form_types.name AS type", "require_ref_response", "candidate_form_type_id",
                "form_settings.id AS fs_id", 'prog_type_name', 'departments.name AS department'])
//            ->select("candidate_form_types.*", "programmes.name AS programme", "form_settings.*")
            ->get();

        return view("pages.student.transfers.interfaculty", compact("programmes",'candidateForms','student'));
    }

    public function interFacultyTransferChange(Request $request)
    {
        if (!Auth::user()->canApplyForTransfer())
            abort(503);

        $student = Auth::user();
        $candidateForm = CandidateForm::find($request->cfm);
        if ($candidateForm->student_id != $student->id)
            back()->withErrors(['message' => "Invalid request"]);

        $fms = FormSetting::where(["session" => $request->input('session'), "candidate_form_type_id" => 10, "programme_id" => $request->programme_id])->first();
        if ($fms) {
            $candidateForm->form_setting_id = $fms->id;
            $candidateForm->save();
        }
        return back();
    }

    public function formSettings(Request $request, $id)
    {
        $student = Auth::user();

        if ($cf = CandidateForm::where(["form_setting_id" => $id, "student_id" => $student->id])->first()) {
            //return $id;
        } else {
            $cf = new CandidateForm;
            $cf->form_setting_id = $id;
            $cf->student_id = $student->id;
            $cf->date_started = now();
            $cf->date_submitted = null;
            $cf->admission_status = "pending";
            $cf->payment_status = "Not Paid";
            $cf->jamb_score = "0";
            $cf->save();
        }
        //return $cf;
        return redirect(route("transfers.interfaculty.form.buy.form", [$cf->id]));

    }

    public function transferForm(Request $request, $id)
    {
        $student = Auth::user();

        foreach ($student->formTransactions() as $transaction) {
            $transaction->verify();
        }

        $candidateForm = CandidateForm::where(["student_id" => $student->id, "id" => $id])->first();

        if ($candidateForm) {

            if ($candidateForm->candidateFormType()->id == 10) {
//                return view("pages.forms.myform.view_putme", compact("candidateForm", "candidate"));
            }
            return view("pages.student.transfers.myforms", compact("candidateForm", "student"));
        } else {
            return redirect(route("transfers.interfaculty.index"));
        }
    }

    public function pay(Request $request, $id)
    {
        $student = Auth::user();
        $studentBiodata = $student->biodata();
        $candidateForm = CandidateForm::where(["student_id" => $student->id, "id" => $id])->first();
        if ($candidateForm) {
            $fsSession = $candidateForm->formSetting->first()->session;
            $formSettings = FormSetting::where(["id" => $candidateForm->form_setting_id])->first();
            $type = $candidateForm->candidateFormType();
            $code = FeeManager::generateTransactionCode($candidateForm->id, "FRM", $fsSession, $type->code);
            $transaction = Transaction::where("transaction_code", $code)->first();
            $transaction->verify();
            $programme = $formSettings->programme();
            $department = $programme->department();
            $faculty = $department->faculty();
            $session = $fsSession;
            $biodata = $student->biodata();
            $message = "";
            if ($transaction->invoice_number == $transaction->transaction_code) {
                $mert = Transaction::MERCHANTID;
                $api_key = Transaction::APIKEY;
//                $responseurl="https://spgs.abu.edu.ng/portal/transaction/fees/response";$hash="";
                $responseurl = "https://putme.abu.edu.ng/buy/pay";
                $hash = "";
                $concatString = Transaction::MERCHANTID . (($formSettings->candidate_form_type_id == 1 || $formSettings->candidate_form_type_id == 2) ? Transaction::SERVICETYPEID : Transaction::OTHERFORMSSERVICEID) . $transaction->transaction_code . intval($transaction->transaction_amount) . Transaction::APIKEY;
                $hash = hash('sha512', $concatString);
                $data = [
//                "merchantId"=>Transaction::MERCHANTID,
                    "serviceTypeId" => ($formSettings->candidate_form_type_id == 1 || $formSettings->candidate_form_type_id == 2) ? Transaction::SERVICETYPEID : Transaction::OTHERFORMSSERVICEID,
//                "amt"=>$trans->transaction_amount,
                    "amount" => intval($transaction->transaction_amount),
//                "responseurl"=>$responseurl,
//                "hash"=>$hash,
                    "payerName" => $student->getFullName(),
                    "description" => "ABU eForms Purchase",
                    "payerEmail" => $biodata->email,
                    "payerPhone" => $biodata->gsm,
                    "orderId" => $transaction->transaction_code,
                    "customFields" => [
                        ["name" => "PayerID", "value" => $student->jamb_number, "type" => "All"],
                        ["name" => "Session", "value" => $session, "type" => "All"],
                    ]
                ];
                $data_string = json_encode($data);
                try {
                    $ch = curl_init("https://login.remita.net/remita/exapp/api/v1/send/api/echannelsvc/merchant/api/paymentinit");

                    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
                    curl_setopt($ch, CURLOPT_POSTFIELDS, $data_string);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
                        "Authorization: remitaConsumerKey=$mert,remitaConsumerToken=$hash",
                        'Content-Type: application/json',
                        'Content-Length: ' . strlen($data_string)
                    ));
                    $response = curl_exec($ch);
                    curl_close($ch);
                    $response = substr($response, 7);
                    $response = substr($response, 0, -1);
                    $response = json_decode($response);
                    if ($response->statuscode == "025") {
                        $transaction->invoice_number = $response->RRR;
                        $transaction->save();
                    } else {
                        $message = "Failed to generate RRR please try again later.";
                    }
                } catch (\Exception $e) {
                    try {
                        $concatString = $transaction->transaction_code . Transaction::APIKEY . Transaction::MERCHANTID;
                        $hash = hash('sha512', $concatString);
//                        https://login.remita.net/remita/ecomm/{merchantId}/{OrderID}/{hash}/orderstatus.reg
                        $ch = curl_init("https://login.remita.net/remita/ecomm/" . Transaction::MERCHANTID . "/" . $transaction->transaction_code . "/" . $hash . "/orderstatus.reg");
                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                        $response = curl_exec($ch);
                        $response = json_decode($response);
                        if (!empty($response)) {
                            $transaction->invoice_number = $response->RRR;
                            $transaction->save();
                        }
                    } catch (\Exception $e) {
                    }
                }
            }
            return view("pages.student.transfers.pay", compact("transaction", "student", "faculty", "programme", "department", "session", "studentBiodata", "type", "candidateForm"));
        } else {
            return redirect(route("transfers.interfaculty.index"));
        }
    }

    public function completedForm(Request $request, $id)
    {
        //
        $student = Auth::user();
        $candidateForm = CandidateForm::where(["student_id" => $student->id, "id" => $id])->first();
        if ($candidateForm) {
            $studentBiodata = $student->biodata();
            $type = $candidateForm->candidateFormType();
            $transaction = $candidateForm->transactions()[0];
            $programme = $student->sessionProgramme($student->currentSession());
            $department = $programme->department()->first();
            $faculty = $department->faculty()->first();
            $session = $candidateForm->formSetting->session;
            return view("pages.student.transfers.completed_form", compact("student", "candidateForm", "studentBiodata", "programme", "faculty", "department", "session", "transaction", "type"));

        } else {
            return redirect(route("transfers.interfaculty.index"));
        }

    }


    public function updateMatric(Request $request, $id)
    {
//        return $request;
        $candidate = Auth::user();
        $candidateForm = CandidateForm::where(["student_id" => $candidate->id, "id" => $id])->first();
        if ($candidateForm) {
            $candidateForm->jamb_number = $candidate->matric_number;
            $candidateForm->jamb_score = $request->cgpa;
            $candidateForm->save();

        }
        return back();
    }

    public function printExitForm()
    {
        $student = Auth::user();

        return view('pages.student.exitform.index', compact('student'));
    }
}
