<?php

namespace App\Http\Controllers\Staff;

use App\Http\Controllers\Controller;
use App\Models\Department;
use App\Models\Level;
use App\Models\Programme;
use App\Models\ProgrammeType;
use App\Models\RegistrationPeriod;
use App\Models\SpecialRegistrationPeriod;
use App\Models\Student;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Session;

class DiplomaRegistrationPeriodController extends Controller
{
    public function __construct()
    {
        $this->middleware('auth:staff');

    }

    public function index()
    {
        $model = null;
        return view('pages.staff.settings.setdiplomaregistrationperiod', compact('model'));
    }

    public function show($department, $session)
    {
        $records = RegistrationPeriod::select(["registration_periods.*", 'programmes.name'])
            ->join('programmes', 'programmes.id', 'registration_periods.programme_id')
            ->join('departments', 'departments.id', 'programmes.department_id')
            ->where(['programmes.department_id' => $department, 'registration_periods.session' => $session])
            ->get();

        $table = "<table class='table table-bordered table-responsive' style='width:100%;font-size:14px;font-family: times new roman;'>";
        $table .= "<tr><th>S/N</th><th>Programme</th><th>Session</th><th>Semester</th><th>Level</th><th>Nature</th><th>Start Date</th><th>Late Start Date</th><th>End Date</th><th>Action</th></tr>";
        $i = 1;
        foreach ($records as $record) {
            $table .= "<tr><td>" . ($i++) . "</td><td>" . $record->name . "</td><td>" . $record->session . "</td><td style='text-align: center;'>" . ($record->semester == 1 ? "First Semester" : "Second Semester") . "</td><td>" . $record->level_id . "</td><td>" . $record->nature . "</td><td>" . Carbon::parse($record->start_date)->toDayDateTimeString() . "</td><td>" . Carbon::parse($record->late_start_date)->toDayDateTimeString() . "</td><td>" . Carbon::parse($record->end_date)->toDayDateTimeString() . "</td>";
            $table .= "<td style='text-align: center;'><a href='" . route('registration.edit', ['id' => $record->id]) . "'><span class='icon icon-edit2'></span> Edit</a></td></tr>";
        }
        $table .= "</table>";
        return $table;
    }

    public function store(Request $request)
    {
        //return $request;
        try {
            $rules = [
                'faculty' => 'required',
                'department' => 'required',
                'programme' => 'required',
                'acadsession' => 'required',
                'semester' => 'required',
                'newreturning' => 'required',
                'level' => 'required',
                'nature' => 'required',
                'sdate' => 'required|date',
                //  'ldate' => 'required|date',
                //'cdate' => 'required|date',
            ];


            $validator = $request->validate($rules);
            if (!$validator) {
                return redirect()->route('registration')->withInput()->withErrors();
            } else {
                $faculty = $request->faculty;
                $department = $request->department;
                $programme = $request->programme;
                $programmeType = $request->progtype;
                $session = $request->acadsession;
                $semester = $request->nature == "FEE" ? 0 : $request->semester;
                $newreturning = $request->newreturning;

                $level = $request->level;
                $nature = $request->nature;
                $sdate = $request->sdate;
                $ldate = $request->ldate;
                $cdate = $request->cdate;
                if ($faculty == "%") {

                    if ($department == "%") {
                        if ($programme == "%") {
                            $programmes = Programme::where("programme_type_id", $programmeType);
                        } else {
                            $programmes = Programme::where(["programme_type_id" => $programmeType, "id" => $programme]);
                        }
                    } else {
                        if ($programme == "%") {
                            $programmes = Programme::where(["programme_type_id" => $programmeType, 'department_id' => $department]);
                        } else {
                            $programmes = Programme::where(["programme_type_id" => $programmeType, "id" => $programme]);
                        }
                    }

                } else {
                    if ($department == "%") {
                        $departmentIds = Department::where('faculty_id', $faculty)->pluck('id');
                        if ($programme == "%") {
                            $programmes = Programme::where(["programme_type_id" => $programmeType])
                                ->whereIn('department_id', $departmentIds);
                        } else {
                            $programmes = Programme::where(["programme_type_id" => $programmeType, "id" => $programme]);
                        }
                    } else {
                        if ($programme == "%") {
                            $programmes = Programme::where(["programme_type_id" => $programmeType, 'department_id' => $department]);
                        } else {
                            $programmes = Programme::where(["programme_type_id" => $programmeType, "id" => $programme]);
                        }
                    }
                }

                $programmes = $programmes->get();
                $levels = [];
                $semesters = [];
                $newreturnings = [];
                $natures = [];

                if ($level == "%") {
                    $levels = Level::where("programme_type_id", $programmeType)->pluck('id')->toArray();
                } else {
                    $levels = [$level];
                }

                if ($semester == "%") {
                    $semesters = [1, 2];
                } else {
                    $semesters = [$semester];
                }

                if ($nature == "%") {
                    $natures = ['REG', 'FEE'];
                } else {
                    $natures = [$nature];
                }
                if ($newreturning == "%") {
                    $newreturnings = ['New', 'Returning'];
                } else {
                    $newreturnings = [$newreturning];
                }


                $regPeriodArr = [];
                $res = [];
//                return [$programmes,$levels,$semesters,$newreturnings,$natures];
                foreach ($programmes as $programme) {
                    foreach ($levels as $lvl) {
                        foreach ($semesters as $sem) {
                            foreach ($newreturnings as $nr) {
                                foreach ($natures as $nat) {
                                    $sm = $sem;
                                    if($nat=='FEE')
                                        $sm = 0;
                                    $rg = [
                                        'session' => $session, 'semester' => $sm, "level_id" => $lvl,
                                        'nature'=>$nat,'new_returning'=>$nr,"programme_id"=>$programme->id
                                    ];
                                    $regPeriodArr[] =$rg;
                                    $regPeriod = RegistrationPeriod::where($rg)->first();

                                    if(!$regPeriod){
                                        $regPeriod = new RegistrationPeriod();
                                        $regPeriod->session = $session;
                                        $regPeriod->semester = $sm;
                                        $regPeriod->level_id = $lvl;
                                        $regPeriod->nature = $nat;
                                        $regPeriod->new_returning = $nr;
                                        $regPeriod->programme_id = $programme->id;
                                        $regPeriod->created_at = now();
                                    }
                                    $regPeriod->start_date = $sdate;
                                    $regPeriod->late_start_date = $ldate;
                                    $regPeriod->end_date = $cdate;
                                    $regPeriod->updated_at = now();
                                    $regPeriod->save();

                                }
                            }
                        }
                    }
                }
//                return $regPeriodArr;
                return redirect()->back()->withInput($request->all());
            }
        } catch (\Exception $e) {
            $message = $e;
            return view("pages.errors.failed", compact('message'));
        }

    }

    public function isRegistrationSet($programme, $session)
    {
        $model = RegistrationPeriod::where(['programme_id' => $programme, 'session' => $session])->select('id')->first();
        return $model != null ? true : false;
    }

    public function edit($period)
    {
        $model = RegistrationPeriod::find($period);
        return view('pages.staff.settings.setregistrationperiod', compact('model'));
    }

    public function showSingleForm()
    {
        return view('pages.staff.settings.setindividualregistrationperiod');
    }

    public function singleStore(Request $request)
    {
        try {
            $rules = [
                'studentid' => 'required',
                'acadsession' => 'required',
                'semester' => 'required',
                'nature' => 'required',
                'sdate' => 'required|date',
                'cdate' => 'required|date',
            ];
            $validator = $request->validate($rules);
            if (!$validator) {
                return back()->withInput()->withErrors();
            } else {
                $studentid = $request->studentid;
                $session = $request->acadsession;
                $semester = $request->semester;
                $nature = $request->nature;
                $sdate = $request->sdate;
                $ldate = $request->cdate;
                $cdate = $request->cdate;

                $db = SpecialRegistrationPeriod::where(["student_id" => $studentid, "session" => $session,'semester'=>$semester,'nature'=>$nature])->first();
                if (!$db){
                    $db = new SpecialRegistrationPeriod();
                    $db->student_id = $studentid;
                    $db->session = $session;
                    $db->semester = $semester;
                    $db->nature = $nature;
                }

                $db->start_date = $sdate;
                $db->late_start_date = $ldate;
                $db->end_date = $cdate;
                $db->save();
                if ($request->has('periodid')) {
                    $request->session()->flash('status', 'Registration period was updated successfully');
                    Session::flash('alert-class', 'alert-info');
                } else {
                    $request->session()->flash('status', 'Registration period was set successfully');
                    Session::flash('alert-class', 'alert-info');
                }
                return redirect()->back()->withInput($request->all());
            }
        } catch (\Exception $e) {
            $message = $e;
            return view("pages.errors.failed", compact('message'));
        }
    }

    public function searchStudent(Request $request)
    {
        $matric = $request->matric;
        $model = Student::where('matric_number', '=', $matric)->first();
        $record = "";
        if ($model != null) {
            $record .= "<div style='color:008000;font-size:18px;font-family: Calibri;'>Name: " . $model->surname . " " . $model->firstname . " " . $model->othernames . "<br/>";
            $record .= "Department: " . Programme::find($model->programme_id)->department()->name . "<br/>";
            $record .= "Programme: " . Programme::find($model->programme_id)->name . "</div>";
            $record .= "<input type='hidden' value='" . $model->id . "' name='studentid' id='studentid'/>";
        } else
            $record .= "<div style='color:FF0000;font-size:18px;font-family: Calibri;'>No student found with registration number $matric</div>";
        return $record;
    }

    public function showSinglePeriod($studentid, $session)
    {
        $records = SpecialRegistrationPeriod::select("special_registration_periods.*", 'programmes.name')
            ->join('students', 'students.id', 'special_registration_periods.student_id')
            ->join('programmes', 'programmes.id', 'students.programme_id')
            ->join('departments', 'departments.id', 'programmes.department_id')
            ->where(['special_registration_periods.student_id' => $studentid, 'special_registration_periods.session' => $session])->get();

        $table = "<table class='table table-bordered table-responsive' style='width:100%;font-size:14px;font-family: times new roman;'>";
        $table .= "<tr><th>S/N</th><th>Programme</th><th>Session</th><th>Semester</th><th>Nature</th><th>Start Date</th><th>Late Start Date</th><th>End Date</th><th>Action</th></tr>";
        $i = 1;
        foreach ($records as $record) {
            $table .= "<tr><td>" . ($i++) . "</td><td>" . $record->name . "</td><td>" . $record->session . "</td><td style='text-align: center;'>" . ($record->semester == 1 ? "First Semester" : "Second Semester") . "</td><td>" . $record->nature . "</td><td>" . Carbon::parse($record->startdate)->toDayDateTimeString() . "</td><td>" . Carbon::parse($record->latestartdate)->toDayDateTimeString() . "</td><td>" . Carbon::parse($record->enddate)->toDayDateTimeString() . "</td>";
            $table .= "<td style='text-align: center;'><a href='" . route('single.period.edit', ['id' => $record->id]) . "'><span class='icon icon-edit2'></span> Edit</a></td></tr>";
        }
        $table .= "</table>";
        return $table;
    }

    public function editSinglePeriod($period)
    {
        $model = SpecialRegistrationPeriod::find($period);
        return view('pages.staff.settings.setindividualregistrationperiod', compact('model'));
    }

    public function inherit()
    {
        /*
        $programmes = RegistrationPeriod::select('prog_type_code', 'programme_types.prog_type_name', 'programme_id')->distinct('prog_type_code')
            ->join('programme_types', 'registration_periods.programme_id', 'programme_types.id')
            ->orderby('prog_type_code', 'DESC')->get();
        */
        $programmetypes = ProgrammeType::all();
        $prevsessions = RegistrationPeriod::select('session')->distinct()->orderby('session', 'DESC')->get();
        $semesters = RegistrationPeriod::select('semester')->distinct()->orderby('semester', 'DESC')->get();

        $levels = RegistrationPeriod::select('level_id', 'levels.name')->distinct('level_id')
            ->join('levels', 'registration_periods.level_id', 'levels.id')->orderby('level_id', 'DESC')->get();

        return view('pages.staff.settings.inheritregistration', compact('programmetypes', 'prevsessions', 'semesters', 'levels'));
    }

    public function inheritPost(Request $request)
    {
        // return $request; exit();
        try {
            $this->validate($request, [
                "session" => "required",
                "prevsession" => "required",
                "semester" => "required",
                "programme" => "required",
                "level" => "required",
                "newreturningstudent" => "required",
                "nature" => "required",
                "startdate" => "required",
                "latedate" => "required",
                "enddate" => "required"
            ]);

            $currentsession = $request['session'];
            $prevsession = $request['prevsession'];
            $semester = $request['semester'] == 0 ? '%' : $request['semester'];
            $programme = $request['programmename'] == 0 ? '%' : $request['programmename'];
            $level = $request['level'] == 0 ? '%' : $request['level'];
            $returningnew = $request['newreturningstudent'] == 0 ? '%' : $request['newreturningstudent'];
            $nature = $request['nature'] == 0 ? '%' : $request['nature'];
            $sdate = $request['startdate'];
            $ldate = $request['latedate'];
            $edate = $request['enddate'];

            $records = RegistrationPeriod::where('session', '=', $prevsession)
                ->where('semester', 'LIKE', $semester)
                ->where('programme_id', 'LIKE', $programme)
                ->where('level_id', 'LIKE', $level)
                ->where('new_returning', 'LIKE', $returningnew)
                ->where('nature', 'LIKE', $nature)->get();

            foreach ($records as $record) {

                $ckeckexistingrecords = RegistrationPeriod::where([
                    ['session', '=', $currentsession],
                    ['programme_id', '=', $record['programme_id']],
                    ['semester', '=', $record['semester']],
                    ['level_id', '=', $record['level_id']],
                    ['new_returning', '=', $record['new_returning']],
                    ['nature', '=', $record['nature']],
                    ['start_date', '=', $sdate],
                    ['late_start_date', '=', $ldate],
                    ['end_date', '=', $edate],
                ]);

                if ($ckeckexistingrecords->count()) {
                    continue;
                }

                $dbrecord = new RegistrationPeriod();
                $dbrecord->session = $currentsession;  //get record from the form, session , late date , end date
                $dbrecord->programme_id = $record['programme_id'];  //get record from the record set been fetch .
                $dbrecord->semester = $record['semester'];
                $dbrecord->level_id = $record['level_id'];
                $dbrecord->new_returning = $record['new_returning'];
                $dbrecord->nature = $record['nature'];
                $dbrecord->start_date = $sdate;
                $dbrecord->late_start_date = $ldate;
                $dbrecord->end_date = $edate;
                $dbrecord->save();
                return redirect()->back()->with("success", 'Record successfully created!');
            }
        } catch (\Exception $e) {
            return redirect()->back()->with("error", $e->getMessage() . 'All fields are Required');
        }

    }

    public function loadInheritPreview($session, $semester, $programme, $level, $nature, $new_return)
    {
        if ($semester == 0)
            $semester = '%';
        if ($programme == 0)
            $programme = '%';
        if ($level == 0)
            $level = '%';
        if ($new_return == 0)
            $new_return = '%';

        $records = RegistrationPeriod::where('session', 'LIKE', $session)
            ->where('semester', 'LIKE', $semester)
            ->where('programme_id', 'LIKE', $programme)
            ->where('level_id', 'LIKE', $level)
            ->where('nature', 'LIKE', $nature)
            ->where('new_returning', 'LIKE', $new_return)->get();
        $msg = "";
        $i = 0;
        //$programe = Programme::find($records['programme_id']);
        foreach ($records as $record) {
            $programe = Programme::find($record['programme_id']);
            $department = $programe->department()->first();
            $faculty = $department->faculty()->first();
            $semester = ($record['semester'] == 1) ? "First Semester" : "Second Semester";
            $level = Level::find($record['level_id']) != null ? Level::find($record['level_id'])->short_name : "";
            $msg .= "<tr><td>" . (++$i) . "</td><td>" . $faculty->name . "</td><td>" . $department->name . "</td><td>" . $programe->name . "</td>";
            $msg .= "<td>" . $level . "</td><td>" . $record['session'] . "</td><td>" . $semester . "</td><td>" . $record['new_returning'] . "</td><td>" . $record['nature'] . "</td>";
            $msg .= "<td>" . $record['start_date'] . " </td><td>" . $record['late_start_date'] . "</td><td>" . $record['end_date'] . "</td></tr>";
        }
        return $msg;
    }

    public function addanddrop()
    {
        $programmetypes = ProgrammeType::all();
        $prevsessions = RegistrationPeriod::select('session')->distinct()->orderby('session', 'DESC')->get();
        $semesters = RegistrationPeriod::select('semester')->distinct()->orderby('semester', 'DESC')->get();
        $levels = RegistrationPeriod::select('level_id', 'levels.name')->distinct('level_id')
            ->join('levels', 'registration_periods.level_id', 'levels.id')->orderby('level_id', 'DESC')->get();

        return view('pages.staff.settings.setaddanddropregistration', compact('programmetypes', 'prevsessions', 'semesters', 'levels'));

    }

    public function getProgrammes(ProgrammeType $id)
    {
        return $id->hasMany(Programme::class, 'programme_type_id')->orderBy("name")->get()->all();
    }

    public function loadaddanddropPreview($session, $semester, $programme, $level, $nature, $new_return)
    {
        if ($semester == 0)
            $semester = '%';
        if ($programme == 0)
            $programme = '%';
        if ($level == 0)
            $level = '%';
        if ($new_return == 0)
            $new_return = '%';
        $records = RegistrationPeriod::where('session', 'LIKE', $session)
            ->where('semester', 'LIKE', $semester)
            ->where('programme_id', 'LIKE', $programme)
            ->where('level_id', 'LIKE', $level)
            ->where('nature', 'LIKE', $nature)
            ->where('new_returning', 'LIKE', $new_return)->get();
        $msg = "";
        $i = 0;
        //$programe = Programme::find($records['programme_id']);
        foreach ($records as $record) {
            $programe = Programme::find($record['programme_id']);
            $department = $programe->department()->first();
            $faculty = $department->faculty()->first();
            $semester = ($record['semester'] == 1) ? "First Semester" : "Second Semester";
            $level = Level::find($record['level_id']) != null ? Level::find($record['level_id'])->short_name : "";
            $msg .= "<tr><td>" . (++$i) . "</td><td>" . $faculty->name . "</td><td>" . $department->name . "</td><td>" . $programe->name . "</td>";
            $msg .= "<td>" . $level . "</td><td>" . $record['session'] . "</td><td>" . $semester . "</td><td>" . $record['new_returning'] . "</td><td>" . $record['nature'] . "</td>";
            $msg .= "<td>" . $record['add_start_date'] . " </td><td>" . $record['add_end_date'] . "</td></tr>";
        }
        return $msg;
    }

    public function updateaddanddrop(Request $request)
    {
        //return $request; exit();
        try {
            $this->validate($request, [
                // "session" => "required",
                "prevsession" => "required",
                "semester" => "required",
                "programme" => "required",
                "level" => "required",
                "newreturningstudent" => "required",
                "nature" => "required",
                "addstartdate" => "required",
                "addenddate" => "required"
            ]);

            $prevsession = $request['prevsession'];
            $semester = $request['semester'] == 0 ? '%' : $request['semester'];
            $programme = $request['programmename'] == 0 ? '%' : $request['programmename'];
            $level = $request['level'] == 0 ? '%' : $request['level'];
            $returningnew = $request['newreturningstudent'] == 0 ? '%' : $request['newreturningstudent'];
            $nature = $request['nature'] == 0 ? '%' : $request['nature'];
            $astartdate = $request['addstartdate'];
            $aenddate = $request['addenddate'];


            $records = RegistrationPeriod::where('session', '=', $prevsession)
                ->where('semester', 'LIKE', $semester)
                ->where('programme_id', 'LIKE', $programme)
                ->where('level_id', 'LIKE', $level)
                ->where('new_returning', 'LIKE', $returningnew)
                ->where('nature', 'LIKE', $nature)->get();
//return $records;

            foreach ($records as $record) {

                $updaterecord = RegistrationPeriod::find($record['id']);

                $updaterecord->add_start_date = $astartdate;
                $updaterecord->add_end_date = $aenddate;
                $updaterecord->save();
            }
            return redirect()->back()->with("success", 'Record successfully updated!');
        } catch (\Exception $e) {
            return redirect()->back()->with("error", $e->getMessage() . 'All fields are Required');
        }

    }
}
