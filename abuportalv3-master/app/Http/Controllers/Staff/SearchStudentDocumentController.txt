<?php

namespace App\Http\Controllers\Staff;

use App\Http\Controllers\Controller;
use App\Models\Candidate;
use App\Models\CandidateDocument;
use App\Models\CandidateForm;
use App\Models\Student;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use App\Models\CandidateBiodata;
use App\Models\StudentBiodata;
use Illuminate\Validation\Rule;
use App\Services\ExternalFileService;
use Illuminate\Support\Facades\Log;

class SearchStudentDocumentController extends Controller
{
    protected $externalFileService;

    public function __construct()
    {
        $this->middleware('auth:staff');
        $this->externalFileService = app(ExternalFileService::class);
    }

    public function searchindex()
    {
            $studentBiodata = false;
        if ($this->access(Auth::user(), "staff.search.candidate"))
            return view('pages.staff.studentdocuments.studentdocumentlist', compact('studentBiodata'));
    }


    public function searchadmitStudentDocument(Request $request)
    {
        $request->validate([
            'registration_number' => [
                'required',
                'string',
                'min:5',
                'max:20',
            ],
        ]);
        if ($this->access(Auth::user(), "staff.search.candidate")) {
            try {
                $reg_number = $request->registration_number;

                $faculty = false;
                $department = false;
                $fullname = false;
                $programme = false;
                $studentBiodata = false;

                $student = Student::where('matric_number', '=', $reg_number)->first();

                if ($student) {
                    $candidateDoc = CandidateDocument::where('student_id', $student->id)->first();
                } else {
                    return redirect()->route("student.docs.search")->with("error", "The registration number you entered is invalid");
                }

                $user = Auth::user();

                if ($student->faculty()->name) {
                    $faculty = $student->faculty()->name;
                }

                if ($student->programme()->name) {
                    $department = $student->programme()->name;
                }

                if ($student->department()->name) {
                    $department = $student->department()->name;
                }

                if ($student->programme()->name) {
                    $programme = $student->programme()->name;
                }

                if ($student->getFullName()) {
                    $fullname = $student->getFullName();
                }

                $candidateBiodataDetails = StudentBiodata::where('student_id', $student->id)->first();

                if ($candidateBiodataDetails) {
                    $studentBiodata = $candidateBiodataDetails;
                }

                $studentid = $student->id;
                if (file_exists(public_path() . '/candidatepics/' . $studentid . '.JPG')) {
                    $url = 'candidatepics/' . $studentid . '.JPG';
                } else {
                    $url = 'studentpics/man.jpg';
                }

                $docs = [];
                $docsRes = CandidateDocument::where('student_id', $studentid)->first();

                if($docsRes) {
                    $docs = $docsRes->documents;
                }

                $totalStudMat = CandidateDocument::where('student_id', '=', $studentid)->count();
                $totalStudApp = CandidateDocument::where('candidate_id', '=', $studentid)->count();
                $filter_rec = [
                    'totalStudMat' => $totalStudMat,
                    'totalStudApp' => $totalStudApp
                    ];

                return view("pages.staff.studentdocuments.studentdocumentlist",
                    compact("student", "url", "fullname", "studentBiodata", "faculty", "department", "programme", "docs", "filter_rec"));

            } catch (\Exception $e) {
                return $e->getMessage() . $e->getTraceAsString();
            }
        }
    }

    public function removeDoc(Request $request)
    {
        $request->validate([
            'student_id' => 'required|integer',
            'type' => 'required|string',
        ]);

        $candidateDoc = CandidateDocument::where(['student_id' => $request->input('student_id')])->first();

        if (!$candidateDoc)
            return response()->json(['success' => false, 'message' => 'Document not found']);

        $docs = collect($candidateDoc->documents);

        $doc = $docs->firstWhere('type', $request->input('type'));
        if (!$doc)
            return response()->json(['success' => false, 'message' => $request->input('type') . ' not found']);

        $documentPath = $doc['document'] ?? null;
        if (!$documentPath) {
            return response()->json(['success' => false, 'message' => 'Document path missing']);
        }

        try {
            $deleted = true; // Default to true for unconfigured service
            
            // Only attempt external deletion if service is configured
            if ($this->externalFileService->isConfigured()) {
                $deleted = $this->externalFileService->delete($documentPath);
                
                if (!$deleted) {
                    Log::warning('External delete failed for student document, but proceeding with database deletion', [
                        'student_id' => $request->input('student_id'),
                        'type' => $request->input('type'),
                        'path' => $documentPath
                    ]);
                }
            } else {
                Log::info('External file service not configured, skipping external deletion', [
                    'student_id' => $request->input('student_id'),
                    'type' => $request->input('type'),
                    'path' => $documentPath
                ]);
            }

            // Remove the document from the array (always proceed even if file deletion failed)
            $updated = $docs->reject(fn($d) => $d['type'] == $request->input('type'));
            // Convert to array and update the documents column
            $candidateDoc->documents = $updated->values()->toArray();
            $candidateDoc->save();

            Log::info('Student document deleted successfully by staff', [
                'student_id' => $request->input('student_id'),
                'type' => $request->input('type'),
                'path' => $documentPath,
                'external_deleted' => $this->externalFileService->isConfigured() ? $deleted : 'not_configured'
            ]);

            return response()->json(['success' => true]);
        } catch (\Exception $e) {
            Log::error('Exception deleting student document', [
                'student_id' => $request->input('student_id'),
                'type' => $request->input('type'),
                'path' => $documentPath,
                'error' => $e->getMessage()
            ]);
            return response()->json(['success' => false, 'message' => 'Deletion error: ' . $e->getMessage()]);
        }
    }

    public function enableDocUpload(Request $request)
    {
        $request->validate([
            'student_id' => 'required|integer'
        ]);

        $student = Student::find($request->input('student_id'));
        if($student) {
            $student->enable_upload = 'Yes';
            $student->save();
        }
        return response()->json(['success' => true]);
    }

    public function disableDocUpload(Request $request)
    {
        $request->validate([
            'student_id' => 'required|integer'
        ]);

        $student = Student::find($request->input('student_id'));
        if($student) {
            $student->enable_upload = null;
            $student->save();
        }
        return response()->json(['success' => true]);
    }
}
