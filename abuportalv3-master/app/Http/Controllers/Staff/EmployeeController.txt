<?php

namespace App\Http\Controllers\Staff;

use App\Http\Controllers\Controller;
use App\Http\CuteBanker\SchoolCollection;
use App\Models\ChildToken;
use App\Models\Complex;
use App\Models\Configuration;
use App\Models\Department;
use App\Models\Employee;
use App\Models\PromotionRecomendation;
use App\Models\TokenTransaction;
use App\Models\User;
use App\Models\Rank;
use Dompdf\Dompdf;
use Exception;
use Illuminate\Contracts\Foundation\Application;
use Illuminate\Contracts\View\Factory;
use Illuminate\Contracts\View\View;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Intervention\Image\Facades\Image;
use PhpOffice\PhpWord\IOFactory;
use PhpOffice\PhpWord\PhpWord;
use PhpOffice\PhpWord\Shared\Html;
use Symfony\Component\HttpFoundation\BinaryFileResponse;

//use Intervention\Image\Image;

class EmployeeController extends Controller
{
    public function __construct()
    {
        return $this->middleware(['auth:staff']);
    }

    public function password()
    {
        try {
            $employee = Employee::find(Auth::user()->employee_id);
            return view('pages.staff.profile.changepassword', compact('employee'));
        } catch (Exception $e) {
            return back()->with('error', $e->getMessage());
        }
    }

    public function changePassword(Request $request)
    {
        try {
            $this->validate($request, [
                'new' => 'required',
                'confirm' => 'same:new'
            ]);
            if (Hash::check($request->current, Auth::user()->getAuthPassword())) {
                $pw = User::find(Auth::user()->id);
                $pw->password = Hash::make($request->new);
                $pw->save();
                return back()->with('success', 'Password changed successfully');
            } else {
                return back()->with('error', 'Invalid password. Enter current account account password');
            }
        } catch (Exception $e) {
            return back()->with('error', $e->getMessage() . ' Password mismatched');
        }
    }

    public function picture()
    {
        try {
            $employee = Employee::find(Auth::user()->employee_id);
            return view('pages.staff.profile.uploadpicture', compact('employee'));
        } catch (Exception $e) {
            return back()->with('error', $e->getMessage());
        }
    }

    public function profilePicture()
    {
        $employee = Auth::user()->employee();
        return $employee->picture();
    }

    public function addChildToken(Request $request)
    {
        $employee = Auth::user()->employee();
        $token = $request->token;
        try {
            $request = Http::get("https://dss.abu.edu.ng/api/child-token", ["token" => $token]);
            $response = $request->json();
            if ($response && $response['status'] == 1) {
                $ct = new ChildToken();
                $ct->employee_id = $employee->id;
                $ct->token = $token;
                $ct->child_name = $response['data']['name'];
                if ($ct->save()) {
                    return back()->withErrors(['status' => 1, "message" => $response['data']['message']]);
                }
            }

        } catch (Exception $e) {
            if (substr($e->getMessage(), 0, 15) == "SQLSTATE[23000]") {
                return back()->withErrors(['status' => 0, "message" => "Applicant already added, if not in your list may be to other users."]);
            }
            return back()->withErrors(['status' => 0, "message" => "failed to Connect to DSS portal."]);
        }


        return back()->withErrors(['status' => 0, "message" => "Oops something went wrong."]);
    }

    public function changePicture(Request $request)
    {
//        return $request->getClientOriginalName();//file('file');
        try {

            $this->validate($request, [
                'file' => 'required|image|mimes:jpg|max:1024'
            ]);
            $originalImage = $request->file('file');
            $thumbnailImage = Image::make($originalImage);
            $originalPath = public_path() . '/images/staff/';
            $thumbnailImage->save($originalPath . time() . $originalImage->getClientOriginalName());

            $file = $request->file('file');
            $fileName = str_replace("/", "_", strtoupper(Auth::user()->username)) . ".jpg";
            $file->move(public_path('images/staff/'), $fileName);
            //Image::make($request->file('file')->getRealPath());

            return redirect()->back();
        } catch (Exception $e) {
            return back()->with('error', $e->getMessage());
        }

    }


    /**
     * @param Employee $employee
     * @return Employee|BinaryFileResponse
     * @throws \PhpOffice\PhpWord\Exception\Exception
     */

    public function generateCVInPdfDocument(Employee $employee)
    {
//        return view('pages.staff.profile.generatepdfcv', compact('employee'));
// instantiate and use the dompdf class
        $dompdf = new Dompdf();
        $dompdf->loadHtml(view('pages.staff.profile.generatepdfcv', compact('employee')));

// (Optional) Setup the paper size and orientation
        $dompdf->setPaper('A4');

// Render the HTML as PDF
        $dompdf->render();

// Output the generated PDF to Browser
        $dompdf->stream();
    }

    public function generateCVInHtmlDocument(Employee $employee)
    {
        try {
            $orderedQtn = $employee->orderedQualification();
            return view('pages.staff.profile.generatehtmlcv', compact('employee', 'orderedQtn'));
        } catch (Exception $e) {
            return back()->with('error', $e->getMessage());
        }
    }

    public function generateCVInWordDocument(Employee $employee)
    {

//        return $employee;

        $phpWord = new PhpWord();
        $phpWord->addParagraphStyle('Heading2', array('alignment' => 'center'));

        $titleFontSize = 'font-weight: bold; font-size:20px;';
        $tablewidth = "100%";
        $tablewidth = "100%";

        $section = $phpWord->addSection();
        $section->addImage('./images/staff/p17734.jpg', array(
            'width' => 100,
            'height' => 100,
            'marginTop' => -1,
            'marginLeft' => -1,
            'wrappingStyle' => 'behind',
            'align' => 'center'
        ));

        $biodata = '<h1 style="text-align:center; font-weight: bold; font-size:28px;">' . $employee->title . ' ' . $employee->surname . ', ' . $employee->firstname . ' ' . $employee->othernames . '</h1>';
        $biodata .= '<table align="center" style="width: 100%; border: 6px #000000 solid;">
                <tbody>
                    <tr><th style="width:300px;">Personnel No.:</th><td>' . $employee->personnel_no . '</td></tr>
                    <tr><th style="width:300px;">IPPIS No.:</th><td>' . $employee->ippis_no . '</td></tr>
                </tbody>
            </table>';


        Html::addHtml($section, $biodata, false, false);


        $section->addTextBreak(3);
        $contactInformation = '<h1 style="' . $titleFontSize . '">Contact Information</h1>';
        $contactInformation .= '<table align="center" style="width: 100%; border: 6px #000000 solid;">
                <thead>
                    <tr style="text-align: center; color: #000000; font-weight: bold; ">
                        <th style="width: 50pt">header a</th>
                        <th style="width: 50pt">header b</th>
                        <th style="">header</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>';
        Html::addHtml($section, $contactInformation, false, false);

        $section->addTextBreak(3);
        $languageSpoken = '<h1 style="' . $titleFontSize . '">Language Spoken</h1>';
        $languageSpoken .= '<table align="center" style="width: 100%; border: 6px #000000 solid;">
                <thead>
                    <tr style="text-align: center; color: #000000; font-weight: bold; ">
                        <th style="width: 50pt">header a</th>
                        <th style="width: 50pt">header b</th>
                        <th style="">header</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>';
        Html::addHtml($section, $languageSpoken, false, false);


        $objWriter = IOFactory::createWriter($phpWord, 'Word2007');
        $objWriter->save('cv/' . $employee->personnel_no . '.docx');
        return response()->download(public_path('cv/' . $employee->personnel_no . '.docx'));
    }


    /**
     * Find employee by personnel number
     */
    public function findByPersonnelNumber(Request $request)
    {
        try {
            $personnelNo = $request->get('personnel_no');

            if (!$personnelNo) {
                return response()->json(['success' => false, 'message' => 'Personnel number is required'], 400);
            }

            $employee = Employee::where('personnel_no', $personnelNo)->first();

            if (!$employee) {
                return response()->json(['success' => false, 'message' => 'Employee not found'], 404);
            }

            return response()->json([
                'success' => true,
                'employee_id' => $employee->id,
                'personnel_no' => $employee->personnel_no,
                'name' => $employee->title . ' ' . $employee->surname . ', ' . $employee->firstname . ' ' . $employee->othernames
            ]);

        } catch (\Exception $e) {
            Log::error('Error finding employee by personnel number:', [
                'personnel_no' => $request->get('personnel_no'),
                'error' => $e->getMessage()
            ]);
            return response()->json(['success' => false, 'message' => 'Error finding employee'.$e->getMessage()], 500);
        }
    }

    public function myWallet(Request $request)
    {
        $user = Auth::user();
        $schl = new SchoolCollection();
        $meters = TokenTransaction::where(['user_id' => $user->id])->pluck('meter_number');
        $balance = $schl->balance($user->wallet_number);
        return view("pages.staff.profile.my_wallet", compact('balance', 'meters'));

    }

    public function createWallet(Request $request)
    {
        try {

            $staff = Auth::user();
            if ($staff->wallet_number) {
                return response()->json(["status" => 0, "message" => "Already have an account."]);
            }
            $schoolCollect = new SchoolCollection();
            $responseCode = $schoolCollect->createStaffAccount($staff->id, $request->pin);
            return response()->json(["status" => $responseCode == 1, "message" => ($responseCode == 1 ? "Account creation successful" : "Account creation failed.")], 200);

        } catch (Exception $exception) {
            return response(['message' => $exception->getMessage()]);
        }
    }

    public function myStaff(Request $request, $year = 2025)
    {
        $user = Auth::user();
        $year = 2025;
        $deptIds = $user->isHod();
        $staffIds = Employee::whereIn('department_id', $deptIds)->pluck('id');
        $staff = Employee::join('departments', 'employees.department_id', '=', 'departments.id')
            ->join('faculties', 'departments.faculty_id', '=', 'faculties.id')
            ->join('complexes', 'faculties.complex_id', '=', 'complexes.id')
            ->join('ranks', 'employees.rank_id', '=', 'ranks.id')
            ->join('salary_grade_levels', 'employees.salary_grade_level_id', '=', 'salary_grade_levels.id')
            ->leftJoin('employee_supervisions', 'employees.id', '=', 'employee_supervisions.employee_id')
            ->whereIn('employees.id', $staffIds)
            ->where('employees.status','Active')
            ->select('employees.id AS employee_id', 'employees.title', 'personnel_no',
            DB::raw("CONCAT(surname,', ',firstname,' ',IFNULL(othernames, ''))  AS fullname"),
            'date_of_first_appointment'
                , 'date_of_confirmation', 'date_of_last_promotion', 'ranks.name AS rank',
                'salary_grade_levels.grade'
                , 'departments.name AS department', "departments.id as department_id",
                "faculties.id as faculty_id", "complexes.id as complex_id",
                DB::raw("COUNT(employee_supervisions.id) as supervisions"))
            ->groupBy("employees.id")
            ->get();
        PromotionRecomendation::populatePromotionRecomendation($staff, $year);
        $staffs = PromotionRecomendation::where('year', $year)->whereIn('department_id', $deptIds)->get();
        return view('pages.staff.promotion.get_unit_summary', compact('staffs', 'user', 'year'));
    }

    public function allStaff(Request $request, $year = 2025)
    {
        $user = Auth::user();
        $staff = Employee::join('departments', 'employees.department_id', '=', 'departments.id')
            ->join('faculties', 'departments.faculty_id', '=', 'faculties.id')
            ->Join('complexes', 'faculties.complex_id', '=', 'complexes.id')
            ->Join('ranks', 'employees.rank_id', '=', 'ranks.id')
            ->Join('salary_grade_levels', 'employees.salary_grade_level_id', '=', 'salary_grade_levels.id')
            ->leftJoin('employee_supervisions', 'employees.id', '=', 'employee_supervisions.employee_id')
//            ->whereIn('employees.id',$user->accessibleEmployees())
            ->where('employees.status','Active')
            ->select('employees.id AS employee_id', 'employees.title', 'personnel_no', DB::raw("CONCAT(surname,', ',firstname,' ',IFNULL(othernames, ''))  AS fullname"), 'date_of_first_appointment'
                , 'date_of_confirmation', 'date_of_last_promotion', 'ranks.name AS rank', 'salary_grade_levels.grade'
                , 'departments.name AS department', "departments.id as department_id", "faculties.id as faculty_id", "complexes.id as complex_id", DB::raw("COUNT(employee_supervisions.id) as supervisions"))
            ->groupBy("employees.id")
            ->get();
        PromotionRecomendation::populatePromotionRecomendation($staff, $year);
        $staffs = PromotionRecomendation::where('year', $year)
//            ->whereIn('department_id', $user->accessibleDepartment())
            ->get();
        return view('pages.staff.promotion.get_summary', compact('staffs', 'user', 'year'));
    }

    public function promotion(Request $request)
    {
        $user = Auth::user();
        $years = range(2025, date("Y"));
        $employeeStats = PromotionRecomendation::select([DB::raw("COUNT(id) as counter"), DB::raw("year AS yearx")])
            ->groupBy('year')->whereIn("year", $years)->whereIn('department_id', $user->accessibleDepartment())->get();
        return view("pages.staff.promotion.index", compact('employeeStats'));
    }

    public function report(Request $request)
    {
        $user = Auth::user();
        $years = range(2025, date("Y"));
        $employeeStats = PromotionRecomendation::select([DB::raw("COUNT(id) as counter"), DB::raw("year AS yearx")])
            ->groupBy('year')
            ->whereIn("year", $years)
//            ->whereIn('department_id',$user->accessibleDepartment())
            ->get();
        return view("pages.staff.promotion.index", compact('employeeStats'));
    }


    public function reportProm(Request $request)
    {
        $complexes = Complex::all();
        return view("pages.staff.promotion.report", compact('complexes'));
    }

    public function reportData()
    {

    }

    public function addRecomendation(Request $request)
    {
        $user = Auth::user();
        $proRec = PromotionRecomendation::find($request->recommendation_id);
        $type = "recommend" . $request->type;
        $proRec->$type($request);
        return back();

    }

    public function getPromotionRec(Request $request)
    {
        $students = array();
        if ($request->ajax()) {
            $year = $request->query->get('year');
            $complex = $request->query->get('complex');
            $facultyid = $request->query->get('faculty');
            $departmentid = $request->query->get('department');
            $unit_status = $request->query->get('unit_status');

            if ($facultyid != '%') {
                $arropts[] = ["faculty_id", "=", $facultyid];
            }
            if ($departmentid != '%') {
                $arropts[] = ["department_id", "=", $departmentid];
            }

            $students = DB::table("students")
                ->join("student_biodatas", "student_biodatas.student_id", "=", "students.id")
                ->join("session_regs", "students.id", "=", "session_regs.student_id")
                ->leftjoin("programmes", "students.programme_id", "=", "programmes.id")
                ->leftjoin("programme_types", "programmes.programme_type_id", "=", "programme_types.id")
                ->leftjoin("departments", "programmes.department_id", "=", "departments.id")
                ->leftjoin("faculties", "departments.faculty_id", "=", "faculties.id")
                ->leftjoin("countries", "students.country_id", "=", "countries.id")
                ->leftJoin("lgas", "students.lga_id", "=", "lgas.id")
                ->leftJoin("states", "lgas.state_id", "=", "states.id")
                ->leftJoin("levels", "levels.id", "=", "session_regs.level_id")
                ->select(["students.matric_number", DB::raw("CONCAT(surname,', ',firstname,' ',IFNULL(other_names, ''))  AS fullname"), "gender", "countries.nicename as country", "states.name as state", "lgas.name as lga",
                    "session_regs.session", "programmes.name AS programme", "departments.name AS department", "faculties.name AS faculty", "session_regs.level_id"])
                ->where($arropts)
                ->orderBy("faculties.name")->orderBy("departments.name")->orderBy("programme_types.prog_type_name")->orderBy("programmes.name")->orderBy("states.name")->orderBy("lgas.name")->orderBy("surname")
                ->get();

            return view('pages.staff.reports.students.load_general_data', compact('students'))->render();
        }

        return view('pages.staff.reports.students.general', compact('students'));

    }

    public function myStaffDean(Request $request, $year = 2025)
    {
        $user = Auth::user();
        $year = 2025;
        $deptIds = $user->isDean();
        $staffIds = Employee::whereIn('department_id', $deptIds)->pluck('id');
        $staff = Employee::join('departments', 'employees.department_id', '=', 'departments.id')
            ->join('faculties', 'departments.faculty_id', '=', 'faculties.id')
            ->join('complexes', 'faculties.complex_id', '=', 'complexes.id')
            ->join('ranks', 'employees.rank_id', '=', 'ranks.id')
            ->join('salary_grade_levels', 'employees.salary_grade_level_id', '=', 'salary_grade_levels.id')
            ->leftJoin('employee_supervisions', 'employees.id', '=', 'employee_supervisions.employee_id')
            ->whereIn('employees.id', $staffIds)
            ->select('employees.id AS employee_id', 'employees.title', 'personnel_no', DB::raw("CONCAT(surname,', ',firstname,' ',IFNULL(othernames, ''))  AS fullname"), 'date_of_first_appointment'
                , 'date_of_confirmation', 'date_of_last_promotion', 'ranks.name AS rank', 'salary_grade_levels.grade'
                , 'departments.name AS department', "departments.id as department_id", "faculties.id as faculty_id", "complexes.id as complex_id", DB::raw("COUNT(employee_supervisions.id) as supervisions"))
            ->groupBy("employees.id")
            ->get();
        // PromotionRecomendation::populatePromotionRecomendation($staff, $year);
        $staffs = PromotionRecomendation::where('year', $year)->whereIn('department_id', $deptIds)->get();
        return view('pages.staff.promotion.get_dean_summary', compact('staffs', 'user', 'year'));
    }

    public function myStaffComplex(Request $request, $year = 2025)
    {
        $user = Auth::user();
        $year = 2025;
        $compIds = $user->isComplexChairman();
        $staffIds = Employee::whereIn('department_id', $compIds)->pluck('id');
        $staff = Employee::join('departments', 'employees.department_id', '=', 'departments.id')
            ->join('faculties', 'departments.faculty_id', '=', 'faculties.id')
            ->join('complexes', 'faculties.complex_id', '=', 'complexes.id')
            ->join('ranks', 'employees.rank_id', '=', 'ranks.id')
            ->join('salary_grade_levels', 'employees.salary_grade_level_id', '=', 'salary_grade_levels.id')
            ->leftJoin('employee_supervisions', 'employees.id', '=', 'employee_supervisions.employee_id')
            ->whereIn('employees.id', $staffIds)
            ->select('employees.id AS employee_id', 'employees.title', 'personnel_no', DB::raw("CONCAT(surname,', ',firstname,' ',IFNULL(othernames, ''))  AS fullname"), 'date_of_first_appointment'
                , 'date_of_confirmation', 'date_of_last_promotion', 'ranks.name AS rank', 'salary_grade_levels.grade'
                , 'departments.name AS department', "departments.id as department_id", "faculties.id as faculty_id", "complexes.id as complex_id", DB::raw("COUNT(employee_supervisions.id) as supervisions"))
            ->groupBy("employees.id")
            ->get();
        // PromotionRecomendation::populatePromotionRecomendation($staff, $year);
        $staffs = PromotionRecomendation::where('year', $year)->whereIn('department_id', $compIds)->get();
        return view('pages.staff.promotion.complex', compact('staffs', 'user', 'year'));
    }

    public function myPromotions()
    {
        $user = Auth::user();
        $promotions = PromotionRecomendation::select(['id', 'year', 'council_approval'])
            ->where(['personnel_no' => $user->username, 'central_apc_recommendation' => 'Recommended'])
            ->whereIn('council_approval', ['Approved', 'Withdrawn'])
            ->orderBy('year', 'desc')
            ->get();

        return view('pages.staff.mypromotions.index', compact('promotions'));
    }

    public function myPromotion(PromotionRecomendation $promotionRecomendation)
    {
        $promotion = $promotionRecomendation;

        // Check if this is a withdrawn promotion
        if ($promotion->council_approval === 'Withdrawn') {
            return view('pages.staff.mypromotions.withdrawal', compact('promotion'));
        }

        // Regular approved promotion
        $config = Configuration::where(['unit_id' => 1, 'name' => 'PRL', 'status' => 'Active'])
            ->whereYear('effective_date', '>=', $promotion->year)
            ->orderBy("id", "DESC")
            ->first();

        return view('pages.staff.mypromotions.view', compact('promotion', 'config'));
    }

    public function council()
    {
        $complexes = Complex::all();
        $ranks = Rank::orderBy('gradelevel', 'ASC')->orderBy('name', 'ASC')->get();
        $groupedByGradeLevel = $ranks->groupBy('gradelevel');
        return view('pages.staff.promotion.council', compact('complexes', 'groupedByGradeLevel'));
    }

    public function centralApc()
    {
        $complexes = Complex::all();
        $ranks = Rank::orderBy('gradelevel', 'ASC')->orderBy('name', 'ASC')->get();
        $groupedByGradeLevel = $ranks->groupBy('gradelevel');
        return view('pages.staff.promotion.central_apc', compact('complexes', 'groupedByGradeLevel'));
    }

    public function centralApcPost(Request $request)
    {
        // return $request;
        $recomm = PromotionRecomendation::find($request->_id);
        $recomm->dofapt = $request->dofapt;
        $recomm->doc = $request->doc;
        $recomm->dolp = $request->dolp;
        // $recomm->rank_on_empl_id = $request->rank_on_empl_id;
        if ($request->central_apc_recommendation == "Recommended") {
            $recomm->central_apc_recommendation = $request->central_apc_recommendation;
            $recomm->apc_step = $request->apc_step;
            $recomm->apc_rank_id = $request->apc_rank_id;
            $recomm->apc_grade_id = $request->apc_grade_id;
        }
        if ($recomm->save()) {
            // return $recomm;
            $employee = Employee::find($recomm->employee_id);
            if ($employee->data_lock) {
                $lock = json_decode($employee->data_lock);
                $lock = ['lock' => ['dofapt' => 1, 'doc' => 1, 'dolp' => 1, 'rank_on_empl_id' => 1]];
            } else {
                $lock = ['lock' => ['dofapt' => 1, 'doc' => 1, 'dolp' => 1, 'rank_on_empl_id' => 1]];
            }
            $employee->data_lock = json_encode($lock);
            $employee->save();
        }


        return ['success' => 1];
    }

    public function
    updateComplexStatus(Request $request)
    {
        if (!empty($request->staff_ids)) {
            PromotionRecomendation::whereIn('id', $request->staff_ids)
                ->where('faculty_status', 'Recommended')
                ->update(['complex_status' => 'Recommended']);

            return response()->json(['success' => true]);
        }

        return response()->json(['success' => false]);
    }

    public function promotionRec(Request $request)
    {
//        return $request;

        $complexes = Complex::all();
        $type = $request->type ? "council" : "complex";
        $staffs = array();
        if ($request->year) {
            $year = $request->query->get('year');
            $complex = $request->query->get('complex');
            $facultyid = $request->query->get('faculty');
            $departmentid = $request->query->get('department');
            $complex_status = $request->query->get('recommendation');
            $arropts = [
                ["year", "=", $year],
                // ["complex_id", "=", $complex],
                [($type == "council" ? "central_apc_recommendation" : "complex_status"), "=", $complex_status]
            ];

            // For council approval, only show recommendations that have been verified as "Approved"
            if ($type == "council") {
                $arropts[] = ["verification_status", "=", "Approved"];
            }

            if ($complex != '%') {
                $arropts[] = ["complex_id", "=", $complex];
            }
            if ($facultyid != '%') {
                $arropts[] = ["faculty_id", "=", $facultyid];
            }
            if ($departmentid != '%') {
                $arropts[] = ["department_id", "=", $departmentid];
            }
            // return $arropts;
            $staffs = PromotionRecomendation::where($arropts)->get();

            return view('pages.staff.promotion.load_apc_data', compact('staffs', 'complexes', 'type'))->render();
        }

        return view('pages.staff.promotion.central_apc', compact('staffs', 'complexes'));

    }

    public function promotionReport(Request $request)
    {
        //    return $request;

        $complex = Complex::find($request->query->get('complex'));
        $staffs = array();
        if ($request->year) {
            $year = $request->query->get('year');
            $complex_ = $request->query->get('complex');
            $facultyid = $request->query->get('faculty');
            $departmentid = $request->query->get('department');
            $complex_status = $request->query->get('recommendation');
            $arropts = [
                ["year", "=", $year],
                // ["complex_id", "=", $complex],
                ["complex_status", "=", $complex_status]
            ];
            if ($complex_ != '%') {
                $arropts[] = ["complex_id", "=", $complex_];
            }
            if ($facultyid != '%') {
                $arropts[] = ["faculty_id", "=", $facultyid];
            }
            if ($departmentid != '%') {
                $arropts[] = ["department_id", "=", $departmentid];
            }
            // return $arropts;
            $staffs = PromotionRecomendation::where($arropts)->pluck('employee_id');
            $employees = Employee::whereIn('id', $staffs)->get();


            return view('pages.staff.promotion.reportdata', compact('employees', 'complex', 'year'))->render();
        }

        return view('pages.staff.promotion.central_apc', compact('staffs', 'complexes'));

    }

    public function councilPost(Request $request)
    {

        $prom = PromotionRecomendation::find($request->__id);
        $prom->council_approval = $request->__approval;
        $prom->save();

        return ['success' => 1];
    }

    public function showSearchUnitForm()
    {
        $complexes = Complex::all();
        $years = $this->getYears();
        return view('pages.staff.promotion.get_unit_promotion_report', compact('complexes', 'years'));
    }

    public function searchUnitPromotions(Request $request)
    {
        try {
            //        $results = array();
            if ($request->ajax()) {
                $complexid = $request->query->get('complex');
                $facultyid = $request->query->get('faculty');
                $departmentid = $request->query->get('department');
                $unitstatus = $request->query->get('unitstatus');
                $year = $request->query->get('year');

                $arropts = [
                    ["promotion_recomendations.unit_status", "=", $unitstatus],
                    ["promotion_recomendations.year", "=", $year]
                ];

                if ($complexid != '%') {
                    $arropts[] = ["complexes.id", "=", $complexid];
                }
                if ($facultyid != '%') {
                    $arropts[] = ["faculties.id", "=", $facultyid];
                }
                if ($departmentid != '%') {
                    $arropts[] = ["departments.id", "=", $departmentid];
                }
                // return $arropts;
                $results = DB::table("promotion_recomendations")
                    ->leftjoin("complexes", "promotion_recomendations.complex_id", "=", "complexes.id")
                    ->leftjoin("departments", "promotion_recomendations.department_id", "=", "departments.id")
                    ->leftjoin("faculties", "departments.faculty_id", "=", "faculties.id")
                    ->select(["promotion_recomendations.id",
                        "promotion_recomendations.personnel_no",
                        "promotion_recomendations.name",
                        "promotion_recomendations.complex_id",
                        "promotion_recomendations.complex_name",
                        "promotion_recomendations.faculty_id",
                        "promotion_recomendations.faculty_name",
                        "promotion_recomendations.department_id",
                        "promotion_recomendations.department_name",
                        "promotion_recomendations.unit_status",
                        "promotion_recomendations.present_salary_step",
                        "promotion_recomendations.unit_recommendation",
                        "promotion_recomendations.recommended_rank",
                        "promotion_recomendations.year"
                    ])
                    ->where($arropts)
                    ->orderBy("faculties.name")
                    //->toSql();
                    ->get();
                //echo $results;
                return view('pages.staff.promotion.load_unit_remarkdata', compact('results'));
            }

        } catch (Exception $e) {
            Log::error('Error in searchUnitPromotions: ' . $e->getMessage());
            return response()->json(['error' => 'Something went wrong.'], 500);
        }
    }

    private function getYears()
    {
        $currentYear = date('Y');
        return range($currentYear - 2, $currentYear + 2);
    }

    public function updateDeaneryStatus(Request $request)
    {
//        return $request;
        try {
            if (!empty($request->staff_ids)) {
                PromotionRecomendation::whereIn('id', $request->staff_ids)
                    ->where('unit_status', 'Recommended')
                    ->update(['faculty_status' => 'Recommended']);
                return response()->json(['success' => true]);
            }
            return response()->json(['success' => false]);
        } catch (Exception $e) {
            return $e->getMessage() . $e->getTraceAsString();
        }
    }

    public function updateApcStatus(Request $request)
    {
        if (!empty($request->staff_ids)) {
            PromotionRecomendation::whereIn('id', $request->staff_ids)
                ->where('complex_status', 'Recommended')
                ->update(['central_apc_recommendation' => 'Recommended']);
            return response()->json(['success' => true]);
        }
        return response()->json(['success' => false]);
    }

    public function updateCouncilApproval(Request $request)
    {
        if (!empty($request->staff_ids)) {
            PromotionRecomendation::whereIn('id', $request->staff_ids)
                ->where('central_apc_recommendation', 'Recommended')
                ->where('verification_status', 'Approved') // Only approve verified recommendations
                ->update(['council_approval' => 'Approved']);
            return response()->json(['success' => true]);
        }
        return response()->json(['success' => false]);
    }

    public function showSearchFacultyForm()
    {
        $complexes = Complex::all();
        $years = $this->getYears();
        return view('pages.staff.promotion.get_faculty_promotion_report', compact('complexes', 'years'));
    }

//    public function searchFacultyPromotions(Request $request)
//    {
//        try {
//            //        $results = array();
//            if ($request->ajax()) {
//                $complexid = $request->query->get('complex');
//                $facultyid = $request->query->get('faculty');
//                $departmentid = $request->query->get('department');
//                $facstatus = $request->query->get('facultystatus');
//                $year = $request->query->get('year');
//
//                $arropts = [
//                    ["promotion_recomendations.faculty_status", "=", $facstatus],
//                    ["promotion_recomendations.year", "=", $year]
//                ];
//
//                if ($complexid != '%') {
//                    $arropts[] = ["complexes.id", "=", $complexid];
//                }
//                if ($facultyid != '%') {
//                    $arropts[] = ["faculties.id", "=", $facultyid];
//                }
//                if ($departmentid != '%') {
//                    $arropts[] = ["departments.id", "=", $departmentid];
//                }
//                // return $arropts;
//                $results = DB::table("promotion_recomendations")
//                    ->leftjoin("complexes", "promotion_recomendations.complex_id", "=", "complexes.id")
//                    ->leftjoin("departments", "promotion_recomendations.department_id", "=", "departments.id")
//                    ->leftjoin("faculties", "departments.faculty_id", "=", "faculties.id")
//                    ->select(["promotion_recomendations.id",
//                        "promotion_recomendations.personnel_no",
//                        "promotion_recomendations.name",
//                        "promotion_recomendations.complex_id",
//                        "promotion_recomendations.complex_name",
//                        "promotion_recomendations.faculty_id",
//                        "promotion_recomendations.faculty_name",
//                        "promotion_recomendations.department_id",
//                        "promotion_recomendations.department_name",
//                        "promotion_recomendations.unit_status",
//                        "promotion_recomendations.present_salary_step",
//                        "promotion_recomendations.unit_recommendation",
//                        "promotion_recomendations.recommended_rank",
//                        "promotion_recomendations.year",
//                        "promotion_recomendations.faculty_status",
//                        "promotion_recomendations.faculty_recommendation",
//                    ])
//                    ->where($arropts)
//                    ->orderBy("faculties.name")
//                    //->toSql();
//                    ->get();
//                //echo $results;
//                return view('pages.staff.promotion.load_faculty_remarkdata', compact('results'));
//            }
//
//        } catch (Exception $e) {
//            Log::error('Error in searchUnitPromotions: ' . $e->getMessage());
//            return response()->json(['error' => 'Something went wrong.'], 500);
//        }
//    }

    public function searchFacultyPromotions(Request $request)
    {
        try {
            $complexId     = $request->query('complex');
            $facultyId     = $request->query('faculty');
            $departmentId  = $request->query('department');
            $facultyStatus = $request->query('facultystatus');
            $year          = $request->query('year');

            $conditions = [];

            // Apply filters only if not "All" (%)
            if ($facultyStatus !== '%' && $facultyStatus !== null) {
                $conditions[] = ['promotion_recomendations.faculty_status', '=', $facultyStatus];
            }

            if ($year !== '%' && $year !== null) {
                $conditions[] = ['promotion_recomendations.year', '=', $year];
            }

            if ($complexId !== '%' && $complexId !== null) {
                $conditions[] = ['complexes.id', '=', $complexId];
            }

            if ($facultyId !== '%' && $facultyId !== null) {
                $conditions[] = ['faculties.id', '=', $facultyId];
            }

            if ($departmentId !== '%' && $departmentId !== null) {
                $conditions[] = ['departments.id', '=', $departmentId];
            }

            $results = DB::table('promotion_recomendations')
                ->leftJoin('complexes', 'promotion_recomendations.complex_id', '=', 'complexes.id')
                ->leftJoin('departments', 'promotion_recomendations.department_id', '=', 'departments.id')
                ->leftJoin('faculties', 'departments.faculty_id', '=', 'faculties.id')
                ->select([
                    'promotion_recomendations.id',
                    'promotion_recomendations.personnel_no',
                    'promotion_recomendations.name',
                    'complexes.name as complex_name',
                    'faculties.name as faculty_name',
                    'departments.name as department_name',
                    'promotion_recomendations.unit_status',
                    'promotion_recomendations.present_salary_step',
                    'promotion_recomendations.unit_recommendation',
                    'promotion_recomendations.recommended_rank',
                    'promotion_recomendations.year',
                    'promotion_recomendations.faculty_status',
                    'promotion_recomendations.faculty_recommendation',
                ])
                ->where($conditions)
                ->orderBy('faculties.name')
                ->get();

            return view('pages.staff.promotion.load_faculty_remarkdata', compact('results'));

        } catch (\Throwable $e) {
            Log::error('Error in searchUnitPromotions: ' . $e->getMessage());
            return response()->json(['error' => 'Something went wrong.'], 500);
        }
    }


    public function promotedReport(): Factory|View|Application
    {
        if (!$this->access(Auth::user(), 'promotion.promoted.report'))
            return view("pages.errors.nopermission");

        $years = range(2025, date("Y"));
        $complexes = Complex::orderBy('name')->get();
        return view('pages.staff.promotion.promoted_report', compact('complexes', 'years'));
    }

    public function searchPromotedReport(Request $request): Factory|View|Application
    {
        $complex = $request->complex;
        $faculty = $request->faculty;
        $department = $request->department;
        $year = $request->year;

        $whereOptions = [
           // ["promotion_recomendations.council_approval", "=", 'Approved'],
            ["promotion_recomendations.year", "=", $year]
        ];

        if ($complex != '%') {
            $whereOptions[] = ["complexes.id", "=", $complex];
        }
        if ($faculty != '%') {
            $whereOptions[] = ["faculties.id", "=", $faculty];
        }
        if ($department != '%') {
            $whereOptions[] = ["departments.id", "=", $department];
        }

        $results = DB::table("promotion_recomendations")
            ->leftjoin("complexes", "promotion_recomendations.complex_id", "=", "complexes.id")
            ->leftjoin("departments", "promotion_recomendations.department_id", "=", "departments.id")
            ->leftjoin("faculties", "departments.faculty_id", "=", "faculties.id")
            ->select(["promotion_recomendations.id",
                "promotion_recomendations.personnel_no",
                "promotion_recomendations.name",
                "promotion_recomendations.complex_id",
                "promotion_recomendations.complex_name",
                "promotion_recomendations.faculty_id",
                "promotion_recomendations.faculty_name",
                "promotion_recomendations.department_id",
                "promotion_recomendations.department_name",
                "promotion_recomendations.unit_status",
                "promotion_recomendations.present_salary_step",
                "promotion_recomendations.unit_recommendation",
                "promotion_recomendations.recommended_rank",
                "promotion_recomendations.year",
                "promotion_recomendations.faculty_status",
                "promotion_recomendations.faculty_recommendation",
            ])
            ->where($whereOptions)
            ->orderBy("faculties.name")
            ->get();

        return view('pages.staff.promotion.load_promoted_report', compact('results'));
    }


}
