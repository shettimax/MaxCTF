<?php

namespace App\Http\Controllers\Staff;

use App\Models\Complex;
use App\Models\Employee;
use App\Models\EmployeeQualification;
use App\Models\EmployeeSupervision;
use App\Models\Faculty;
use App\Http\Controllers\Controller;
use App\Models\PromotionRecomendation;
use App\Models\Rank;
use App\Models\SalaryGradeLevel;
use App\Models\EmployeePublication;
use App\Models\Supervision;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class EmployeeQualificationController extends Controller
{
    public function __construct()
    {
        $this->middleware(["auth:staff"]);
    }
    public function index(){
        try{
            $employee = Employee::find(Auth::user()->employee_id);
            return view("pages.staff.profile.qualification", compact("employee"));
        }catch (\Exception $e){
            return redirect()->back()->with("error", $e->getMessage());
        }
    }

    public function storeQualification(Request $request){
        try{
            $this->validate($request,[
                'institution'=>'required',
                'course'=>'required',
                'category'=>'required',
            ]);
            $qualification = EmployeeQualification::find($request->qualification_id);
            if(!$qualification)
                $qualification = new EmployeeQualification();
            $qualification->employee_id = $request->employee_id;
            $qualification->category = $request->category;
            $qualification->institution = $request->institution;
            $qualification->course = $request->course;
            $qualification->type = $request->type;
            $qualification->grade_id = $request->grade;
            $qualification->date = $request->date;
            $qualification->save();
            return redirect()->back()->with('success', 'Done!');
        }catch(\Exception $e){
            return redirect()->back()->with('error', $e->getMessage());
        }

    }

    public function deleteQualification(EmployeeQualification $employeeQualification){
        try{
            EmployeeQualification::destroy($employeeQualification->id);
            return redirect()->back()->with('success', 'Done!');
        }catch (\Exception $e){
            return redirect()->back()->with('error', $e->getMessage());
        }
    }

    public function summary()
    {

        $employee = Employee::find(Auth::user()->employee_id);
        $dept = $employee->department;
        $fac = $dept->faculty();
        $complex = $fac->complex();
        $dean = $fac->deanName();
        $cch = $complex?$complex->chairmanName():"";

        $years =  PromotionRecomendation::select('unit_recommendation', 'complex_status', 'year')
            ->where('employee_id', $employee->id)
            ->pluck('year');
        return view("pages.staff.profile.summary", compact("employee",'dean','cch','years'));
    }


    public function summaryPost(Request $request)
    {
//        return $request;
        $user = Auth::user();
        $employee = Employee::find(Auth::user()->employee_id);
        $dept = $employee->department;
        $fac = $dept->faculty();
        $complex = $fac->complex();
        $dean = $fac->deanName();
        $cch = $complex?$complex->chairmanName():"";
        $year = $request->year;
        $dofp = $employee->date_of_first_appointment;//Carbon::parse($request->dofp)->format('jS F Y');
        $dolp= $employee->date_of_last_promotion;//Carbon::parse($request->dolp)->format('jS M, Y');
        $dofc= $employee->date_of_confirmation;//Carbon::parse($request->dofc)->format('jS F Y');
        $dord= $employee->date_of_redesignation;//Carbon::parse($request->dofc)->format('jS F Y');
        //$yearOfLastPromotion = $employee->date_of_last_promotion->format('Y');
        $nop = $request->nop;
        $rankonapp = Rank::find($employee->rank_on_employment)->name;
        $presentrank = Rank::find($employee->rank_id)->name;
        $presentsalary = SalaryGradeLevel::find($employee->salary_grade_level_id)->grade;
        $req = 1998;//explode(',',$request->req);
//        $att = explode(',',$request->att);
////        $sup = $request->sup;
        $title = $employee->title;
//        $dean = $request->dean;
        $department = $employee->department;
        $faculty = Faculty::find($department->faculty_id);
//        $complex = Complex::find($faculty->complex_id);
        $complex = $request->complex_chair;
        $pno = strtolower($employee->personnel_no);
        $indexOfP = strpos($pno,"p");

        $publications = EmployeePublication::selectRaw('type, COUNT(employee_id) as count')
            ->where(['employee_id'=>$employee->id])
            ->groupBy('type')
            ->get();

        $publications_after_promotion = EmployeePublication::selectRaw('type, COUNT(employee_id) as count')
            ->where('employee_id', $employee->id)
            ->where('date', '>', $dolp)
            ->groupBy('type')
            ->get();

        $supervisions = EmployeeSupervision::selectRaw('year, COUNT(employee_id) as count')
            ->where(['employee_id'=>$employee->id])
            ->groupBy('year')
            ->get();

        $complexStatus =  PromotionRecomendation::select('unit_recommendation', 'complex_status','recommended_rank_id')
            ->where('employee_id', $employee->id)
            ->where('year', $year)
            ->first();
        $recommendedRank = Rank::find($complexStatus->recommended_rank_id);
        // if($complexStatus->employee_id==11195){
        //     return $complexStatus;
        // }
// Create a formatted output string
//        $output = "";
//        foreach ($publications as $publication) {
//            $output .= "{$publication->type} {$publication->count}(" . \Illuminate\Support\Str::plural('employee', $publication->count) . ")" . PHP_EOL;
//        }
//
//// Output the result
//        echo $output;

        $qualifications = EmployeeQualification::join("qualifications","qualifications.id","=","employee_qualifications.type")
            ->orderBy('ordering','DESC')
            ->where(['employee_id'=>$employee->id,'category'=>'Academic'])
            ->select(['qualification','course',DB::raw("YEAR(date) AS year")])
            ->get();    //employee_qualifications
        if (count($qualifications) < 1)
            return back()->with('error','Please check your Qualifications! Make Sure you have at least 1 Academic');

        $pno = strtoupper(substr($pno,0,$indexOfP+1)).".".number_format(substr($pno,$indexOfP+1),0);//
        $dept = $employee->department;
        $fac = $dept->faculty();
        $complex = $fac->complex();
        $dean = $fac->deanName();
        $cch = $complex?$complex->chairmanName():"";
        return view("pages.staff.profile.summary_view",
            compact('qualifications','title','dofc','dofp','dolp','dord',"employee",'year',
                'faculty','nop','publications','req','complex','department','pno','rankonapp',
                'presentrank', 'presentsalary','supervisions','dean','cch','complexStatus','recommendedRank'));
    }

    public function staffSummary(Request $request, $employee_id)
    {
//        return $request;
        $employee = Employee::find($employee_id);
        $year = $request->year;
        $dofp = $employee->date_of_first_appointment;//Carbon::parse($request->dofp)->format('jS F Y');
        $dolp= $employee->date_of_last_promotion;//Carbon::parse($request->dolp)->format('jS M, Y');
        $dofc= $employee->date_of_confirmation;//Carbon::parse($request->dofc)->format('jS F Y');
        $dord= $employee->date_of_redesignation;//Carbon::parse($request->dofc)->format('jS F Y');
        //$yearOfLastPromotion = $employee->date_of_last_promotion->format('Y');
        $nop = $request->nop;
        $rankonapp = Rank::find($employee->rank_on_employment)->name;
        $presentrank = Rank::find($employee->rank_id)->name;
        $presentsalary = SalaryGradeLevel::find($employee->salary_grade_level_id)->grade;
        $req = 1998;//explode(',',$request->req);
//        $att = explode(',',$request->att);
////        $sup = $request->sup;
        $title = $employee->title;
        $department = $employee->department;
        $faculty = Faculty::find($department->faculty_id);
        $pno = strtolower($employee->personnel_no);
        $indexOfP = strpos($pno,"p");

        $publications = EmployeePublication::selectRaw('type, COUNT(employee_id) as count')
            ->where(['employee_id'=>$employee_id])
            ->groupBy('type')
            ->get();

        $supervisions = EmployeeSupervision::selectRaw('year, COUNT(employee_id) as count')
            ->where(['employee_id'=>$employee_id])
            ->groupBy('year')
            ->get();

        $complexStatus =  PromotionRecomendation::select('unit_recommendation', 'complex_status','recommended_rank_id')
            ->where('employee_id', $employee->id)
            ->where('year', $year)
            ->first();
            $recommendedRank = Rank::find($complexStatus->recommended_rank_id);
        // if($complexStatus->employee_id==11195){
        //     return $complexStatus;
        // }
// Create a formatted output string
//        $output = "";
//        foreach ($publications as $publication) {
//            $output .= "{$publication->type} {$publication->count}(" . \Illuminate\Support\Str::plural('employee', $publication->count) . ")" . PHP_EOL;
//        }
//
//// Output the result
//        echo $output;

        $qualifications = EmployeeQualification::join("qualifications","qualifications.id","=","employee_qualifications.type")
            ->orderBy('ordering','ASC')
//            ->where(['employee_id'=>$employee_id])
            ->where(['employee_id'=>$employee->id,'category'=>'Academic'])
            ->select(['qualification','course',DB::raw("YEAR(date) AS year")])
            ->get();    //employee_qualifications
        if (count($qualifications) < 1)
            return back()->with('error','Please check your Qualifications! Make Sure you have at least 1 Academic');

        $pno = strtoupper(substr($pno,0,$indexOfP+1)).".".number_format(substr($pno,$indexOfP+1),0);//

        $dept = $employee->department;
        $fac = $dept->faculty();
        $complex = $fac->complex();
        $dean = $fac->deanName();
        $cch = $complex?$complex->chairmanName():"";
        return view("pages.staff.profile.summary_view",
            compact('qualifications','title','dofc','dofp','dolp','dord','dean',"employee",'year',
                'faculty','nop','publications','req','complex','department','pno','rankonapp',
                'presentrank', 'presentsalary','supervisions','cch','complexStatus','recommendedRank'));
    }

}
