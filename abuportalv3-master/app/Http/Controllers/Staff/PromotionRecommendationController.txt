<?php

namespace App\Http\Controllers\Staff;

use App\Http\Controllers\Controller;
use App\Models\PromotionRecomendation;
use App\Models\Complex;
use App\Models\Faculty;
use App\Models\Department;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;

class PromotionRecommendationController extends Controller
{
    public function __construct()
    {
        $this->middleware(['auth:staff']);
    }

    public function index()
    {
        if (!$this->access(Auth::user(), 'promotion.recommendations.report'))
            return view("pages.errors.nopermission");

        // Debug: Check if we have any data
        $totalRecords = PromotionRecomendation::count();
        $sampleData = PromotionRecomendation::select('complex_id', 'complex_name', 'faculty_id', 'faculty_name', 'department_id', 'department_name')
            ->whereNotNull('complex_id')
            ->limit(5)
            ->get();

        \Log::info('Promotion recommendations data check:', [
            'total_records' => $totalRecords,
            'sample_data' => $sampleData->toArray()
        ]);

        return view('pages.staff.promotion.promotion_recommendations_report');
    }

    public function getComplexes()
    {
        try {
            // First try to get from promotion recommendations table
            $complexes = PromotionRecomendation::select('complex_id', 'complex_name')
                ->whereNotNull('complex_id')
                ->whereNotNull('complex_name')
                ->distinct()
                ->orderBy('complex_name')
                ->get();

            // If no data in promotion recommendations, try Complex model
            if ($complexes->isEmpty()) {
                $complexes = Complex::select('id as complex_id', 'name as complex_name')
                    ->orderBy('name')
                    ->get();
            }

            \Log::info('Found complexes:', ['count' => $complexes->count(), 'complexes' => $complexes->toArray()]);

            $result = "";

            if ($complexes->count() > 1)
                $result .= "<option value='%'>All Complexes</option>";

            foreach ($complexes as $complex) {
                $result .= "<option value='" . $complex->complex_id . "'>$complex->complex_name</option>";
            }

            if (empty($result)) {
                $result = "<option value=''>No complexes found</option>";
            }

            return $result;

        } catch (\Exception $e) {
            \Log::error('Error in getComplexes:', ['error' => $e->getMessage()]);
            return "<option value=''>Error loading complexes</option>";
        }
    }

    public function getFaculties(Request $request)
    {
        try {
            // Debug logging
            \Log::info('getFaculties called with:', $request->all());

            $faculties = collect();

            // First try to get from promotion recommendations table
            $promotionFaculties = PromotionRecomendation::select('faculty_id', 'faculty_name')
                ->whereNotNull('faculty_id')
                ->whereNotNull('faculty_name')
                ->distinct();

            if ($request->complex && $request->complex !== '%') {
                $promotionFaculties->where('complex_id', $request->complex);
            }

            $promotionFaculties = $promotionFaculties->orderBy('faculty_name')->get();

            \Log::info('Promotion faculties query result:', ['count' => $promotionFaculties->count(), 'faculties' => $promotionFaculties->toArray()]);

            // If no data in promotion recommendations, try Faculty model
            if ($promotionFaculties->isEmpty()) {
                \Log::info('No promotion faculties found, trying Faculty model');
                $faculties = Faculty::select('id as faculty_id', 'name as faculty_name')
                    ->orderBy('name')
                    ->get();
                \Log::info('Faculty model result:', ['count' => $faculties->count(), 'faculties' => $faculties->toArray()]);
            } else {
                $faculties = $promotionFaculties;
            }

            \Log::info('Found faculties:', ['count' => $faculties->count(), 'faculties' => $faculties->toArray()]);

            // Return JSON response
            $facultiesArray = $faculties->map(function($faculty) {
                return [
                    'id' => $faculty->faculty_id,
                    'name' => $faculty->faculty_name
                ];
            })->toArray();

            return response()->json([
                'success' => true,
                'faculties' => $facultiesArray
            ]);

        } catch (\Exception $e) {
            \Log::error('Error in getFaculties:', ['error' => $e->getMessage(), 'trace' => $e->getTraceAsString()]);
            return response()->json([
                'success' => false,
                'message' => 'Error loading faculties',
                'faculties' => []
            ]);
        }
    }

    public function getDepartments(Request $request)
    {
        try {
            $departments = collect();

            // First try to get from promotion recommendations table
            $promotionDepartments = PromotionRecomendation::select('department_id', 'department_name')
                ->whereNotNull('department_id')
                ->whereNotNull('department_name')
                ->distinct();

            if ($request->faculty && $request->faculty !== '%') {
                $promotionDepartments->where('faculty_id', $request->faculty);
            }

            // Note: We'll filter by complex through faculty relationship if needed

            $promotionDepartments = $promotionDepartments->orderBy('department_name')->get();

            // If no data in promotion recommendations, try Department model
            if ($promotionDepartments->isEmpty()) {
                $departmentQuery = Department::select('id as department_id', 'name as department_name');

                if ($request->faculty && $request->faculty !== '%') {
                    $departmentQuery->where('faculty_id', $request->faculty);
                }

                $departments = $departmentQuery->orderBy('name')->get();
            } else {
                $departments = $promotionDepartments;
            }

            // Return JSON response
            $departmentsArray = $departments->map(function($department) {
                return [
                    'id' => $department->department_id,
                    'name' => $department->department_name
                ];
            })->toArray();

            return response()->json([
                'success' => true,
                'departments' => $departmentsArray
            ]);

        } catch (\Exception $e) {
            \Log::error('Error in getDepartments:', ['error' => $e->getMessage()]);
            return response()->json([
                'success' => false,
                'message' => 'Error loading departments',
                'departments' => []
            ]);
        }
    }

    public function getYears()
    {
        try {
            $years = PromotionRecomendation::select('year')
                ->distinct()
                ->orderBy('year', 'desc')
                ->pluck('year');

            // If no data in promotion recommendations, return recent years
            if ($years->isEmpty()) {
                $years = collect(range(2020, date('Y')));
            }

            return response()->json($years);

        } catch (\Exception $e) {
            \Log::error('Error in getYears:', ['error' => $e->getMessage()]);
            return response()->json(range(2020, date('Y')));
        }
    }

    public function getRanks(Request $request)
    {
        try {
            $query = PromotionRecomendation::select('recommended_rank_id', 'recommended_rank')
                ->whereNotNull('recommended_rank_id')
                ->whereNotNull('recommended_rank')
                ->distinct();

            // Apply filters
            if ($request->complex_id && $request->complex_id !== '%') {
                $query->where('complex_id', $request->complex_id);
            }

            if ($request->faculty_id && $request->faculty_id !== '%') {
                $query->where('faculty_id', $request->faculty_id);
            }

            if ($request->department_id && $request->department_id !== '%') {
                $query->where('department_id', $request->department_id);
            }

            if ($request->year) {
                $query->where('year', $request->year);
            }

            $ranks = $query->get()->map(function($item) {
                return [
                    'id' => $item->recommended_rank_id,
                    'name' => $item->recommended_rank
                ];
            });

            // If no data in promotion recommendations, try Rank model
            if ($ranks->isEmpty()) {
                $ranks = \App\Models\Rank::select('id', 'name')
                    ->orderBy('name')
                    ->get()
                    ->map(function($item) {
                        return [
                            'id' => $item->id,
                            'name' => $item->name
                        ];
                    });
            }

            return response()->json($ranks);

        } catch (\Exception $e) {
            \Log::error('Error in getRanks:', ['error' => $e->getMessage()]);
            return response()->json([]);
        }
    }

    public function generateReport(Request $request)
    {
        try {
            $complexId = $request->query('complex');
            $facultyId = $request->query('faculty');
            $departmentId = $request->query('department');
            $year = $request->query('year');
            $rankId = $request->query('rank');

            $conditions = [];

            // Apply filters only if not "All" (%) or empty
            if ($year !== '%' && $year !== null && $year !== '') {
                $conditions[] = ['promotion_recomendations.year', '=', $year];
            }

            if ($complexId !== '%' && $complexId !== null && $complexId !== '') {
                $conditions[] = ['complexes.id', '=', $complexId];
            }

            if ($facultyId !== '%' && $facultyId !== null && $facultyId !== '') {
                $conditions[] = ['faculties.id', '=', $facultyId];
            }

            if ($departmentId !== '%' && $departmentId !== null && $departmentId !== '') {
                $conditions[] = ['departments.id', '=', $departmentId];
            }

            if ($rankId !== '%' && $rankId !== null && $rankId !== '') {
                $conditions[] = ['promotion_recomendations.recommended_rank_id', '=', $rankId];
            }

            $results = DB::table('promotion_recomendations')
                ->leftJoin('complexes', 'promotion_recomendations.complex_id', '=', 'complexes.id')
                ->leftJoin('departments', 'promotion_recomendations.department_id', '=', 'departments.id')
                ->leftJoin('faculties', 'departments.faculty_id', '=', 'faculties.id')
                ->select([
                    'promotion_recomendations.id',
                    'promotion_recomendations.personnel_no',
                    'promotion_recomendations.name',
                    'complexes.name as complex_name',
                    'faculties.name as faculty_name',
                    'departments.name as department_name',
                    'promotion_recomendations.unit_status',
                    'promotion_recomendations.present_salary_step',
                    'promotion_recomendations.unit_recommendation',
                    'promotion_recomendations.recommended_rank',
                    'promotion_recomendations.year',
                    'promotion_recomendations.faculty_status',
                    'promotion_recomendations.faculty_recommendation',
                ])
                ->where($conditions)
                ->orderBy('faculties.name')
                ->orderBy('departments.name')
                ->orderBy('promotion_recomendations.name')
                ->get();

            return view('pages.staff.promotion.load_promotion_recommendations_data', compact('results'));

        } catch (\Throwable $e) {
            \Log::error('Error in generateReport: ' . $e->getMessage());
            return response()->json(['error' => 'Something went wrong.'], 500);
        }
    }

    public function test()
    {
        try {
            $totalRecords = PromotionRecomendation::count();
            $sampleData = PromotionRecomendation::select('complex_id', 'complex_name', 'faculty_id', 'faculty_name', 'department_id', 'department_name')
                ->whereNotNull('complex_id')
                ->limit(5)
                ->get();

            return response()->json([
                'status' => 'success',
                'total_records' => $totalRecords,
                'sample_data' => $sampleData->toArray()
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'status' => 'error',
                'message' => $e->getMessage()
            ]);
        }
    }

    public function testFaculties()
    {
        try {
            // Test if we can get faculties from the Faculty model
            $faculties = Faculty::select('id as faculty_id', 'name as faculty_name')
                ->orderBy('name')
                ->limit(10)
                ->get();

            // Test if we can get faculties from promotion recommendations
            $promotionFaculties = PromotionRecomendation::select('faculty_id', 'faculty_name')
                ->whereNotNull('faculty_id')
                ->whereNotNull('faculty_name')
                ->distinct()
                ->limit(10)
                ->get();

            return response()->json([
                'status' => 'success',
                'faculty_model_count' => $faculties->count(),
                'faculty_model_data' => $faculties->toArray(),
                'promotion_faculties_count' => $promotionFaculties->count(),
                'promotion_faculties_data' => $promotionFaculties->toArray()
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'status' => 'error',
                'message' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
        }
    }

    public function recommendedCases()
    {
        if (!$this->access(Auth::user(), 'promotion.recommendations.report'))
            return view("pages.errors.nopermission");

        return view('pages.staff.promotion.recommended_cases');
    }

    public function getRecommendedCasesData(Request $request)
    {
        try {
            $complexId = $request->query('complex');
            $facultyId = $request->query('faculty');
            $departmentId = $request->query('department');
            $year = $request->query('year');
            $rankId = $request->query('rank');

            $query = PromotionRecomendation::select([
                'title',
                'personnel_no',
                'name',
                'complex_name',
                'faculty_name',
                'department_name',
                'dolp',
                'complex_status',
                'recommended_rank'
            ])
            ->where('complex_status', 'Recommended');

            // Apply filters
            if ($complexId && $complexId !== '%' && $complexId !== '') {
                $query->where('complex_id', $complexId);
            }

            if ($facultyId && $facultyId !== '%' && $facultyId !== '') {
                $query->where('faculty_id', $facultyId);
            }

            if ($departmentId && $departmentId !== '%' && $departmentId !== '') {
                $query->where('department_id', $departmentId);
            }

            if ($year && $year !== '%' && $year !== '') {
                $query->where('year', $year);
            }

            if ($rankId && $rankId !== '%' && $rankId !== '') {
                $query->where('recommended_rank_id', $rankId);
            }

            $results = $query->orderBy('complex_name')
                ->orderBy('faculty_name')
                ->orderBy('department_name')
                ->orderBy('name')
                ->get();

            return view('pages.staff.promotion.load_recommended_cases_data', compact('results'));

        } catch (\Throwable $e) {
            \Log::error('Error in getRecommendedCasesData: ' . $e->getMessage());
            return response()->json(['error' => 'Something went wrong.'], 500);
        }
    }

    protected function access($user, $permission)
    {
        // Add your access control logic here
        // For now, returning true - you can implement proper permission checking
        return true;
    }
}
