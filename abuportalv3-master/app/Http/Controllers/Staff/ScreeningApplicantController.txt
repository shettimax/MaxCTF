<?php

namespace App\Http\Controllers\Staff;

use App\Http\Controllers\Controller;
use App\Models\Candidate;
use App\Models\CandidateDocument;
use App\Models\CandidateForm;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use App\Models\CandidateBiodata;
use App\Services\ExternalFileService;

class ScreeningApplicantController extends Controller
{
    protected $externalFileService;

    public function __construct()
    {
        $this->middleware('auth:staff');
        $this->externalFileService = app(ExternalFileService::class);
    }

    public function index()
    {
        if ($this->access(Auth::user(), "staff.putme.screening"))
            return view('pages.staff.form.applicant.screeningapplicant');
    }

    public function searchApplicant(Request $request)
    {
        try {
            $searchAppno = $request->jambnumber;
            if ($request->type == 'UTME') {
                $candidate = Candidate::where('username', '=', $searchAppno)->first();
                if ($candidate) {

                    $candidateForm = $candidate->candidateForms()->first();
                    $cId = $candidateForm->id;
                } else {
                    return redirect()->route("staff.search.candidate")->with("error", "Invalid Jamb number !");
                }
            } else {
                // Check if it's an email search first
                if (filter_var($searchAppno, FILTER_VALIDATE_EMAIL)) {
                    $candidate = Candidate::where('email', '=', $searchAppno)->first();
                    if ($candidate) {
                        $candidateForm = $candidate->candidateForms()->first();
                        $cId = $candidateForm ? $candidateForm->id : null;
                    } else {
                        return redirect()->route("staff.search.candidate")->with("error", "Invalid email address !");
                    }
                } else {
                    // Assume it's a candidate form ID
                    $candidateForm = CandidateForm::find($searchAppno);
                    if ($candidateForm) {
                        $candidate = Candidate::find($candidateForm->candidate_id);
                        $cId = $request->jambnumber;
                    } else {
                        return redirect()->route("staff.search.candidate")->with("error", "Invalid application number !");
                    }
                }
            }
//
//        $searchAppno = $request->applicant_number;
//        $candidateForm = CandidateForm::find($searchAppno);
            if ($candidateForm && $candidate) {
//          $candidateForm = $candidate->candidateForms()->first();
                $candidate = $candidateForm->candidate()->first();
                if ($candidateForm->exam_screening == 'Not Screened') {
                    $candidateBiodata = $candidate->biodata();
                    $candidateContact = $candidate->contact();
                    $programme = $candidateForm->programme();
                    $candidateid = $candidate->id;
                    if (file_exists(public_path() . '/candidatepics/' . $candidateid . '.JPG')) {
                        $url = 'candidatepics/' . $candidateid . '.JPG';
                    } else {
                        $url = 'studentpics/man.jpg';
                    }
                    return view("pages.staff.form.applicant.screeningapplicant", compact("candidateBiodata", "candidate", "candidateContact", "candidateForm", "url"));
                } else {
                    return redirect()->route("staff.putme.screening")->with("success", "Already Screened");
                }
            } else {
                return redirect()->route("staff.putme.screening")->with("error", "Invalid application number");

            }
        } catch (\Exception $e) {
            return $e->getMessage() . $e->getTraceAsString();
        }

    }

    public function updateApplicant(Request $request)
    {
//        return $request;
        try {
            $setcandidatestatus = CandidateForm::find($request->candid);
            $setcandidatestatus->exam_screening = $request->input('candidate_status');
            $setcandidatestatus->exams_venue = $request->input('venue'); // Added venue update
            $setcandidatestatus->exam_screening_date = now(); // Added timein update
            $setcandidatestatus->save();


            return redirect()->route("staff.putme.screening")->with("success", "Applicant has been cleared successfully");
        } catch (\Exception $e) {
            return redirect()->back()->with("error", $e->getMessage() . 'Invalid Applicant Number');
        }
    }


    public function profileImage($appno)
    {
        $candidate = Candidate::find($appno);
        $fileName = str_replace("/", "_", strtoupper($candidate->id));
        if (file_exists(public_path() . '/candidatepics/' . $fileName . '.jpg')) {
            $pathToFile = public_path() . "/candidatepics/" . $fileName . ".jpg";
        } elseif (file_exists(public_path() . '/candidatepics/' . $fileName . '.JPG')) {
            $pathToFile = public_path() . "/candidatepics/" . $fileName . ".JPG";
        } else {
            $pathToFile = public_path() . "/studentpics/user.png";
        }
        return response()->file($pathToFile);
    }

    /**
     * Delete candidate photo
     */
    public function deleteCandidatePhoto(Request $request)
    {
        try {
            $candidateId = $request->input('candidate_id');

            if (!$candidateId) {
                return redirect()->back()->with('error', 'Candidate ID is required');
            }

            $candidate = Candidate::find($candidateId);
            if (!$candidate) {
                return redirect()->back()->with('error', 'Candidate not found');
            }

            $deletedFromExternal = false;
            $deletedFromLocal = false;
            $errors = [];

            // Delete from external file server
            try {
                $externalFileService = app(ExternalFileService::class);
                if ($externalFileService->isConfigured()) {
                    $fileName = str_replace("/", "_", $candidateId) . ".JPG";
                    $photoPath = "candidate/photos/{$fileName}";

                    if ($externalFileService->exists($photoPath)) {
                        if ($externalFileService->delete($photoPath)) {
                            $deletedFromExternal = true;
                            Log::info("Candidate photo deleted from external server", [
                                'candidate_id' => $candidateId,
                                'photo_path' => $photoPath
                            ]);
                        } else {
                            $errors[] = "Failed to delete photo from external server";
                            Log::warning("Failed to delete candidate photo from external server", [
                                'candidate_id' => $candidateId
                            ]);
                        }
                    }
                }
            } catch (\Exception $e) {
                $errors[] = "Error deleting photo from external server: " . $e->getMessage();
                Log::error("Exception deleting candidate photo from external server", [
                    'candidate_id' => $candidateId,
                    'error' => $e->getMessage(),
                    'trace' => $e->getTraceAsString()
                ]);
            }

            // Delete from local storage
            try {
                $fileName = str_replace("/", "_", strtoupper($candidateId));
                $localPaths = [
                    public_path('candidatepics/' . $fileName . '.JPG'),
                    public_path('candidatepics/' . $fileName . '.jpg'),
                    public_path('candidatepics/' . $candidateId . '.JPG'),
                    public_path('candidatepics/' . $candidateId . '.jpg'),
                ];

                foreach ($localPaths as $localPath) {
                    if (file_exists($localPath)) {
                        if (unlink($localPath)) {
                            $deletedFromLocal = true;
                            Log::info("Candidate photo deleted from local storage", [
                                'candidate_id' => $candidateId,
                                'local_path' => $localPath
                            ]);
                        }
                    }
                }
            } catch (\Exception $e) {
                $errors[] = "Error deleting photo from local storage: " . $e->getMessage();
                Log::error("Exception deleting candidate photo from local storage", [
                    'candidate_id' => $candidateId,
                    'error' => $e->getMessage()
                ]);
            }

            // Set appropriate success/error messages
            if ($deletedFromExternal || $deletedFromLocal) {
                if (empty($errors)) {
                    return redirect()->back()->with('success', 'Candidate photo deleted successfully!');
                } else {
                    return redirect()->back()->with('success', 'Candidate photo deleted with some warnings: ' . implode(', ', $errors));
                }
            } else {
                return redirect()->back()->with('error', 'Photo not found or already deleted');
            }

        } catch (\Exception $e) {
            Log::error("Exception in deleteCandidatePhoto", [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);
            return redirect()->back()->with('error', 'Failed to delete photo: ' . $e->getMessage());
        }
    }

    public function searchindex()
    {
        $candidateContactCheck = false;
        $candidateBiodataCheck = false;
        $candidateOlevelCheck = false;
        $candidateBiodataCheckArr = [];
        if ($this->access(Auth::user(), "staff.search.candidate"))
            return view('pages.staff.form.applicant.admittedcandidate', compact('candidateOlevelCheck', 'candidateBiodataCheckArr', 'candidateContactCheck', 'candidateBiodataCheck'));
    }


    public function searchadmittedcandidate(Request $request)
    {
        try {
            $searchadmittedcandidate = $request->jambnumber;

            $candidateContactCheck = false;
            $candidateBiodataCheck = false;
            $candidateOlevelCheck = false;
            $candidateBiodataCheckArr = [];

            if ($request->type == 'UTME') {
                $candidate = Candidate::where('username', '=', $searchadmittedcandidate)->first();
                if ($candidate) {
                    $candidateForm = $candidate->candidateForms()->first();
                    $cId = $candidateForm->id;
                } else {
                    return redirect()->route("staff.search.candidate")->with("error", "Invalid Jamb number !");
                }
            } else {
                // Check if it's an email search first
                if (filter_var($searchadmittedcandidate, FILTER_VALIDATE_EMAIL)) {
                    $candidate = Candidate::where('email', '=', $searchadmittedcandidate)->first();
                    if ($candidate) {
                        $candidateForm = $candidate->candidateForms()->first();
                        $cId = $candidateForm ? $candidateForm->id : null;
                    } else {
                        return redirect()->route("staff.search.candidate")->with("error", "Invalid email address !");
                    }
                } else {
                    // Assume it's a candidate form ID
                    $candidateForm = CandidateForm::find($searchadmittedcandidate);
                    if ($candidateForm) {
                        $candidate = Candidate::find($candidateForm->candidate_id);
                        $cId = $request->jambnumber;
                    } else {
                        return redirect()->route("staff.search.candidate")->with("error", "Invalid application number !");
                    }
                }
            }

            $user = Auth::user();

            if ($candidateForm && $candidate) {
                $data = $user->permissionThrough("staff.search.candidate");
//                return ;
                if (!in_array($candidateForm->admittedProgramme->id, $data['scope']["display"]["programmes"])) {
                    return redirect()->route("staff.search.candidate")->with("error", "Invalid application number");
                }

                if ($candidateForm->admission_status == 'admitted') {
                    $status = $candidateForm->screening_status;
                    // return back()->with('success', $status);
                    if ($status == 'Qualified') {
                        return redirect()->route("staff.search.candidate")->with("success", "Already Screened Qualified!");
                    } else {
                        $candidateBiodata = $candidate->biodata();
                        $candidateContact = $candidate->contact();
                        $type = $candidateForm->candidateFormType();

                        if ($status != 'Not Screened' && !$candidateForm->admittedProgramme->isPG())
                            return redirect()->route("staff.search.candidate")->with("success", "Already Screened!");

                        if (!$candidateContact) {
                            $candidateContactCheck = true;
                        }
//                        20920725ca
                        if (!$candidateBiodata) {
                            $candidateBiodataCheck = true;
                        } else {
                            if (!$candidateBiodata->lga_id) {
                                $candidateBiodataCheckArr[] = 'LGA/State not selected';
                            }
                            if (!$candidateBiodata->country_id) {
                                $candidateBiodataCheckArr[] = 'Country not selected';
                            }
                            if (count($candidateBiodataCheckArr)) {
                                $candidateBiodataCheck = true;
                            }

                        }

                        $programme = $candidateForm->programme();
//                        $candidate = Candidate::find($candidate->candidate_id);
                        $candidateid = $candidate->id;
                        if (file_exists(public_path() . '/candidatepics/' . $candidateid . '.JPG')) {
                            $url = 'candidatepics/' . $candidateid . '.JPG';
                        } else {
                            $url = 'studentpics/man.jpg';
                        }

                        $screened = $status == 'Not Screened' ? '' : 'This candidate is already screened \'' . $status . '\'. Are you sure you want to Re-Screen '
                            . ($candidateBiodata->gender == 'Male' ? 'him' : 'her') . '?';

                        $docs = $candidate->documents();

                        // Get external URLs for documents
                        $docsWithUrls = [];
                        foreach ($docs as $doc) {
                            // Get external URL from the document path stored in database
                            if (isset($doc['document'])) {
                                $doc['external_url'] = $this->externalFileService->getUrl($doc['document']);
                            }
                            $docsWithUrls[] = $doc;
                        }
                        $docs = $docsWithUrls;

                        // Get available levels for step-down (only for programme_type_id 2 and 4)
                        $availableLevels = [];
                        $admissionLevel = null;
                        $currentLevelNumber = null;
                        if (in_array($programme->programme_type_id, [2, 4])) {
                            // Get the admission level based on level_admitted_index
                            $admissionLevelNumber = $this->getAdmissionLevelNumber($candidateForm, $programme);

                            if ($admissionLevelNumber) {
                                // Use level_admitted_index if set (stepped down), otherwise use calculated admission level
                                $currentLevelNumber = $candidateForm->level_admitted_index !== null
                                    ? $candidateForm->level_admitted_index
                                    : $admissionLevelNumber;

                                // Get all levels with same programme_type_id and number < current level
                                $availableLevels = \App\Models\Level::where('programme_type_id', $programme->programme_type_id)
                                    ->where('number', '<', $currentLevelNumber)
                                    ->orderBy('number', 'DESC')
                                    ->get();

                                // Get the current level object
                                $admissionLevel = \App\Models\Level::where('programme_type_id', $programme->programme_type_id)
                                    ->where('number', $currentLevelNumber)
                                    ->first();
                            }
                        }

                        return view("pages.staff.form.applicant.admittedcandidate",
                            compact("candidateBiodata", "candidate", "candidateContact",
                                "candidateForm", "url", "type", 'cId', 'candidateOlevelCheck', 'docs',
                                'candidateBiodataCheckArr', 'candidateContactCheck', 'candidateBiodataCheck', 'screened',
                                'availableLevels', 'admissionLevel', 'currentLevelNumber', 'programme'));
                    }
                } else {
                    return redirect()->route("staff.search.candidate")->with("error", "Sorry you have not been admitted !");
                }
            } else {
                return redirect()->route("staff.search.candidate")->with("error", "Invalid application number");
            }
        } catch (\Exception $e) {
            return $e->getMessage() . $e->getTraceAsString();
        }

    }

    public function updateAdmmittedCandidate(Request $request)
    {
        try {
            $user = Auth::user()->id;
            $status = $request->input('candidate_status');
            $setcandidatestatus = CandidateForm::find($request->candid);

            if (!$setcandidatestatus) {
                return redirect(route('staff.search.candidate'))->with("error", "Invalid Applicant Number");
            }

            $setcandidatestatus->screening_status = $status;
            $setcandidatestatus->remark_id = $request->input('candidate_status') != 'Pending' ? null : $request->remark_id;
            $setcandidatestatus->screened_by = $user;

            // Handle level step-down for programme_type_id 2 and 4
            if ($request->has('level_admitted_index')) {
                $programme = $setcandidatestatus->admittedProgramme;
                if ($programme && in_array($programme->programme_type_id, [2, 4])) {
                    if ($request->level_admitted_index !== '' && $request->level_admitted_index !== null) {
                        $selectedLevelNumber = (int)$request->level_admitted_index;

                        // Validate that the selected level exists and has correct programme_type_id
                        $selectedLevel = \App\Models\Level::where('programme_type_id', $programme->programme_type_id)
                            ->where('number', $selectedLevelNumber)
                            ->first();

                        if ($selectedLevel) {
                            // Get the original admission level to validate
                            $admissionLevelNumber = $this->getAdmissionLevelNumber($setcandidatestatus, $programme);
                            if ($admissionLevelNumber && $selectedLevelNumber < $admissionLevelNumber) {
                                // Store the level number in level_admitted_index
                                $setcandidatestatus->level_admitted_index = $selectedLevelNumber;
                            }
                        }
                    } else {
                        // If empty, reset to null (use original calculated level)
                        $setcandidatestatus->level_admitted_index = null;
                    }
                }
            }

            $setcandidatestatus->save();
            return redirect()->route("staff.search.candidate")->with("success", "Applicant has been screened '" . $status . "'");
        } catch (\Exception $e) {
            return redirect(route('staff.search.candidate'))->with("error", $e->getMessage() . ' Invalid Applicant Number');
        }
    }

    /**
     * Get the admission level number based on candidate form and programme
     * If level_admitted_index is already set (from previous step-down), use that
     * Otherwise, calculate from form type
     */
    private function getAdmissionLevelNumber($candidateForm, $programme)
    {
        // If level_admitted_index is already set and is a valid level number, use it
        if ($candidateForm->level_admitted_index !== null) {
            $level = \App\Models\Level::where('programme_type_id', $programme->programme_type_id)
                ->where('number', $candidateForm->level_admitted_index)
                ->first();
            if ($level) {
                return $candidateForm->level_admitted_index;
            }
        }

        // Otherwise, get the entry level ID that would be used (matching CandidateForm::migrateToStudent logic)
        $entryLevelId = $this->getEntryLevelId($candidateForm, $programme);

        if ($entryLevelId) {
            $entryLevel = \App\Models\Level::find($entryLevelId);
            if ($entryLevel && $entryLevel->programme_type_id == $programme->programme_type_id) {
                return $entryLevel->number;
            }
        }

        return null;
    }

    /**
     * Get the entry level ID based on candidate form (matching migrateToStudent logic)
     */
    private function getEntryLevelId($candidateForm, $programme)
    {
        $formSetting = $candidateForm->formSetting;
        $session = $formSetting ? $formSetting->session : null;
        $fmSt = \App\Models\FormSetting::where(['session' => $session, "programme_id" => $programme->id])->first();

        $candFormType = $candidateForm->candidateFormType();
        $formTypeId = $candFormType ? $candFormType->id : null;

        if (in_array($formTypeId, [1, 2])) {
            $candFormType = $formTypeId;
        } else {
            if ($fmSt) {
                $candFormType = $fmSt->candidate_form_type_id;
            } else {
                $candFormType = $formTypeId;
            }
        }

        $levelAdmittedIndex = $candidateForm->level_admitted_index ?? 0;

        // Map form types to level IDs (matching CandidateForm::migrateToStudent)
        $entryLevelId = null;
        switch ($candFormType) {
            case 1:
                $entryLevelId = 3;
                break;
            case 2:
                $entryLevelId = 4;
                break;
            case 3:
                $entryLevelId = $levelAdmittedIndex == 0 ? 1 : ($levelAdmittedIndex == 1 ? 1 : 2);
                break;
            case 4:
                $entryLevelId = 11;
                break;
            case 5:
                $entryLevelId = 9;
                break;
            case 6:
                $entryLevelId = $levelAdmittedIndex == 0 ? 15 : ($levelAdmittedIndex == 1 ? 15 : 16);
                break;
            case 8:
                $entryLevelId = $levelAdmittedIndex == 0 ? 18 : ($levelAdmittedIndex == 1 ? 18 : 20);
                break;
            case 11:
                $entryLevelId = 5;
                break;
            case 12:
                $entryLevelId = $levelAdmittedIndex == 0 ? 21 : ($levelAdmittedIndex == 1 ? 21 : 22);
                break;
            case 10:
                $entryLevelId = 9;
                break;
            case 13:
                $entryLevelId = 27;
                break;
            case 14:
                $entryLevelId = 28;
                break;
            case 15:
                $entryLevelId = 29;
                break;
            case 16:
                $entryLevelId = 30;
                break;
            default:
                $entryLevelId = 2;
                break;
        }

        return $entryLevelId;
    }

    public function removeDoc(Request $request)
    {
        $request->validate([
            'candidate_id' => 'required|integer',
            'type' => 'required|string',
        ]);

        $candidateDoc = CandidateDocument::where(['candidate_id' => $request->input('candidate_id')])->first();

        if (!$candidateDoc)
            return response()->json(['success' => false, 'message' => 'Document not found']);

        $docs = collect($candidateDoc->documents);

        $doc = $docs->firstWhere('type', $request->input('type'));
        if (!$doc)
            return response()->json(['success' => false, 'message' => $request->input('type') . ' not found']);

        $updated = $docs->reject(fn($doc) => $doc['type'] == $request->input('type'));
        $candidateDoc->update(['documents' => $updated->values()]);

        return response()->json(['success' => true]);
    }
}
