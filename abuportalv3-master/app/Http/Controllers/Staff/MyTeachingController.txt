<?php

namespace App\Http\Controllers\Staff;

use App\Http\Controllers\Controller;
use App\Models\CourseLecturer;
use App\Models\CourseGroup;
use App\Models\Employee;
use App\Models\Faculty;
use App\Models\Department;
use App\Models\Programme;
use App\Models\Course;
use Auth;

class MyTeachingController extends Controller
{
    public function __construct() {
        $this->middleware('auth:staff');
    }

    public function index() {
        $employee = Employee::find(Auth::user()->employee_id);
        $course_group_ids = CourseLecturer::where(['employee_id' => $employee->id])->pluck('course_group_id');
        $coursegroups = CourseGroup::whereIn('id', $course_group_ids)->orderBy("session", "DESC")
//            ->groupBy("course_id")
            ->get();
        $coursegroupsArr = [];
//        $sessions
        foreach ($coursegroups as $coursegroup) {
            $coursegroupsArr[$coursegroup->session][$coursegroup->semester][] = $coursegroup;
        }
//        $coursegroups = $coursegroups->groupBy(['session', function ($item) {
//            return $item['semester'];
//        }])->sortKeysDesc();
//        return $coursegroupsArr;
        return view('pages.staff.myteaching.index', compact('coursegroupsArr'));
    }

    public function employeeToTimetable($session, $semester) {
        $employee = Auth::user()->employee();
        $timetable = $employee->timeTable($session, $semester)->get();

        return view('pages.staff.myteaching.employee_to_timetable', compact('session', 'semester', 'timetable'));
    }

    public function coursesToTimetable() {
        $currentsession = 2017;
        return view('pages.staff.myteaching.courses_to_timetable');
    }

    public function getSchedules() {
        $employee = Employee::find(Auth::user()->employee_id);
        $session = request('session');
        $semester = request('semester');
        $course_group_ids = CourseLecturer::where(['employee_id' => $employee->id])->pluck('course_group_id');
        $coursegroups = CourseGroup::where(['session' => $session, 'semester' => $semester])->whereIn('id', $course_group_ids)->get();
        $coursegroups = $coursegroups->map(function ($item, $key) {
            return ['coursecode' => $item->course->coursecode, 'coursetitle' => $item->course->coursetitle, 'groupno' => $item->groupno, 'grouptype' => $item->grouptype, 'courseperiod' => $item->courseperiods, 'courselecturer' => $item->employees];
        });
        return $coursegroups;
    }

    public function getSchedulesByCourses() {


        $session = request('session');
        $semester = request('semester');
        $courseids = request('courseids');

        $result = Auth::user()->employee()->timeTable($session, $semester);
        $result = $result->whereIn('course_id', $courseids);

        $coursegroups = CourseGroup::where(['session' => $session, 'semester' => $semester])->whereIn('course_id', $courseids)->get();
        $coursegroups = $coursegroups->map(function ($item, $key) {
            return ['coursecode' => $item->course->coursecode, 'coursetitle' => $item->course->coursetitle, 'groupno' => $item->groupno, 'grouptype' => $item->grouptype, 'courseperiod' => $item->courseperiods, 'courselecturer' => $item->employees];
        });
        return $coursegroups;
    }

    public function timetablePartial() {
        $session = request('session');
        $semester = request('semester');
        $courseids = request('courseids');

        $result = Auth::user()->employee()->timeTable($session, $semester);

        $timetable = $result->whereIn('course_id', $courseids)->get();

//        return "Cool";

//        return $timetable;

        return view('pages.staff.myteaching.courses_to_timetable_partial', compact('session', 'semester', 'timetable'))->render();
    }

    public function getCourses() {
        $department = request('department');
        $session = request('session');
        $semester = request('semester');
        $courses = Course::whereIn('department_id', $department)
            ->where(['coursesemester' => $semester])
            ->leftJoin('course_groups', 'courses.id', '=', 'course_groups.course_id')
            ->where('session', $session)
            ->groupBy('courses.id')
            ->select('courses.coursecode', 'courses.coursetitle', 'courses.courselevel', 'courses.id')
            ->get();
        return $courses;
    }

    public function getFaculties() {
        return Faculty::select('id', 'name as text')->orderBy('name')->get();
    }

    public function getDepartments() {
        $faculties = request('faculties');
        return Department::whereIn('faculty_id', $faculties)->select('id', 'name as text')->orderBy('name')->get();
    }

    public function getProgrammes() {
        $departments = request('departments');
        return Programme::whereIn('departmentid', $departments)->select('id', 'name as text')->get();
    }


    public function studentsEnrolment($session, $semester, $coursecode, $group_id) {
        $employee_id = Auth::user()->employee_id;

        $students = CourseLecturer::where('employee_id', $employee_id)
            ->leftjoin('course_groups', 'course_lecturers.course_group_id', 'course_groups.id')
            ->leftjoin('courses', 'course_groups.course_id', 'courses.id')
            ->leftjoin('course_registrations', 'course_groups.id', 'course_registrations.course_group_id')
            ->leftjoin('students', 'course_registrations.student_id', 'students.id')
            ->leftjoin('session_regs', 'students.id', 'session_regs.student_id')
            ->leftjoin('levels', 'levels.id', 'session_regs.level_id')
            ->leftjoin('programmes', 'session_regs.programme_id', 'programmes.id')
            ->groupby('session_regs.matric_number')
            ->where('course_groups.id', $group_id)
//            ->where(['course_groups.session' => $session, 'course_groups.semester' => $semester])
            ->get();

        $coursetitle = Course::where('coursecode', $coursecode)->first()->coursetitle;
        $otherdetails = collect(['coursecode' => $coursecode, 'coursetitle' => $coursetitle, 'session' => $session, 'semester' => $semester]);
        return view('pages.staff.myteaching.studentsenrolment', compact('students', 'otherdetails'));
    }

    public function getStudentsEnrolment($session, $semester, $coursecode) {
        /*
        //        return $coursecode;


        //        $coursecode = request('coursecode');
                $employee_id = Auth::user()->employee_id;
        //        $session = request('session');
        //        $semester = request('semester');


                $report = CourseLecturer::where('employee_id', $employee_id)
                    ->leftjoin('course_groups', 'course_lecturers.course_group_id', 'course_groups.id')
                    ->where(['session' => $session, 'course_groups.semester' => $semester])
                    ->leftjoin('courses', 'course_groups.course_id', 'courses.id')
                    ->where('courses.coursecode', $coursecode)
                    ->leftjoin('course_registrations', 'course_groups.id', 'course_registrations.course_group_id')
                    ->leftjoin('students', 'course_registrations.student_id', 'students.id')
                    ->leftjoin('programmes', 'students.programme_id', 'programmes.id')
                    ->get()
                    ->groupby('matric_number');
                $report = $report->map(function ($item, $idx) {

                    $matricnumber = $item->pluck('matric_number')->first();
                    $firstname = $item->pluck('firstname')->first();
                    $surname = $item->pluck('surname')->first();
                    $fullname = $firstname . " " . $surname;
                    $gender = $item->pluck('gender')->first();
                    $grouptype = $item->pluck('groupno', 'grouptype');
                    $programme = $item->pluck('name')->first();
                    $entrylevel = $item->pluck('entry_level_id')->first();
                    return [$matricnumber, $fullname, $entrylevel, $gender, $programme, $grouptype];
                });

                return json_encode(array_values($report->toArray()));
                */
    }


    public function collectionMethodsTest() {
        $users = array(
            array("pno" => 1001, "firstname" => "Aminu", "lastname" => "Salami", "status" => "admin"),
            array("pno" => 1002, "firstname" => "Hassan", "lastname" => "Salami", "status" => "analyst"),
            array("pno" => 1003, "firstname" => "Mamuda", "lastname" => "Salami", "status" => "admin"),
            array("pno" => 1004, "firstname" => "Adamu", "lastname" => "Salami", "status" => "operator")
        );
        $users = collect($users);
        $results = $users->map(function ($user) {
            $user['name'] = $user["firstname"] . " - " . $user["lastname"];
            return $user;
        })->filter(function ($user) {
            if ($user['status'] == "admin")
                return $user;
        })->count();
        //return $results;

        $employees = Employee::all();
        return gettype($employees);

    }
}
