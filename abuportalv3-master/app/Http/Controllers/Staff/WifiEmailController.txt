<?php

namespace App\Http\Controllers\Staff;

use App\Http\Controllers\Controller;
use App\Models\WifiEmail;
use App\Models\Student;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Maatwebsite\Excel\Facades\Excel;
use Maatwebsite\Excel\Concerns\ToModel;
use Maatwebsite\Excel\Concerns\WithHeadingRow;
use Maatwebsite\Excel\Concerns\WithValidation;
use Maatwebsite\Excel\Concerns\Importable;

class WifiEmailController extends Controller
{
    public function __construct()
    {
        $this->middleware(['auth:staff']);
    }

    /**
     * Display the upload form
     */
    public function index()
    {
        // Test database connection and model
        try {
            $testCount = WifiEmail::count();
            \Log::info('WifiEmail model test successful', ['count' => $testCount]);
        } catch (\Exception $e) {
            \Log::error('WifiEmail model test failed: ' . $e->getMessage());
        }

        return view('pages.staff.wifi_emails.upload');
    }

    /**
     * Handle the Excel file upload and processing
     */
    public function upload(Request $request)
    {
        $request->validate([
            'excel_file' => 'required|file|mimes:xlsx,xls,csv|max:10240' // 10MB max
        ]);

        $importResults = [
            'success_count' => 0,
            'error_count' => 0,
            'errors' => [],
            'updated_count' => 0,
            'created_count' => 0
        ];

        try {
            DB::beginTransaction();

            \Log::info('Starting Wifi Email Import', [
                'file_name' => $request->file('excel_file')->getClientOriginalName(),
                'file_size' => $request->file('excel_file')->getSize()
            ]);

            // Import the Excel file with custom handling
            $import = new WifiEmailImport($importResults);
            Excel::import($import, $request->file('excel_file'));

            \Log::info('Wifi Email Import Completed', $importResults);

            DB::commit();

            $message = "Upload completed successfully! ";
            $message .= "Created: {$importResults['created_count']}, ";
            $message .= "Updated: {$importResults['updated_count']}, ";
            $message .= "Errors: {$importResults['error_count']}";

            return redirect()->route('staff.wifi_emails.upload')
                ->with('success', $message)
                ->with('import_results', $importResults);

        } catch (\Exception $e) {
            DB::rollback();
            
            \Log::error('Wifi Email Upload Error: ' . $e->getMessage(), [
                'file' => $e->getFile(),
                'line' => $e->getLine(),
                'trace' => $e->getTraceAsString()
            ]);
            
            return redirect()->route('staff.wifi_emails.upload')
                ->with('error', 'Error uploading file: ' . $e->getMessage());
        }
    }

    /**
     * Download template Excel file
     */
    public function downloadTemplate()
    {
        $templateData = [
            ['wifi_username', 'wifi_passwd', 'email_username', 'email_passwd'],
            ['ABU/2021/001', 'password123', 'student001@abu.edu.ng', 'emailpass456'],
            ['ABU/2021/002', 'password456', 'student002@abu.edu.ng', 'emailpass789']
        ];

        return Excel::download(new WifiEmailTemplateExport($templateData), 'wifi_emails_template.xlsx');
    }
}

/**
 * Import class for processing Excel data
 */
class WifiEmailImport implements ToModel, WithHeadingRow, WithValidation
{
    use Importable;

    protected $importResults;

    public function __construct(&$importResults)
    {
        $this->importResults = &$importResults;
    }

    public function model(array $row)
    {
        try {
            // Skip empty rows
            if (empty($row['wifi_username']) || empty($row['wifi_passwd']) || 
                empty($row['email_username']) || empty($row['email_passwd'])) {
                $this->importResults['error_count']++;
                $this->importResults['errors'][] = "Row skipped: Missing required data";
                return null;
            }

            // Find student by matric number (wifi_username)
            $student = Student::where('matric_number', $row['wifi_username'])->first();
            
            if (!$student) {
                $this->importResults['error_count']++;
                $this->importResults['errors'][] = "Student with matric number '{$row['wifi_username']}' not found.";
                return null;
            }

            // Check if record already exists
            $existingRecord = WifiEmail::where('student_id', $student->id)->first();
            
            if ($existingRecord) {
                // Update existing record with data from Excel
                $existingRecord->update([
                    'wifi_username' => $row['wifi_username'],
                    'wifi_passwd' => $row['wifi_passwd'],
                    'email_username' => $row['email_username'],
                    'email_passwd' => $row['email_passwd']
                ]);
                $this->importResults['updated_count']++;
                $this->importResults['success_count']++;
                return null; // Don't create new record
            }

            // Create new record with data from Excel
            $this->importResults['created_count']++;
            $this->importResults['success_count']++;
            
            return new WifiEmail([
                'student_id' => $student->id,
                'wifi_username' => $row['wifi_username'],
                'wifi_passwd' => $row['wifi_passwd'],
                'email_username' => $row['email_username'],
                'email_passwd' => $row['email_passwd']
            ]);

        } catch (\Exception $e) {
            $this->importResults['error_count']++;
            $this->importResults['errors'][] = "Error processing row: " . $e->getMessage();
            \Log::error('WifiEmail Import Row Error: ' . $e->getMessage(), [
                'row' => $row,
                'file' => $e->getFile(),
                'line' => $e->getLine()
            ]);
            return null;
        }
    }

    public function rules(): array
    {
        return [
            'wifi_username' => 'required|string|max:12',
            'wifi_passwd' => 'required|string|max:10',
            'email_username' => 'required|string|max:40',
            'email_passwd' => 'required|string|max:25'
        ];
    }
}

/**
 * Export class for template download
 */
class WifiEmailTemplateExport implements \Maatwebsite\Excel\Concerns\FromArray
{
    protected $data;

    public function __construct(array $data)
    {
        $this->data = $data;
    }

    public function array(): array
    {
        return $this->data;
    }
}

