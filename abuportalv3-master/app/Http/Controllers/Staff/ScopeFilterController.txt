<?php

namespace App\Http\Controllers\Staff;

use App\Models\Course;
use App\Models\Department;
use App\Http\Controllers\Controller;
use App\Models\Faculty;
use App\Models\Level;
use App\Models\Programme;
use App\Models\ProgrammeType;
use App\Models\ResitCourse;
use Auth;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;

class ScopeFilterController extends Controller
{
    public function __construct()
    {
        $this->middleware(['auth:staff']);
    }

    public function faculties_scope(Request $request)
    {
        //
        $user = Auth::user();
        $permission = $request->permission;
        $where = [];
        if ($request->category) {
            $where[] = ["is_other_institute", "!=", "0"];
        }
        $faculties = $user->accessibleFaculties($permission)->where($where)->get();

        return $faculties;
    }

    public function campus_faculties_scope(Request $request)
    {
        //
        $user = Auth::user();
        $permission = $request->permission;
        $where = [];
        if ($request->category) {
            $where[] = ["is_other_institute", "!=", "0"];
        }
        if($request->campus !="0"){
            $where[] = ["campus", "=", $request->campus];
        }
        $faculties = Faculty::where($where)->get();
        $result = "";

        if ($faculties->count() > 1)
            $result .= "<option value='0'>All Faculties</option>";

        foreach ($faculties as $faculty) {
            if ($faculty->type == 'Faculty')
                $result .= "<option value='" . $faculty->id . "'>$faculty->name</option>";
        }
        return $result;
    }

    public function get_faculties_only(Request $request)
    {
        $faculties = $this->faculties_scope($request);

        $result = "";

        if ($faculties->count() > 1)
            $result .= "<option value='%'>All Faculties In Scope</option>";

        foreach ($faculties as $faculty) {
            if ($faculty->type == 'Faculty')
                $result .= "<option value='" . $faculty->id . "'>$faculty->name</option>";
        }

        return $result;
    }

    public function get_faculties(Request $request)
    {
        //
        $faculties = $this->faculties_scope($request);

        $result = "";

        if ($faculties->count() > 1)
            $result .= "<option value='%'>All Faculties In Scope</option>";

        foreach ($faculties as $faculty) {
            $result .= "<option value='" . $faculty->id . "'>$faculty->name</option>";
        }

        return $result;
    }

    public function departments_scope(Request $request)
    {
        //
        $user = Auth::user();
        $id = $request->faculty_id;
        $permission = $request->permission;
        $departments = $user->accessibleDepartments($permission)->where("faculty_id", "like", $id)->get();

        return $departments;
    }

    public function get_departments(Request $request)
    {
        //
        $departments = $this->departments_scope($request);
        $result = "";
        if ($departments->count() > 1)
            $result .= "<option value='%'>All Departments In Scope</option>";

        foreach ($departments as $department) {
            $result .= "<option value='" . $department->id . "'>$department->name</option>";
        }
        return $result;
    }

    public function programme_types_scope($request)
    {
        //
        $user = Auth::user();
//        return [
        $permission = $request->permission;
//        ];
//        return $user->accessibleProgrammeTypes($permission);
        $programmetypes = $user->accessibleProgrammeTypes($permission);

        return $programmetypes;
    }

    public function get_programme_types(Request $request)
    {
        //

        $programmetypes = $this->programme_types_scope($request);
        $result = "";
        $where = [];

        if ($request->programme_mode && $request->programme_mode != "%") {
            $where [] = ['prog_type_code', '=', $request->programme_mode];
        }
        if (count($programmetypes) > 1)
            $result .= "<option value='%'>All Programme Types In Scope</option>";
        $progTypeList = [];
        $flag = false;
        if ($request->department_id || $request->faculty_id) {
            if ($request->department_id && $request->department_id != "%") {
                $flag = true;
                $progTypeList = Programme::where("department_id", $request->department_id)
                    ->select("programme_type_id")
                    ->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
                    ->distinct("programme_type_id")
                    ->where($where)
                    ->pluck("programme_type_id");
            } else if ($request->faculty_id != "%") {
                $flag = true;
                $deptList = Department::where("faculty_id", $request->faculty_id)->pluck("id");
                $progTypeList = Programme::whereIn("department_id", $deptList)
                    ->select("programme_type_id")
                    ->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
                    ->distinct("programme_type_id")
                    ->where($where)
                    ->pluck("programme_type_id");
            }
        }
//        return [ProgrammeType::whereIn("id",$progTypeList)->get(),$programmetypes];
        if ($flag) {
            $programmetypesArr = ProgrammeType::whereIn("prog_type_name", $programmetypes)
                ->where($where)->whereIn("id", $progTypeList)->get();
        } else {
            $programmetypesArr = ProgrammeType::whereIn("prog_type_name", $programmetypes)
                ->where($where)->get();
        }

        if (!count($programmetypesArr)) {
            $result = "";
        }
        foreach ($programmetypesArr as $programmetype) {
            $result .= "<option value='{$programmetype->id}'>$programmetype->prog_type_name</option>";
        }
        return $result;
    }

    public function programmes_scope(Request $request)
    {
        //
        $user = Auth::user();
        $id = $request->department_id;
        $progList = [];
        $where = [];

        if ($request->programme_mode && $request->programme_mode != "%") {
            $where [] = ['prog_type_code', '=', $request->programme_mode];
        }
        
        // If both faculty_id and department_id are "%", return all accessible programmes
        if ($request->faculty_id == "%" && $request->department_id == "%") {
            $permission = $request->permission;
            $programmes = $user->accessibleProgrammes($permission);
            
            // Apply programme_type_id filter if specified
            if ($request->programme_type_id && $request->programme_type_id != '%') {
                $programmes = $programmes->where("programme_type_id", $request->programme_type_id);
            }
            
            // Apply programme_mode filter if specified
            if (!empty($where)) {
                $programmes = $programmes->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
                    ->where($where);
            }
            
            return $programmes->get();
        }
        
        if ($request->department_id || $request->faculty_id || $request->programme_type_id) {
            if ($request->department_id && $request->department_id != "%") {
                $flag = True;
                $progList = Programme::where("department_id", $request->department_id)
                    ->select("programmes.id")
                    ->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
                    ->distinct("programmes.id")
                    ->where($where)
                    ->pluck("programmes.id");
            } else if ($request->faculty_id && $request->faculty_id != "%") {
                $flag = True;
                $deptList = Department::where("faculty_id", $request->faculty_id)->pluck("id");
                $progList = Programme::whereIn("department_id", $deptList)
                    ->select("programmes.id")
                    ->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
                    ->distinct("programmes.id")
                    ->where($where)
                    ->pluck("programmes.id");
            }
            if ($request->programme_type_id && $request->programme_type_id != '%') {
                if (count($progList)) {
                    $progList = Programme::whereIn('programmes.id', $progList)
                        ->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
                        ->where("programme_type_id", $request->programme_type_id)
                        ->where($where)->pluck('programmes.id');
                } else {
                    $progList = Programme::where("programme_type_id", $request->programme_type_id)
                        ->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
                        ->where($where)->pluck('programmes.id');
                }

            }

        }
        
        $permission = $request->permission;
        if (count($progList) > 0) {
            $programmes = $user->accessibleProgrammes($permission)->whereIn("id", $progList)->get();
        } else {
            // If no specific filters, return all accessible programmes
            $programmes = $user->accessibleProgrammes($permission);
            
            // Apply programme_type_id filter if specified
            if ($request->programme_type_id && $request->programme_type_id != '%') {
                $programmes = $programmes->where("programme_type_id", $request->programme_type_id);
            }
            
            // Apply programme_mode filter if specified
            if (!empty($where)) {
                $programmes = $programmes->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
                    ->where($where);
            }
            
            $programmes = $programmes->get();
        }

        return $programmes;
    }

    public function get_programmes(Request $request)
    {
        //
        $programmes = $this->programmes_scope($request);

        $result = "";
        if ($programmes->count() > 1)
            $result .= "<option value='%'>All Programmes In Scope</option>";

        foreach ($programmes as $programme) {
            $result .= "<option value='" . $programme->id . "'>$programme->name</option>";
        }

        return $result;
    }

    public function get_sessions()
    {
        $sessions = DB::table('session_regs')
            ->select('session')
            ->distinct()
            ->orderBy('session', 'desc')
            ->get()->pluck('session', 'session');
        $result = "";
        foreach ($sessions as $session => $session) {
            $result .= "<option value='" . $session . "'>" . $session . "/" . ($session + 1) . "</option>";
        }
        return $result;
    }

    public function get_formsessions()
    {
        $sessions = DB::table('form_settings')
            ->select('session')
            ->distinct()
            ->orderBy('session', 'desc')
            ->get()->pluck('session', 'session');
        $result = "";
        foreach ($sessions as $session => $session) {
            $result .= "<option value='" . $session . "'>" . $session . "/" . ($session + 1) . "</option>";
        }
        return $result;
    }

    public function get_levels(Request $request)
    {
        $programme_type_id = $request->query->get('progtype');
        $levels = Level::where('levels.programme_type_id', 'like', $programme_type_id)
            ->join("programme_types", "programme_types.id", "=", "levels.programme_type_id")
            ->select(["levels.*", "programme_types.short_name AS prog_short_name", "prog_type_code"]);

        if (isset($request->programme_id)) {
            $programme = Programme::find($request->programme_id);
            $levels->limit($programme->duration);
        }

        $levels = $levels->get();
//            DB::table('session_regs')
//            ->leftJoin('levels', 'session_regs.level_id', '=', 'levels.id')
//            ->leftJoin('programme_types', 'levels.programme_type_id', '=', 'programme_types.id')
//
//            ->select('level_id', 'levels.name')
//            ->distinct()
//            ->orderBy('level_id', 'asc')
//            ->get();
        // return $levels;
        $result = "";
        if ($levels->count() > 1)
            $result .= "<option value='%'>All Levels</option>";
        foreach ($levels as $level) {
            $result .= "<option value='" . $level->id . "'>" . $level->short_name . ($level->prog_type_code == "PG" ? "-" . $level->prog_short_name : "") . "</option>";
        }
        return $result;
    }

    public function get_entry_levels(Request $request)
    {
        $programme_type_id = $request->query->get('progtype');
        $levels = DB::table('students')
            ->leftJoin('levels', 'students.entry_level_id', '=', 'levels.id')
            ->leftJoin('programme_types', 'levels.programme_type_id', '=', 'programme_types.id')
            ->where('levels.programme_type_id', 'like', $programme_type_id)
            ->select(["levels.*", "programme_types.short_name AS prog_short_name", "prog_type_code"])
            ->distinct()
            ->orderBy('levels.id', 'asc')
            ->get();
        // return $levels;
        $result = "";
        if ($levels->count() > 1)
            $result .= "<option value='%'>All Levels</option>";
        foreach ($levels as $level) {
            $result .= "<option value='" . $level->id . "'>" . $level->short_name . ($level->prog_type_code == "PG" ? "-" . $level->prog_short_name : "") . "</option>";
        }
        return $result;
    }

    public function get_levels_by_course_in_dept(Request $request)
    {
        $faculty_id = $request->query->get('faculty_id');
        $dept_id = $request->query->get('department_id');
        if ($dept_id == "%") {
            $deptIds = Department::where('faculty_id', $faculty_id)->pluck('id');
        } else {
            $deptIds = [$dept_id];
        }
        $levelIds = Course::whereIn('department_id', $deptIds)->pluck('courselevel');
        $levels = Level::whereIn('levels.id', $levelIds)
            ->join("programme_types", "programme_types.id", "=", "levels.programme_type_id")
            ->select(["levels.*", "programme_types.short_name AS prog_short_name", "prog_type_code"])
            ->get();
        $result = "";
        if ($levels->count() > 1)
            $result .= "<option value='%'>All Levels</option>";
        foreach ($levels as $level) {
            $result .= "<option value='" . $level->id . "'>" . $level->short_name . ($level->prog_type_code == "PG" ? "-" . $level->prog_short_name : "") . "</option>";
        }
        return $result;
    }

    public function get_courses_by_levels_in_dept(Request $request)
    {
        $faculty_id = $request->query->get('faculty_id');
        $dept_id = $request->query->get('department_id');
        $level_id = $request->query->get('level_id');
        $inResit = $request->query->get('in_resit');
        $session = $request->query->get('session');


        if ($dept_id == "%") {
            $deptIds = Department::where('faculty_id', $faculty_id)->pluck('id');
        } else {
            $deptIds = [$dept_id];
        }
        $where = [];

        if ($level_id != "%") {
            $where[] = ["courselevel", '=', $level_id];
        }


        if ($inResit) {
            $resitCoursesIds = ResitCourse::where(['session' => $session])->where('course_id', '<>', '0')->pluck('course_id');
            $courses = Course::whereIn('department_id', $deptIds)->whereIn('id', $resitCoursesIds)->where($where)->get();
        } else {
            $courses = Course::whereIn('department_id', $deptIds)->where($where)->get();
        }


        $result = "";
//        return $courses;
        if ($courses->count() > 1)
            $result .= "<option value='%'>All Courses</option>";
        foreach ($courses as $course) {
            $result .= "<option value='" . $course->id . "'>" . $course->coursecode . "</option>";
        }
        return $result;
    }

    public function get_courses(Request $request)
    {
//        return $request->department;
        $facultyid = $request->query->get('faculty');
        $departmentid = $request->query->get('department');
        $programmetypeid = $request->query->get('progtype');
        $programmeid = $request->query->get('programme');
        $session = $request->query->get('session');
        $semester = $request->query->get('semester');
        $arropts = array();
        $arropts[] = ["course_groups.session", "=", $session];
//        if ($facultyid != '%') {
//            $arropts[] = ["faculties.id", "=", $facultyid];
//        }
        if ($departmentid != '%') {
            $arropts[] = ["departments.id", "=", $departmentid];
        }
//        if ($programmeid != '%') {
//            $arropts[] = ["programmes.id", "=", $programmeid];
//        }
//        if ($programmetypeid != '%') {
//            $arropts[] = ["programme_types.id", "=", $programmetypeid];
//        }
        if ($semester != '%') {
            $arropts[] = ["course_groups.semester", "=", $semester];
        }

        $courses = DB::table("course_registrations")
            ->leftjoin("course_groups", "course_registrations.course_group_id", "=", "course_groups.id")
            ->leftjoin("courses", "course_groups.course_id", "=", "courses.id")
            ->leftjoin("departments", "courses.department_id", "=", "departments.id")
            ->leftjoin("programmes", "programmes.department_id", "=", "departments.id")
            ->leftjoin("programme_types", "programmes.programme_type_id", "=", "programme_types.id")
            ->leftjoin("faculties", "departments.faculty_id", "=", "faculties.id")
            ->select("courses.id", "courses.coursecode")
            ->distinct()
            ->where($arropts)
            ->orderBy("courses.coursecode", "asc")
            ->get();
        $result = "";
        if ($courses->count() > 1)
            $result .= "<option value='%'>All Courses</option>";
        foreach ($courses as $course) {
            $result .= "<option value='" . $course->id . "'>" . $course->coursecode . "</option>";
        }
        return $result;

    }

    public function get_courses_by_department(Request $request)
    {

        $courses = DB::table("courses")
            ->leftjoin("departments", "courses.department_id", "=", "departments.id")
            ->select("courses.id", "courses.coursecode")
            ->distinct()
            ->where('courses.department_id', '=', $request->department_id)
            ->orderBy("courses.coursecode", "asc")
            ->get();
        $result = "";
        foreach ($courses as $course) {
            $result .= "<option value='" . $course->id . "'>" . $course->coursecode . "</option>";
        }
        return $result;

    }

    public function get_departments_by_faculty(Request $request)
    {
        //

        $departments = Department::where('faculty_id', $request->faculty_id)->get();
        $result = "";
        if ($departments->count() > 1)
            $result .= "<option value='%'>All Departments In Scope</option>";

        foreach ($departments as $department) {
            $result .= "<option value='" . $department->id . "'>$department->name</option>";
        }
        return $result;
    }

    public function get_states()
    {
        $states = DB::table('states')
            ->select('id', 'name')
            ->orderBy('name', 'asc')
            ->get();
        $result = "";
        if ($states->count() > 1)
            $result .= "<option value='%'>All States</option>";

        foreach ($states as $state) {
            $result .= "<option value='" . $state->id . "'>" . $state->name . "</option>";
        }
        return $result;
    }

    public function get_lgas(Request $request)
    {
        $lgas = DB::table('lgas')
            ->select('id', 'name')
            ->where('state_id', 'like', $request->query->get('state_id'))
            ->orderBy('name', 'asc')
            ->get();
        $result = "";
        if ($lgas->count() > 1)
            $result .= "<option value='%'>All LGAs</option>";
        foreach ($lgas as $lga) {
            $result .= "<option value='" . $lga->id . "'>" . $lga->name . "</option>";
        }
        return $result;
    }

    public function get_countries()
    {
        $countries = DB::table('countries')
            ->select('id', 'nicename')
            ->orderBy('nicename', 'asc')
            ->get();
        $result = "";
        if ($countries->count() > 1)
            $result .= "<option value='%'>All Countries</option>";
        foreach ($countries as $country) {
            $result .= "<option value='" . $country->id . "'>" . $country->nicename . "</option>";
        }
        return $result;
    }
    #[\ReturnTypeWillChange]
    public function faculties_complex_scope(Request $request)
    {
        $id = $request->id;
        $faculties = Faculty::where('complex_id', $id)->get();
        return response()->json($faculties);
    }

    public function departments_facompx_scope(Request $request)
    {
        $id = $request->id;
        $departments = Department::where('faculty_id', $id)->get();
        return response()->json($departments);
    }

    public function c_department_scope(Request $request)
    {
        //
        $user = Auth::user();
        $permission = $request->permission;
        $where = [];
        if($request->faculty_id !="0"){
            $where[] = ["faculty_id", "=", $request->faculty_id];
        }
        $faculties = Department::where($where)->get();
        $result = "";

        if ($faculties->count() > 1)
            $result .= "<option value='0'>All Departments</option>";

        foreach ($faculties as $faculty) {
                $result .= "<option value='" . $faculty->id . "'>$faculty->name</option>";
        }
        return $result;
    }
    public function c_programme_scope(Request $request)
    {
        //
        $user = Auth::user();
        $permission = $request->permission;
        $where = [];
        if($request->department_id !="0"){
            $where[] = ["department_id", "=", $request->department_id];
        }
        $faculties = Programme::where($where)->get();
        $result = "";

        if ($faculties->count() > 1)
            $result .= "<option value='0'>All Programmes</option>";

        foreach ($faculties as $faculty) {
                $result .= "<option value='" . $faculty->id . "'>$faculty->name</option>";
        }
        return $result;
    }

    public function c_level_scope(Request $request)
    {
        //
        $user = Auth::user();
        $permission = $request->permission;
        $where = [];
        $lvls = Level::query();
        if($request->programme_mode !="0"){
            $ptIds = ProgrammeType::where('prog_type_code',$request->programme_mode)->pluck('id');
            $lvls = $lvls->whereIn('programme_type_id',$ptIds);
        }
        $lvls = $lvls->get();
        $result = "";

        if ($lvls->count() > 1)
            $result .= "<option value='0'>All Levels</option>";

        foreach ($lvls as $lvl) {
                $result .= "<option value='" . $lvl->id . "'>$lvl->name</option>";
        }
        return $result;
    }
}
