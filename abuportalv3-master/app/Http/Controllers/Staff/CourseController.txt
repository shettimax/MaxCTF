<?php

namespace App\Http\Controllers\Staff;

use App\Models\Course;
use App\Models\CourseGroup;
use App\Models\Department;
use App\Models\Faculty;
use App\Http\Controllers\Controller;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Validator;
use Illuminate\Http\Request;

class CourseController extends Controller
{
    public function __construct()
    {
        $this->middleware('auth:staff');
    }

    public function index()
    {
        if ($this->access(Auth::user(), "course"))
            return view('pages.staff.settings.managecourses');
    }

    public function coursesFor($department)
    {
        try {
            $arropts = [];
            if($department!='%'){
                $arropts[] = ['department_id', '=', $department];
            }
            $records = Course::join("levels", "levels.id", "=", "courses.courselevel")
                ->join("departments", "departments.id", "=", "courses.department_id")
                ->join('faculties', 'faculties.id', '=', 'departments.faculty_id')
                ->select(['courses.*', 'levels.name as level', 'levels.id as level_id', 'faculties.id as faculty_id'])
                ->where($arropts)
                ->orderby('coursecode', 'ASC')
                ->orderby('level', 'ASC')
                ->get();

            return view('pages.staff.settings.ajax.load_courses', compact('records'));
        } catch (\Exception $e) {
            return $e->getMessage();
        }
    }

    public function show($department)
    {
        $records = Course::where('department_id', '=', $department)->orderby('coursecode', 'ASC')->orderby('coursetitle', 'ASC')->get();
        $table = "<table class='table table-bordered table-responsive' style='font-size:16px;font-family: Calibri;'>";
        $table .= "<tr><th>S/N</th><th>Course Code</th><th>Course Title</th><th>Course Unit</th><th>Semester</th><th>Level</th><th>Action</th></tr>";
        $i = 1;
        foreach ($records as $record) {
            $table .= "<tr><td>" . ($i++) . "</td><td>" . $record->coursecode . "</td><td>" . $record->coursetitle . "</td><td>" . $record->courseunit . "</td><td>" . ($record->coursesemester == 1 ? "First Semester" : "Second Semester") . "</td><td>" . $record->courselevel . "</td>";
            $table .= "<td><a href='" . route('course.edit', ['id' => $record->id]) . "'><span class='icon icon-edit2'></span> Edit</a></td></tr>";
        }
        $table .= "</table>";
        return $table;
    }

    public function store(Request $request)
    {

        try {
            //if (!$this->checkAccess(Auth::user(), 'administrator.manage.courses.create')) {
            //  return view("pages.staff.error.access");
            //}
//            return $request;
            $rules = [
                'department_id' => 'required|integer',
                'coursetitle' => 'required',
                'coursecode' => 'required|unique',
                'courseunit' => 'required',
                'coursesemester' => 'required',
            ];
            if ($request->course_id)
                $rules["coursecode"] = 'required';
            //            $validator = $request->validate($rules);

            //            if (!$validator) {
//
//                return redirect()->route('course')->withInput()->withErrors();
//            } else {
            if ($request->has('course_id')) {
                $db = Course::find($request->course_id);
                if (!$db) {
                    $db = new Course();
                }
            } else {
                $db = new Course();
            }
            $db->coursecode = $request->code;
            $db->coursetitle = $request->title;
            $db->courseunit = $request->unit;
            $db->courselevel = $request->level;
            $db->coursesemester = $request->semester;
            $db->department_id = $request->department;
            $db->save();
            if ($request->has('course_id'))
                $request->session()->flash('flash_message', 'Course has been updated');
            else
                $request->session()->flash('flash_message', 'Course has been added');
            return redirect()->back()->withInput($request->all());
            //            }
        } catch (\Exception $e) {
            //return view("pages.staff.error.technical");
            return $e->getMessage();
        }

    }

    public function edit($departmentid)
    {
        $model = Course::find($departmentid);
        //  TODO: Revisit this code block
//        return $this->checkAccessView(Auth::user(), "administrator.manage.courses.edit", view('pages.staff.settings.managecourses', compact('model')));
        return view('pages.staff.settings.managecourses', compact('model'));
    }

    public function registeredStudents()
    {
        $sessions = CourseGroup::distinct()->latest('session')->get(['session']);
        $faculties = Faculty::oldest('name')->get();
        return view('pages.staff.course.registeredstudents', compact('sessions', 'faculties'));
    }

    public function getRegisteredStudents(Request $request)
    {
        //        return $request->matric;
        try {
            $course_id = $request->course_id;
            $semester = $request->semester;
            $session = $request->input('session');
            $matric = $request->matric;
            $course = Course::find($course_id);
            $student = Course::selectRaw('students.id as student_id, CONCAT(students.surname, ", ", students.firstname, " ", IF(students.other_names IS NOT NULL,students.other_names,"")) as fullname, students.matric_number, courses.coursecode, courses.coursetitle, course_groups.semester, course_groups.session, departments.name as department, faculties.name as faculty')
                ->join('course_groups', 'course_groups.course_id', '=', 'courses.id')
                ->join('course_registrations', 'course_registrations.course_group_id', '=', 'course_groups.id')
                ->join('students', 'course_registrations.student_id', '=', 'students.id')
                ->join('departments', 'courses.department_id', '=', 'departments.id')
                ->join('faculties', 'departments.faculty_id', '=', 'faculties.id')
                ->where('course_groups.semester', $semester)
                ->where('course_groups.session', $session)
                ->where('courses.id', $course_id)
                ->where('students.matric_number', $matric)
                ->first();
            return view('pages.staff.course.registeredstudentlist', compact('student', 'course', 'semester', 'session'));
        } catch (\Exception $e) {
            return $e->getMessage();
        }
    }
}
