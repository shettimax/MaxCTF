<?php

namespace App\Http\Controllers\Staff;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;

use DataTables;
use App\Models\Faculty;
use App\Models\Department;
use Illuminate\Support\Facades\DB;
use Auth;
use Mockery\Exception;
use Symfony\Component\HttpFoundation\JsonResponse;
use App\Models\CandidateOlevel;
use App\Models\CandidateAlevel;
use App\Models\Qualification;
use App\Models\QualificationGrade;
use PdfReport;
use ExcelReport;
use PDF;

class AllCandidateReportController extends Controller
{
    public function __construct()
    {
        $this->middleware(['auth:staff']);
        //$this->middleware(['permission:super-admin']);
    }

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */

    public function candidates(Request $request)
    {
        $candidates = array();
        if ($request->ajax()) {
            $facultyid = $request->query->get('faculty');
            $departmentid = $request->query->get('department');
            $programmetypeid = $request->query->get('progtype');
            $programmeid = $request->query->get('programme');
            $session = $request->query->get('session');
            $paymentstatus = $request->query->get('paystatus');
            $submissionstatus = $request->query->get('submissionstatus');
            $arropts = [
                ["form_settings.session", "=", $session],
                ["transactions.code", "=", "FRM"],
            ];
            if ($facultyid != '%') {
                $arropts[] = ["faculties.id", "=", $facultyid];
            }
            if ($departmentid != '%') {
                $arropts[] = ["departments.id", "=", $departmentid];
            }
            if ($programmetypeid != '%') {
                $arropts[] = ["programme_types.id", "=", $programmetypeid];
            }
            if ($programmeid != '%') {
                $arropts[] = ["programmes.id", "=", $programmeid];
            }
            if ($paymentstatus != '%') {
                $arropts[] = ["transactions.paymentstatus", "=", $paymentstatus];
            }


            $query = DB::table("candidate_forms")
                ->join("transactions", "transactions.student_id", "=", "candidate_forms.id")
                ->join("candidates", "candidates.id", "=", "candidate_forms.candidate_id")
                ->join("candidate_biodatas AS bio", "candidates.id", "=", "bio.candidateid")
                ->join("candidate_contacts AS contact", "candidates.id", "=", "contact.candidateid")
                ->join("form_settings", "form_settings.id", "=", "candidate_forms.formsetting_id")
                ->leftJoin("programmes", "form_settings.programmeid", "=", "programmes.id")
                ->leftJoin("programme_types", "programme_types.id", "=", "programmes.programmetypeid")
                ->leftJoin("departments", "programmes.departmentid", "=", "departments.id")
                ->leftJoin("faculties", "departments.facultyid", "=", "faculties.id")
                ->join("lgas", "lgas.id", "=", "bio.lgaid")
                ->join("states", "states.id", "=", "lgas.stateid")
                ->leftJoin("candidate_olevels", "candidate_olevels.candidateid", "=", "candidates.id")
                ->leftJoin("candidate_alevels", "candidate_alevels.candidateid", "=", "candidates.id")
                ->leftJoin("qualifications", "qualifications.id", "=", "candidate_alevels.qualificationid")
                ->leftJoin("qualification_grades", "qualification_grades.id", "=", "candidate_alevels.degreeclassid")
                ->select([""])
                ->where("transactions.code", "=", "FRM")
                ->where("form_settings.session", "=", $session)
                ->leftJoin("countries", "countries.id", "=", "bio.countryid");


            $columnsquery = $query->select(["candidate_forms.id as appId", "email",
                DB::raw("CONCAT(firstname,' ',IFNULL(othernames, ''),' ',surname)  AS fullname"),
                "gender",
                "dateofbirth",
                "admissionstatus",
                "programmes.name AS programme",
                "departments.name AS department",
                "transactions.rrr", "transactions.code", "states.statename as state",
                "transactions.transamount as amount",
                "transactions.paymentstatus",
                "faculties.name AS faculty", "maritalstatus", "gsm",
                "form_settings.session","form_settings.candidate_form_type_id",
                "candidate_forms.jamb_score",'candidate_forms.school_attended',
                DB::raw("GROUP_CONCAT(DISTINCT CONCAT(subjectcode, ' - ', gradecode) ORDER BY subjectcode DESC SEPARATOR ', ') AS olevel"),
                DB::raw("GROUP_CONCAT(DISTINCT CONCAT(qualifications.qualification, ' ',candidate_alevels.course, ' ', candidate_alevels.institutionname, ' ', toyear, ' ',qualification_grades.grade) SEPARATOR ', ') AS alevel")
            ])
                ->groupBy(["transactions.student_id", "bio.surname", "bio.firstname", "bio.othernames", "bio.gender", "bio.date_of_birth", "transactions.rrr", "transactions.transamount", "transactions.paymentstatus", "transactions.code", "bio.maritalstatus", "contact.gsm", "bio.placeofbirth", "bio.hometown", "bio.countryid", "bio.lgaid", "states.statename"]);

            $columnsquery = $columnsquery->where($arropts);
            //$wherequeryTotalamount = $query->where($arropts);
            if ($submissionstatus == "Submitted") {
                $columnsquery = $columnsquery->whereNotNull("datetimesubmitted");
                //$wherequeryTotalamount = $wherequeryTotalamount->whereNotNull("datetimesubmitted");
            } elseif ($submissionstatus == "Not Submitted") {
                $columnsquery = $columnsquery->whereNull("datetimesubmitted");
                // $wherequeryTotalamount = $wherequeryTotalamount->whereNull("datetimesubmitted");
            } elseif ($submissionstatus == "%") {
                $columnsquery = $columnsquery->whereNotNull("datetimesubmitted")
                    ->orWhereNull("datetimesubmitted");
                //$wherequeryTotalamount = $wherequeryTotalamount->whereNotNull("datetimesubmitted")
                // ->orWhereNull("datetimesubmitted");
            }

            $columnsquery = $columnsquery->orderBy("faculties.name")
                ->orderBy("departments.name")->orderBy("programme_types.progtypename")->orderBy("programmes.name")->orderBy("transactions.student_id")->orderBy("surname");

            $candidates = $columnsquery->get();

            $totalamount = 0;// $columnsquery->sum('transactions.transamount');

            return view('pages.staff.reports.candidates.load_data', compact('candidates', 'totalamount'))->render();
        }


        return view('pages.staff.reports.candidates.index', compact('candidates', 'totalamount'));

        //print_r($totalamount);


    }

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */

    public function admission(Request $request)
    {

        $candidates = array();
        //if ($request->ajax()) {
        $facultyid = $request->query->get('faculty');
        $departmentid = $request->query->get('department');
        $programmetypeid = $request->query->get('progtype');
        $programmeid = $request->query->get('programme');
        $session = $request->query->get('session');
        $admissionstatus = $request->query->get('admissionstatus');
        $arropts = [
            ["form_settings.session", "=", $session],
            ["transactions.code", "=", "FRM"],
        ];
        if ($facultyid != '%') {
            $arropts[] = ["faculties.id", "=", $facultyid];
        }
        if ($departmentid != '%') {
            $arropts[] = ["departments.id", "=", $departmentid];
        }
        if ($programmetypeid != '%') {
            $arropts[] = ["programme_types.id", "=", $programmetypeid];
        }
        if ($programmeid != '%') {
            $arropts[] = ["programmes.id", "=", $programmeid];
        }
        if ($admissionstatus != '%') {
            $arropts[] = ["admissionstatus", "=", $admissionstatus];
        }


        $query = DB::table("candidate_form")
            ->join("transactions", "transactions.student_id", "=", "candidate_forms.id")
            ->where("transactions.code", "=", "FRM")
            ->join("candidates", "candidates.id", "=", "candidate_forms.candidate_id")
            ->join("candidate_biodatas AS bio", "candidates.id", "=", "bio.candidateid")
            ->join("candidate_contacts AS contact", "candidates.id", "=", "contact.candidateid")
            ->join("form_settings", "form_settings.id", "=", "candidate_forms.formsetting_id")
            ->where("form_settings.session", "=", $session)
            ->leftJoin("programmes", "form_settings.programmeid", "=", "programmes.id")
            ->leftJoin("programme_types", "programme_types.id", "=", "programmes.programmetypeid")
            ->leftJoin("departments", "programmes.departmentid", "=", "departments.id")
            ->leftJoin("faculties", "departments.facultyid", "=", "faculties.id")
            ->join("lgas", "lgas.id", "=", "bio.lgaid")
            ->join("states", "states.id", "=", "lgas.stateid")
            ->leftJoin("candidate_olevels", "candidate_olevels.candidateid", "=", "candidates.id")
            ->leftJoin("candidate_alevels", "candidate_alevels.candidateid", "=", "candidates.id")
            ->leftJoin("qualifications", "qualifications.id", "=", "candidate_alevels.qualificationid")
            ->leftJoin("qualification_grades", "qualification_grades.id", "=", "candidate_alevels.degreeclassid")
            ->leftJoin("countries", "countries.id", "=", "bio.countryid");

        $columnsquery = $query->select(["candidate_forms.id as appId", "email",
            DB::raw("CONCAT(firstname,' ',IFNULL(othernames, ''),' ',surname)  AS fullname"),
            "gender",
            "dateofbirth",
            "admissionstatus",
            "programmes.name AS programme",
            "departments.name AS department",
            "transactions.rrr", "transactions.code", "states.statename as state",
            "faculties.name AS faculty", "maritalstatus", "gsm",
            "form_settings.session",
            DB::raw("GROUP_CONCAT(DISTINCT CONCAT(subjectcode, ' - ', gradecode) ORDER BY subjectcode DESC SEPARATOR ', ') AS olevel"),
            DB::raw("GROUP_CONCAT(DISTINCT CONCAT(qualifications.qualification, ' ',candidate_alevels.course, ' ', candidate_alevels.institutionname, ' ', toyear, ' ',qualification_grades.grade) SEPARATOR ', ') AS alevel")
        ])
            ->groupBy(["transactions.student_id", "bio.surname", "bio.firstname", "bio.othernames", "bio.gender", "bio.dateofbirth", "transactions.rrr", "transactions.transamount", "transactions.paymentstatus", "transactions.code", "bio.maritalstatus", "contact.gsm", "bio.placeofbirth", "bio.hometown", "bio.countryid", "bio.lgaid", "states.statename", "admissionstatus"]);

        $columnsquery = $columnsquery->where($arropts);

        $columnsquery = $columnsquery->orderBy("faculties.name")
            ->orderBy("departments.name")->orderBy("programme_types.progtypename")->orderBy("programmes.name")->orderBy("transactions.studentid")->orderBy("surname");

        $candidates = $columnsquery->get();

        return view('pages.staff.reports.candidates.load_admission_data', compact('candidates'))->render();
        //}

        return view('pages.staff.reports.candidates.admission', compact('candidates'));

    }

    public function flashdrives(Request $request)
    {
        try {
            $students = array();
                 if ($request->ajax()) {
            $facultyid = $request->query->get('faculty');
            $departmentid = $request->query->get('department');
            $programmetypeid = $request->query->get('progtype');
            $programmeid = $request->query->get('programme');
            $session = $request->query->get('session');
            $collectionstatus = $request->query->get('collection_status');
            $progmode = $request->query->get('programme_mode');

            $arropts = [];

            /*if ($progmode != "%") {
                $arropts [] = ['programme_types.prog_type_code', '=', $progmode];
            }*/

            if ($facultyid != '%') {
                $arropts[] = ["faculties.id", "=", $facultyid];
            }

            if ($collectionstatus != '%') {
                $arropts[] = ["publications.epublication", "=", $collectionstatus];
            }

            if ($departmentid != '%') {
                $arropts[] = ["departments.id", "=", $departmentid];
            }
            if ($programmetypeid != '%') {
                $arropts[] = ["programme_types.id", "=", $programmetypeid];
            }
            if ($programmeid != '%') {
                $arropts[] = ["programmes.id", "=", $programmeid];
            }
            if ($session != '%') {
                $arropts[] = ["students.entry_session", "=", $session];

            }
            $arropts[] = ["students.mode_of_entry", "=", $progmode];

//return $arropts;
            $query = DB::table("students")
                ->join("publications", "publications.student_id", "=", "students.id")
                // ->where("publications.epublication", "=", $collectionstatus)
                ->leftJoin("programmes", "programmes.id", "=", "students.programme_id")
                ->leftJoin("programme_types", "programme_types.id", "=", "programmes.programme_type_id")
                ->leftJoin("departments", "programmes.department_id", "=", "departments.id")
                ->leftJoin("faculties", "departments.faculty_id", "=", "faculties.id");


            $columnsquery = $query->select([
                DB::raw("CONCAT(students.firstname,' ',IFNULL(students.other_names, ''),' ',students.surname)  AS fullname"),
                "publications.epublication AS status",
                "publications.student_id",
                DB::raw('COUNT(status) AS numberofdrives'),
                "programmes.name AS programme",
                "departments.name AS department",
                "faculties.name AS faculty",
                "students.entry_session AS session"
            ])
                ->groupBy(["student_id","status"]);

            $columnsquery = $columnsquery->where($arropts);

            $columnsquery = $columnsquery->orderBy("faculties.name")
                ->orderBy("departments.name")->orderBy("programme_types.prog_type_name")->orderBy("programmes.name")->orderBy("students.surname");

            $students = $columnsquery->get();

            $arrstudents = [];

            foreach ($students as $student) {
                $status = $student->status;
                $arrstudents[$student->student_id][$status] = $student->numberofdrives;
            }


            return view('pages.staff.reports.candidates.load_flashdrive_data', compact('students', 'arrstudents'))->render();
      }

            return view('pages.staff.reports.candidates.flash', compact('students'));

        } catch (Exception $e) {
            return $e->getMessage();
        }
    }


    /*
     use App\Models\Student;
use App\Models\LibraryRecord;

$statistics = Student::select('students.id as student_id', 'students.name as student_name')
    ->leftJoin('library_records', 'students.id', '=', 'library_records.student_id')
    ->selectRaw('COUNT(DISTINCT CASE WHEN library_records.collected = 1 THEN library_records.book_id END) as books_collected_count')
    ->selectRaw('COUNT(DISTINCT CASE WHEN library_records.collected = 0 THEN library_records.book_id END) as books_not_collected_count')
    ->groupBy('students.id', 'students.name')
    ->orderBy('students.id')
    ->get();

return view('your.view.name', compact('statistics'));
@foreach($statistics as $student)
    <div>
        <h4>Student ID: {{ $student->student_id }}</h4>
        <p>Name: {{ $student->student_name }}</p>
        <p>Books Collected: {{ $student->books_collected_count }}</p>
        <p>Books Not Collected: {{ $student->books_not_collected_count }}</p>
        <hr>
    </div>
@endforeach

     */


    public function screening(Request $request)
    {
        try {
            $user = Auth::user();
            $students = array();
            if ($request->ajax()) {
                $facultyid = $request->query->get('faculty');
                $departmentid = $request->query->get('department');
                $programmetypeid = $request->query->get('progtype');
                $programmeid = $request->query->get('programme');
                $session = $request->query->get('session');
                $screeningstatus = $request->query->get('screening_status');

                $arropts = [];

                if ($request->programme_mode != "%") {
                    $arropts [] = ['prog_type_code', '=', $request->programme_mode];
                }
                if ($facultyid != '%') {
                    $arropts[] = ["faculties.id", "=", $facultyid];
                }
                if ($departmentid != '%') {
                    $arropts[] = ["departments.id", "=", $departmentid];
                }
                if ($programmetypeid != '%') {
                    $arropts[] = ["programme_types.id", "=", $programmetypeid];
                }
                if ($programmeid != '%') {
                    $arropts[] = ["programmes.id", "=", $programmeid];
                }
                if ($screeningstatus != '%') {
                    $arropts[] = ["screening_status", "=", $screeningstatus];
                }
                if ($session != '%') {
                    $arropts[] = ["session", "=", $session];
                }
                //return $arropts;
                $query = DB::table("candidate_forms")
                    ->leftJoin("candidates", "candidates.id", "=", "candidate_forms.candidate_id")
                    ->join("form_settings", "form_settings.id", "=", "candidate_forms.form_setting_id")
                    ->join("candidate_biodatas", "candidate_biodatas.candidate_id", "=", "candidate_forms.candidate_id")
                    ->leftJoin("programmes", "programmes.id", "=", "candidate_forms.programme_admitted_id")
                    ->leftJoin("programme_types", "programme_types.id", "=", "programmes.programme_type_id")
                    ->leftJoin("departments", "programmes.department_id", "=", "departments.id")
                    ->leftJoin("faculties", "departments.faculty_id", "=", "faculties.id")
                    ->leftJoin("candidate_contacts", "candidate_contacts.candidate_id", "=", "candidates.id")
                    ->leftJoin("users", "users.id", "=", "candidate_forms.screened_by")
                    ->leftJoin("employees", "employees.id", "=", "users.employee_id");

                $columnsquery = $query->select([
                    DB::raw("CONCAT(candidate_biodatas.firstname,' ',IFNULL(candidate_biodatas.othernames, ''),' ',candidate_biodatas.surname)  AS fullname"),
                    "programmes.name AS programme",
                    "programmes.name AS department",
                    "faculties.name AS faculty",
                    "session",
                    "candidate_forms.id AS appno",
                    "employees.personnel_no",
                    DB::raw("CONCAT(employees.firstname,' ',IFNULL(employees.othernames, ''),' ',employees.surname)  AS screenby"),
                    "candidates.email", "candidate_contacts.gsm",
                    "candidate_forms.screening_status AS status"
                ])
                    ->groupBy(["fullname", "programme", "department", "faculty", "session", "status"]);

                $columnsquery = $columnsquery->where($arropts);

                $columnsquery = $columnsquery->orderBy("faculties.name")
                    ->orderBy("departments.name")
                    ->orderBy("programme_types.prog_type_name")
                    ->orderBy("programmes.name")
                    ->orderBy("candidate_biodatas.surname");


                $students = $columnsquery->whereIn('programmes.id', $user->accessibleProgrammes('reports.candidate.screen')->pluck('programmes.id'))->get();

                return view('pages.staff.reports.candidates.load_screening_data', compact('students'))->render();
            }

            return view('pages.staff.reports.candidates.screen', compact('students'));

        } catch (Exception $e) {
            return $e->getMessage();
        }
    }

    public function exportPDF(Request $request)
    {
        $facultyid = $request->query->get('faculty');
        $departmentid = $request->query->get('department');
        $programmetypeid = $request->query->get('progtype');
        $programmeid = $request->query->get('programme');
        $session = $request->query->get('session');
        $paymentstatus = $request->query->get('paystatus');
        $submissionstatus = $request->query->get('submissionstatus');
        $arropts = [
            ["form_settings.session", "=", $session],
            ["transactions.code", "=", "FRM"],
        ];
        if ($facultyid != '%') {
            $arropts[] = ["faculties.id", "=", $facultyid];
        }
        if ($departmentid != '%') {
            $arropts[] = ["departments.id", "=", $departmentid];
        }
        if ($programmetypeid != '%') {
            $arropts[] = ["programme_types.id", "=", $programmetypeid];
        }
        if ($programmeid != '%') {
            $arropts[] = ["programmes.id", "=", $programmeid];
        }
        if ($paymentstatus != '%') {
            $arropts[] = ["transactions.paymentstatus", "=", $paymentstatus];
        }
//echo $facultyid;
        $facultyName = 'Physical Sciences';// Faculty::getFaculty($facultyid)->pluck('name');
        $departmentName = 'Computer Science';// Department::getDepartment($departmentid)->pluck('name');
        $programmeName = 'Computer Science'; //Programme::getProgramme($programmeid)->pluck('name');

        $title = 'Applicants Report'; // Report title

        $meta = [ // For displaying filters description on header
            'Faculty: ' . $facultyName . 'Department: ' . $departmentName . 'Programme: '
            . $programmeName
        ];

        $query = DB::table("candidate_forms")
            ->join("transactions", "transactions.student_id", "=", "candidate_forms.id")
            ->join("candidates", "candidates.id", "=", "candidate_forms.candidate_id")
            ->join("candidate_biodatas AS bio", "candidates.id", "=", "bio.candidateid")
            ->join("candidate_contacts AS contact", "candidates.id", "=", "contact.candidateid")
            ->join("form_settings", "form_settings.id", "=", "candidate_forms.formsetting_id")
            ->leftJoin("programmes", "form_settings.programmeid", "=", "programmes.id")
            ->leftJoin("programme_types", "programme_types.id", "=", "programmes.programmetypeid")
            ->leftJoin("departments", "programmes.departmentid", "=", "departments.id")
            ->leftJoin("faculties", "departments.facultyid", "=", "faculties.id")
            ->join("lgas", "lgas.id", "=", "bio.lgaid")
            ->join("states", "states.id", "=", "lgas.stateid")
            ->leftJoin("candidate_olevels", "candidate_olevels.candidateid", "=", "candidates.id")
            ->leftJoin("candidate_alevels", "candidate_alevels.candidateid", "=", "candidates.id")
            ->leftJoin("qualifications", "qualifications.id", "=", "candidate_alevels.qualificationid")
            ->leftJoin("qualification_grades", "qualification_grades.id", "=", "candidate_alevels.degreeclassid")
            ->leftJoin("countries", "countries.id", "=", "bio.countryid");

//DB::raw("@serialnum  := @serialnum  + 1 AS serialnum")

        $query = $query->select(["candidates.id as appId", "email",
            DB::raw("CONCAT(surname,' ',firstname,' ',IFNULL(othernames, ''))  AS fullname"), "gender",
            "dateofbirth", "programmes.name AS programme", "departments.name AS department", "transactions.rrr", "transactions.code", "states.statename AS state",
            "transactions.transamount as amount", "transactions.paymentstatus",
            "faculties.name AS faculty", "maritalstatus", "gsm", "form_settings.session", DB::raw("GROUP_CONCAT(DISTINCT CONCAT(subjectcode, ' - ', gradecode) ORDER BY subjectcode DESC SEPARATOR ', ') AS olevel"),
            DB::raw("GROUP_CONCAT(DISTINCT CONCAT(qualifications.qualification, ' ',candidate_alevels.course, ' ', candidate_alevels.institutionname, ' ', toyear, ' ',qualification_grades.grade) SEPARATOR ', ') AS alevel")])
            ->groupBy("transactions.student_id");

        $query = $query->where($arropts);
        if ($submissionstatus == "Submitted")
            $query = $query->whereNotNull("datetimesubmitted");
        elseif ($submissionstatus == "Not Submitted")
            $query = $query->whereNull("datetimesubmitted");
        elseif ($submissionstatus == "%")
            $query = $query->whereNotNull("datetimesubmitted")
                ->orWhereNull("datetimesubmitted");

        $query = $query->orderBy("faculties.id")
            ->orderBy("departments.id")->orderBy("programme_types.id")->orderBy("programmes.id")->orderBy("transactions.student_id")->orderBy("surname");

        //  dd($query->toSql());

        $columns = [ // Set Column to be displayed
            'Candidate ID' => function ($candidate) {
                return (str_pad($candidate->appId, 9, '0', STR_PAD_LEFT) . $candidate->session);
            },
            'Name' => 'fullname',
            'Faculty' => 'faculty',
            'Department' => 'department',
            'Programme' => 'programme',
            'Payment Status' => 'paymentstatus',
            'Amount' => 'amount',
            'RRR' => function ($result) {
                return (is_null($result->rrr)) ? 'Not Paid' : $result->rrr;
            },
            'RRR' => 'rrr',
            'Gender' => 'gender',
            'Date of Birth' => 'dateofbirth',
            'Mobile No.' => 'gsm',
            'Email' => 'email',
            'O-Levels' => 'olevel',
            'A-Levels' => 'alevel'
        ];

        // Generate Report with flexibility to manipulate column class even manipulate column value (using Carbon, etc).
        return PdfReport::of($title, $meta, $query, $columns)
            ->showTotal([ // Used to sum all value on specified column on the last table (except using groupBy method). 'point' is a type for displaying total with a thousand separator
                'Amount' => 'point' // if you want to show dollar sign ($) then use 'Total Balance' => '$'
            ])
            // ->limit(20) // Limit record to be showed
            ->setCss([
                '.head-content' => 'border-width: 1px',
            ])
            ->download('applicants');  // other available method: download('filename') to download pdf / make() that will producing DomPDF / SnappyPdf instance so you could do any other DomPDF / snappyPdf method such as stream() or download()

        /* return PdfReport::of($title, $meta, $query, $columns)
            ->make()
            ->getDomPDF()
            ->output_html(); */

        // other available method: download('filename') to download pdf / make() that will producing DomPDF / SnappyPdf instance so you could do any other DomPDF / snappyPdf method such as stream() or download()

    }//Note: For downloading to excel / CSV, just change PdfReport facade to ExcelReport / CSVReport facade with no more modifications

    public function exportExcel(Request $request)
    {
        $facultyid = $request->query->get('faculty');
        $departmentid = $request->query->get('department');
        $programmetypeid = $request->query->get('progtype');
        $programmeid = $request->query->get('programme');
        $session = $request->query->get('session');
        $paymentstatus = $request->query->get('paystatus');
        $submissionstatus = $request->query->get('submissionstatus');
        $arropts = [
            ["form_settings.session", "=", $session],
            ["transactions.code", "=", "FRM"],
        ];
        if ($facultyid != '%') {
            $arropts[] = ["faculties.id", "=", $facultyid];
        }
        if ($departmentid != '%') {
            $arropts[] = ["departments.id", "=", $departmentid];
        }
        if ($programmetypeid != '%') {
            $arropts[] = ["programme_types.id", "=", $programmetypeid];
        }
        if ($programmeid != '%') {
            $arropts[] = ["programmes.id", "=", $programmeid];
        }
        if ($paymentstatus != '%') {
            $arropts[] = ["transactions.paymentstatus", "=", $paymentstatus];
        }
//echo $facultyid;
        $facultyName = 'Physical Sciences';// Faculty::getFaculty($facultyid)->pluck('name');
        $departmentName = 'Computer Science';// Department::getDepartment($departmentid)->pluck('name');
        $programmeName = 'Computer Science'; //Programme::getProgramme($programmeid)->pluck('name');

        $title = 'Applicants Report'; // Report title

        $meta = [ // For displaying filters description on header
            'Faculty: ' . $facultyName . 'Department: ' . $departmentName . 'Programme: '
            . $programmeName
        ];

        $query = DB::table("candidate_forms")
            ->join("transactions", "transactions.student_id", "=", "candidate_forms.id")
            ->join("candidates", "candidates.id", "=", "candidate_forms.candidate_id")
            ->join("candidate_biodatas AS bio", "candidates.id", "=", "bio.candidateid")
            ->join("candidate_contacts AS contact", "candidates.id", "=", "contact.candidateid")
            ->join("form_settings", "form_settings.id", "=", "candidate_forms.formsetting_id")
            ->leftJoin("programmes", "form_settings.programmeid", "=", "programmes.id")
            ->leftJoin("programme_types", "programme_types.id", "=", "programmes.programmetypeid")
            ->leftJoin("departments", "programmes.departmentid", "=", "departments.id")
            ->leftJoin("faculties", "departments.facultyid", "=", "faculties.id")
            ->leftJoin("lgas", "lgas.id", "=", "bio.lgaid")
            ->leftJoin("states", "states.id", "=", "lgas.stateid")
            ->leftJoin("candidate_olevels", "candidate_olevels.candidateid", "=", "candidates.id")
            ->leftJoin("candidate_alevels", "candidate_alevels.candidateid", "=", "candidates.id")
            ->leftJoin("qualifications", "qualifications.id", "=", "candidate_alevels.qualificationid")
            ->leftJoin("qualification_grades", "qualification_grades.id", "=", "candidate_alevels.degreeclassid")
            ->leftJoin("countries", "countries.id", "=", "bio.countryid");

//DB::raw("@serialnum  := @serialnum  + 1 AS serialnum")

        $query = $query->select(["candidates.id as appId", "email",
            DB::raw("CONCAT(surname,' ',firstname,' ',IFNULL(othernames, ''))  AS fullname"), "gender",
            "dateofbirth", "programmes.name AS programme", "departments.name AS department", "transactions.rrr", "transactions.code",
            "transactions.transamount as amount", "transactions.paymentstatus",
            "faculties.name AS faculty", "maritalstatus", "gsm", "form_settings.session", DB::raw("GROUP_CONCAT(DISTINCT CONCAT(subjectcode, ' - ', gradecode) ORDER BY subjectcode DESC SEPARATOR ', ') AS olevel"),
            DB::raw("GROUP_CONCAT(DISTINCT CONCAT(qualifications.qualification, ' ',candidate_alevels.course, ' ', candidate_alevels.institutionname, ' ', toyear, ' ',qualification_grades.grade) SEPARATOR ', ') AS alevel")])
            ->groupBy("transactions.student_id");

        $query = $query->where($arropts);
        if ($submissionstatus == "Submitted")
            $query = $query->whereNotNull("datetimesubmitted");
        elseif ($submissionstatus == "Not Submitted")
            $query = $query->whereNull("datetimesubmitted");
        elseif ($submissionstatus == "%")
            $query = $query->whereNotNull("datetimesubmitted")
                ->orWhereNull("datetimesubmitted");

        $query = $query->orderBy("faculties.id")
            ->orderBy("departments.id")->orderBy("programme_types.id")->orderBy("programmes.id")->orderBy("transactions.student_id")->orderBy("surname");

        //  dd($query->toSql());

        $columns = [ // Set Column to be displayed
            'Candidate ID' => function ($candidate) {
                return (str_pad($candidate->appId, 9, '0', STR_PAD_LEFT) . $candidate->session);
            },
            'Name' => 'fullname',
            'Faculty' => 'faculty',
            'Department' => 'department',
            'Programme' => 'programme',
            'Payment Status' => 'paymentstatus',
            'Amount' => 'amount',
            'RRR' => function ($result) {
                return (is_null($result->rrr)) ? 'Not Paid' : $result->rrr;
            },
            'RRR' => 'rrr',
            'Gender' => 'gender',
            'Date of Birth' => 'dateofbirth',
            'Mobile No.' => 'gsm',
            'Email' => 'email',
            'O-Levels' => 'olevel',
            'A-Levels' => 'alevel'
        ];

        // Generate Report with flexibility to manipulate column class even manipulate column value (using Carbon, etc).
        return ExcelReport::of($title, $meta, $query, $columns)
            ->showTotal([ // Used to sum all value on specified column on the last table (except using groupBy method). 'point' is a type for displaying total with a thousand separator
                'Amount' => 'point' // if you want to show dollar sign ($) then use 'Total Balance' => '$'
            ])
            ->download('file'); // other available method: download('filename') to download pdf / make() that will producing DomPDF / SnappyPdf instance so you could do any other DomPDF / snappyPdf method such as stream() or download()
    } //Note: For downloading to excel / CSV, just change PdfReport facade to ExcelReport / CSVReport facade with no more modifications

    public function getFaculties()
    {
        $faculties = Faculty::where([
            ['is_other_institute', '=', 2],
        ]);

        $faculties = $faculties->select('id', 'name')
            ->orderBy('name', 'asc')->get();
        //  dd($faculties->count());
        //  exit();
        $result = "";

        if ($faculties->count() > 1)
            $result .= "<option value='%'>All Faculties</option>";

        foreach ($faculties as $faculty) {
            $result .= "<option value='" . $faculty->id . "'>$faculty->name</option>";
        }
        return $result;

    }

    public function getDepartments(Request $request)
    {
        $userid = 'P19593';// get the value from session
        $usergroupid = 3; // get the value from session
        $user = Auth::user();
        $department = $user->department()->first();

        // $departmentid = DB::table("employees")
        //     ->join('departments', 'departments.id', '=', 'employees.department_id')
        //     ->select('departments.id as departmentid')
        //     ->where('employees.employeeid', '=', $userid)
        //     ->get()->pluck('departmentid')->toArray();

        if ($usergroupid == 3) //Deans, ...
            $departments = Department::where([
                ['departments.faculty_id', 'like', $request->input('faculty_id')],
                ['departments.depttype', '=', 2]
            ]);
        else //HoDs, ...
            $departments = Department::where([
                ['departments.faculty_id', 'like', $request->input('faculty_id')],
                ['departments.id', 'like', $department->id],
                ['departments.depttype', '=', 2]
            ]);

        $departments = $departments->select('departments.id', 'departments.name')
            ->join('faculties', 'faculties.id', 'departments.faculty_id')
            ->orderBy('name', 'asc')
            ->get();

        $result = "";
        if ($departments->count() > 1)
            $result .= "<option value='%'>All Departments</option>";

        foreach ($departments as $department) {
            $result .= "<option value='" . $department->id . "'>$department->name</option>";
        }
        return $result;

    }

    public function getProgrammes(Request $request)
    {
        $programmes = DB::table('programmes')
            ->join('programme_types', 'programmes.programmetypeid', '=', 'programme_types.id')
            ->join('departments', 'programmes.departmentid', '=', 'departments.id')
            ->join('faculties', 'faculties.id', '=', 'departments.faculty_id')
            ->where([
                ['departments.faculty_id', 'like', $request->input('faculty_id')],
                ['programmes.departmentid', 'like', $request->input('departmentid')],
                ['programmes.programmetypeid', 'like', $request->input('programmetypeid')],
            ])
            ->select('programmes.id as id', 'programmes.name as name')
            ->orderBy('programmes.name', 'asc')
            ->get();

        $result = "";
        if ($programmes->count() > 1)
            $result .= "<option value='%'>All Programmes</option>";

        foreach ($programmes as $programme) {
            $result .= "<option value='" . $programme->id . "'>$programme->name</option>";
        }

        return $result;

    }

    public function getProgrammeTypes(Request $request)
    {
        $userid = 'P19593';// get the value from session
        $usergroupid = 3; // get the value from session

        // $departmentid = DB::table("employees")
        //     ->join('departments', 'departments.id', '=', 'employees.department_id')
        //     ->select('departments.id as departmentid')
        //     ->where('employees.employeeid', '=', $userid)
        //     ->get()->pluck('departmentid')->toArray();
        $user = Auth::user();
        $department = $user->department()->first();

        if ($usergroupid == 3)
            $programmetypes = DB::table('programme_types')
                ->join('programmes', 'programme_types.id', '=', 'programmes.programmetypeid')
                //->where('programmes.departmentid', 'like', $department->id)
                ->select('programme_types.id as id', 'programme_types.progtypename as name')
                ->groupBy('programme_types.id')
                ->orderBy('programme_types.progtypename', 'asc')
                ->get();
        else //HoD, ...
            $programmetypes = DB::table('programme_types')
                ->join('programmes', 'programme_types.id', '=', 'programmes.programmetypeid')
                ->where('programmes.departmentid', 'like', $department->id)
                ->select('programme_types.id as id', 'programme_types.progtypename as name')
                ->groupBy('programme_types.id')
                ->orderBy('programme_types.progtypename', 'asc')
                ->get();

        $result = "";
        if ($programmetypes->count() > 1)
            $result .= "<option value='%'>All Programme Types</option>";

        foreach ($programmetypes as $programmetype) {
            $result .= "<option value='" . $programmetype->id . "'>$programmetype->name</option>";
        }
        return $result;
    }

    public function getSessions()
    {
        $sessions = DB::table('form_settings')
            ->select('session')
            ->distinct()
            ->orderBy('session', 'desc')
            ->get()->pluck('session', 'session');
        $result = "";
        foreach ($sessions as $session => $session) {
            $result .= "<option value='" . $session . "'>" . $session . "/" . ($session + 1) . "</option>";
        }
        return $result;
    }

    public function getPayStatus()
    {
        $paystatus = DB::table('candidate_forms')
            ->select('paymentstatus')
            ->distinct()
            ->orderBy('paymentstatus', 'asc')
            ->get()->pluck('paymentstatus', 'paymentstatus');
        $result = "";

        if ($paystatus->count() > 1)
            $result .= "<option value='%'>All Payment Status</option>";

        foreach ($paystatus as $paymentstatus => $paymentstatus) {
            $result .= "<option value='" . $paymentstatus . "'>" . $paymentstatus . "</option>";
        }
        return $result;
    }

    public function catCandidates()
    {
        return view("pages.staff.reports.candidates.applied_cat");
    }

    public function candidatesCat(Request $request)
    {
        try {
            \Log::info('Candidate Category Report Request Started');
            
            
            $candidates = array();
            $facultyid = $request->query->get('faculty');
            $departmentid = $request->query->get('department');
            $programmetypeid = $request->query->get('progtype');
            $programmeid = $request->query->get('programme');
            $session = $request->query->get('session');
            $paymentstatus = $request->query->get('payment_status');
            
            // Log parameters for debugging
            \Log::info('Report Parameters', [
                'faculty' => $facultyid,
                'department' => $departmentid,
                'session' => $session,
                'payment_status' => $paymentstatus
            ]);

            $arropts = [
                ["transactions.code", "=", "FRM"],
            ];
            
            // Only add session filter if session is provided
            if (!empty($session) && $session != '%') {
                $arropts[] = ["form_settings.session", "=", $session];
            }
            
            if (!empty($request->programme_mode) && $request->programme_mode != "%") {
                $arropts[] = ['programme_types.prog_type_code', '=', $request->programme_mode];
            }
            if (!empty($facultyid) && $facultyid != '%') {
                $arropts[] = ["faculties.id", "=", $facultyid];
            }
            if (!empty($departmentid) && $departmentid != '%') {
                $arropts[] = ["departments.id", "=", $departmentid];
            }
            if (!empty($programmetypeid) && $programmetypeid != '%') {
                $arropts[] = ["programme_types.id", "=", $programmetypeid];
            }
            if (!empty($programmeid) && $programmeid != '%') {
                $arropts[] = ["programmes.id", "=", $programmeid];
            }
            if (!empty($paymentstatus) && $paymentstatus != '%') {
                $arropts[] = ["transactions.payment_status", "=", $paymentstatus];
            }

            $query = DB::table("candidate_forms")
                ->join("transactions", "transactions.student_id", "=", "candidate_forms.id")
                ->join("candidates", "candidates.id", "=", "candidate_forms.candidate_id")
                ->join("candidate_biodatas AS bio", "candidates.id", "=", "bio.candidate_id")
                ->join("candidate_contacts AS contact", "candidates.id", "=", "contact.candidate_id")
                ->join("form_settings", "form_settings.id", "=", "candidate_forms.form_setting_id")
                ->leftJoin("programmes", "form_settings.programme_id", "=", "programmes.id")
                ->leftJoin("programme_types", "programme_types.id", "=", "programmes.programme_type_id")
                ->leftJoin("departments", "programmes.department_id", "=", "departments.id")
                ->leftJoin("faculties", "departments.faculty_id", "=", "faculties.id")
                ->leftJoin("lgas", "lgas.id", "=", "bio.lga_id")
                ->leftJoin("states", "states.id", "=", "lgas.state_id")
                ->leftJoin("candidate_olevels", "candidate_olevels.candidate_id", "=", "candidates.id")
                ->leftJoin("candidate_olevel_results", "candidate_olevel_results.candidate_olevel_id", "=", "candidate_olevels.id")
                ->leftJoin("subjects", "subjects.id", "=", "candidate_olevel_results.subject_id")
                ->leftJoin("olevel_grades", "olevel_grades.id", "=", "candidate_olevel_results.grade_id")
                ->leftJoin("candidate_alevels", "candidate_alevels.candidate_id", "=", "candidates.id")
                ->leftJoin("qualifications", "qualifications.id", "=", "candidate_alevels.qualification_id")
                ->leftJoin("qualification_grades", "qualification_grades.id", "=", "candidate_alevels.degree_class_id")
                ->leftJoin("countries", "countries.id", "=", "bio.country_id");

            $columnsquery = $query->select([
                "candidate_forms.id as appId", 
                "candidates.username as candid",
                "candidates.email",
                "candidate_forms.jamb_number as username",
                DB::raw("CONCAT(firstname,' ',IFNULL(othernames, ''),' ',surname)  AS fullname"),
                "bio.gender",
                "bio.date_of_birth",
                "candidate_forms.admission_status",
                "programmes.name AS programme",
                "departments.name AS department",
                "transactions.invoice_number", 
                "transactions.code", 
                "states.name as state",
                "lgas.name as lga",
                "transactions.transaction_amount as amount",
                "transactions.payment_status",
                "faculties.name AS faculty", 
                "bio.marital_status", 
                "contact.gsm",
                "form_settings.session",
                "form_settings.candidate_form_type_id",
                "candidate_forms.jamb_score",
                'candidate_forms.school_attended',
                "candidate_forms.id as appno",
                "transactions.transaction_code",
                "candidate_alevels.id as candalevelid",
                DB::raw("DATE_FORMAT(transactions.created_at, '%Y-%m-%d') as date"),
                DB::raw("GROUP_CONCAT(DISTINCT CONCAT(subjects.subject_code, ' - ', olevel_grades.grade) ORDER BY subjects.subject_code DESC SEPARATOR ', ') AS olevel"),
                DB::raw("GROUP_CONCAT(DISTINCT CONCAT(qualifications.qualification, ' ',candidate_alevels.course, ' ', candidate_alevels.institution_name, ' ', candidate_alevels.to_year, ' ',qualification_grades.grade) SEPARATOR '@') AS alevel")
            ])
                ->groupBy([
                    "candidate_forms.id", "candidates.username", "candidates.email", "candidate_forms.jamb_number",
                    "bio.firstname", "bio.othernames", "bio.surname", "bio.gender", "bio.date_of_birth", 
                    "candidate_forms.admission_status", "programmes.name", "departments.name", 
                    "transactions.invoice_number", "transactions.code", "states.name", "lgas.name",
                    "transactions.transaction_amount", "transactions.payment_status", "faculties.name", 
                    "bio.marital_status", "contact.gsm", "form_settings.session", 
                    "form_settings.candidate_form_type_id", "candidate_forms.jamb_score", 
                    "candidate_forms.school_attended", "transactions.transaction_code", 
                    "transactions.created_at"
                ]);

            $columnsquery = $columnsquery->where($arropts);

            $columnsquery = $columnsquery->orderBy("faculties.name")
                ->orderBy("departments.name")->orderBy("programme_types.prog_type_name")->orderBy("programmes.name")->orderBy("transactions.student_id")->orderBy("surname");

            // Debug: Check if there are any candidates at all
            $totalCandidates = DB::table("candidate_forms")->count();
            $totalTransactions = DB::table("transactions")->where("code", "FRM")->count();
            \Log::info('Database Check:', [
                'total_candidate_forms' => $totalCandidates,
                'total_frm_transactions' => $totalTransactions
            ]);
            
            // Debug: Log the SQL query
            \Log::info('SQL Query:', ['sql' => $columnsquery->toSql(), 'bindings' => $columnsquery->getBindings()]);
            
            $candidates = $columnsquery->get();
            
            // Debug: Log the results
            \Log::info('Query Results:', ['count' => $candidates->count(), 'first_record' => $candidates->first()]);
            
            // If no results, try a simpler query to see if there's any data
            if ($candidates->count() == 0) {
                \Log::info('No results found, trying simpler query...');
                $simpleQuery = DB::table("candidate_forms")
                    ->join("transactions", "transactions.student_id", "=", "candidate_forms.id")
                    ->join("candidates", "candidates.id", "=", "candidate_forms.candidate_id")
                    ->where("transactions.code", "=", "FRM")
                    ->select("candidate_forms.id", "candidates.username", "candidates.email")
                    ->limit(5);
                
                $simpleResults = $simpleQuery->get();
                \Log::info('Simple Query Results:', ['count' => $simpleResults->count(), 'results' => $simpleResults->toArray()]);
            }

            $totalamount = 0;// $columnsquery->sum('transactions.transamount');

            // Debug: Log first candidate data to see what's available
            if (count($candidates) > 0) {
                \Log::info('First candidate data sample', [
                    'candidate_id' => $candidates[0]->appId ?? 'N/A',
                    'olevel_data' => $candidates[0]->olevel ?? 'No O-level data',
                    'alevel_data' => $candidates[0]->alevel ?? 'No A-level data',
                    'available_properties' => array_keys((array)$candidates[0])
                ]);
            }
            
            $html = view('pages.staff.reports.candidates.load_applicant_cat_data', compact('candidates', 'totalamount'))->render();
            
            \Log::info('Report generated successfully', [
                'candidates_count' => count($candidates),
                'unique_candidate_forms' => collect($candidates)->pluck('appId')->unique()->count()
            ]);
            
            return response()->json(['html' => $html]);

        } catch (\Exception $e) {
            // Log the error for debugging
            \Log::error('Candidate Category Report Error: ' . $e->getMessage());
            \Log::error('Stack trace: ' . $e->getTraceAsString());
            
            // Return error response
            return response()->json([
                'error' => true,
                'message' => 'Error generating report: ' . $e->getMessage()
            ], 500);
        }
    }
}
