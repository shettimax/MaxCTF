<?php

namespace App\Http\Controllers\Staff;

use App\Models\Department;
use App\Http\Controllers\Controller;
use App\Models\Programme;
use App\Models\Transaction;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class ProgrammeController extends Controller
{
    public function __construct()
    {
        $this->middleware('auth:staff');
    }

    public function index()
    {
        if (!$this->access(Auth::user(), "admin.programme"))
            return view("pages.errors.nopermission");
        try{
            return view('pages.staff.settings.manageprogrammes');
        }catch (\Exception $e){
            return $e->getMessage();
        }
    }

    public function store(Request $request)
    {
        try {
            if (!$this->access(Auth::user(), "admin.programme"))
                return view("pages.errors.nopermission");

            $this->validate($request, [
                'progtype' => 'required',
                'programme' => 'required',
                'department' => 'required',
                //'duration' => 'required|integer|max:3|min:1'
            ]);
            $db = new Programme();
            if ($request->programme_id > 0)
                $db = Programme::find($request->programme_id);
            $db->name = $request->programme;
            $db->department_id = $request->department;
            $db->programme_type_id = $request->progtype;
            $db->duration = $request->duration;
            $db->requirement = $request->requirement;
            $db->save();
            if ($request->programme_id > 0)
                $request->session()->flash('flash_message', 'Programme has been updated');
            else
                $request->session()->flash('flash_message', 'Programme has been added');
            return redirect()->back();
        } catch (\Exception $e) {
            return view("pages.staff.error.technical");
        }
    }

    public function edit($id)
    {
        $model = Programme::find($id);
        if (!$this->access(Auth::user(), "admin.programme"))
            return view("pages.errors.nopermission");

        return view('pages.staff.settings.manageprogrammes', compact('model'));
    }

    public function show($department_id, $progtype_id)
    {


        $programmes = Programme::where('department_id', '=', $department_id)->where('programme_type_id', '=', $progtype_id)->get()->all();
        $table = "<table align='center' class='table table-bordered table-striped table-responsive' style='width:95%;font-size:16px;font-family: Calibri; text-align: left; color: #000000'>";
        $table .= "<tr><th>S/N</th><th>Programme Name</th><th>Department</th><th>Faculty</th><th>Action</th></tr>";
        $i = 1;
        foreach ($programmes as $programme) {
            $table .= "<tr><td>" . ($i++) . "</td><td>$programme->name</td><td>" . Programme::find($programme->id)->department()->first()->name . "</td><td>" . Department::find(Programme::find($programme->id)->department()->first()->id)->faculty()->first()->name . "</td>";
            $table .= "<td><a href='" . route('programme.edit', ['id' => $programme->id]) . "'><span class='icon icon-edit2'></span> Edit</a> </td></tr>";
        }
        $table .= "</table>";

        return $table;
    }
}
