<?php

namespace App\Http\Controllers\Staff;

use App\Models\FeeSettings;
use App\Http\Controllers\Controller;
use App\Models\PaymentOption;
use App\Models\SessionalFeesSetting;
use App\Models\ProgrammeType;
use App\Models\SessionReg;
use http\Env\Response;
use Illuminate\Http\Request;

use Excel;
use Illuminate\Support\Facades\Auth;

class SessionalFeesController extends Controller
{
    public function __construct(){
        return $this->middleware(['auth:staff']);
    }


    public function index(){
        $sessions  = SessionalFeesSetting::select('session')->distinct()->orderby('session','DESC')->get();
        $programmes = ProgrammeType::select('prog_type_code')->distinct()->orderby('prog_type_code','DESC')->get();
        $sessionfees = SessionalFeesSetting::select('fee_session')->distinct()->orderby('fee_session','DESC')->get();
        //$dataitems = SessionalFeesSetting::paginate(3);
        $dataitems = SessionalFeesSetting::all();
        return view('pages.staff.settings.sessionalfees', compact('sessions','programmes', 'sessionfees', 'dataitems'));
    }

    public function create(Request $request)
    {
        try {
            $message = ['session.required'=>'Current Session is required','programmetypes'=>'Programme type is required'];
            $this->validate($request, [
                "session" => "required",
                "programmetypes" => "required",
                "feecategory" => "required",
                "sessionfee" => "required"
            ], $message);
            $session = $request['session'];
            $programmtype = $request['programmetypes'];
            $feecategory = $request['feecategory'];
            $sessionfee = $request['sessionfee'];

            $sessionalFeeSet = new SessionalFeesSetting();

            $sessionalFeeSet->session = $session;
            $sessionalFeeSet->programme_type = $programmtype;
            $sessionalFeeSet->fee_type = $feecategory;
            $sessionalFeeSet->fee_session = $sessionfee;

            $sessionalFeeSet->save();
            return redirect()->back()->with('success', 'Sessional Fees setting created successfully.');

        } catch (\Exception $e) {
            return redirect()->back()->with("error", $e->getMessage() . 'All fields are Required' );
        }
    }



    public function update(Request $request)
    {
      //  return $request;
        try{
        $feesessionset = SessionalFeesSetting::find($request->sessionId);
        $feesessionset->session = $request->input('session');
        $feesessionset->programme_type = $request->input('programmetypes');
        $feesessionset->fee_type = $request->input('feecategory');
        $feesessionset->fee_session = $request->input('sessionfee');

        $feesessionset->save();
        return redirect()->back()->with('success','Sessional fees setting updated successfully');
       // return redirect()->route('sessional.fees')->with('success','Sessional fees setting updated successfully');
        } catch (\Exception $e) {
            return redirect()->back()->with("error", $e->getMessage() . 'All fields are Required');
        }
    }

    public function edit(Request $request,SessionalFeesSetting $feesSetting)

    {
        $sessions  = SessionalFeesSetting::select('session')->distinct()->orderby('session','DESC')->get();
        $programmes = ProgrammeType::select('prog_type_code')->distinct()->orderby('prog_type_code','DESC')->get();
        $sessionfees = SessionalFeesSetting::select('fee_session')->distinct()->orderby('fee_session','DESC')->get();

        return view('pages.staff.settings.editsessionalfees',compact('feesSetting' , 'sessions', 'programmes', 'sessionfees'));
    }

    public function delete(Request $request)
    {

        try {
            $sessiondd = SessionalFeesSetting::find($request->deletesessionfeeid);
            $sessiondd->delete();

            $request->session()->flash('status','Record deleted successfully');
            return redirect()->route('sessional.fees');

        }catch(\Exception $e){
            return $e->getMessage();
        }
    }


    public function paymentOptionIndex(Request $request)
    {
        $options = PaymentOption::all();
        return view('pages.staff.settings.paymentoption.index',compact("options"));
    }

    public function storePaymentOption(Request $request)
    {
        $this->validate($request,[
            'from_session'=>"required",
            'entry_session'=>"required",
            'mode_of_entry'=>"required",
            'level_id'=>"required",
            'new_returning'=>"required",
            'type'=>"required",
            'selected_student'=>"required",
            'value'=>"required",
            'payment_code'=>"required",
        ]);

        //Clean user entry
        if($request->type == "Percentage"){
            $values = explode(":",str_replace(",","",$request->value));
            $total = 0;
            $percArr = [];
            $hasWaived = false;
            $type = "";
            foreach ($values as $value){
                if(strtolower($value)=="waived" || strtolower($value)=="w" || str_contains(strtolower($value),"w") || strtolower($value)=="loan" || strtolower($value)=="lumpsum"){
                    $hasWaived = true;
                    $type = ucwords($value);
                }else{
                    if($total+$value <= 100 && trim($value) != ""){
                        $total += $value;
                        $percArr[] = $value;
                    }
                }

            }
            if($total < 100){
                if($hasWaived){
                    $percArr[] = $type;
                }else{
                    $percArr[] = 100 - $total;
                }
            }
        }

        $pO = new PaymentOption;
        $pO->from_session = $request->from_session;
        $pO->entry_session = $request->entry_session;
        $pO->mode_of_entry = $request->mode_of_entry;
        $pO->level_id = $request->level_id;
        $pO->new_returning = $request->new_returning;
        $pO->type = $request->type;
        $pO->selected_student = $request->selected_student;
        $pO->value = $request->type=="Percentage"?implode(':',$percArr) :$request->value;
        $pO->status = "Inactive";
        $pO->payment_code = $request->payment_code;
        $pO->save();
        return back();
    }

    public function paymentOptionActivate(Request $request)
    {
        $pOpt = PaymentOption::find($request->id_);
        if($pOpt){
            $pOpt->status = $pOpt->status=="Active"?"Inactive":"Active";
            $pOpt->save();
            $request->session()->flash('success',($pOpt->status=="Active"?"Activated":"Deactivated").' Payment Option');
        }else{
            $request->session()->flash('error','Failed to toggle status.');
        }
        return back();
    }

    public function viewBeneficiaries(Request $request,$id)
    {
        $payOpt = PaymentOption::find($id);
        if($payOpt){
            $beneficiaries =  SessionReg::join('levels','levels.id',"=","session_regs.level_id")
                ->join("programmes","programmes.id","=","session_regs.level_id")
                ->where("payment_option",$payOpt->id)
                ->select(["session_regs.id","matric_number","levels.short_name","programmes.name AS programme","session"])
                ->get();
        }

        return view("pages.staff.settings.paymentoption.beneficiaries",compact("beneficiaries"));
    }

    public function uploadBeneficiaries(Request $request)
    {
        $user = Auth::user();
        $this->validate($request, [
            "session" => "required",
            "payment_option_id" => "required|exists:payment_options,id",
            "filename" => "required|mimes:excel,xls,xlsx"
        ]);
        $paymentOption = PaymentOption::find($request->payment_option_id);
        $excel = Excel::toCollection(null, request()->file('filename'));
        $excel = $excel[0];
        $studsX = [];
        $i=0;
        foreach ($excel as $row){
            if($i==0){
                $i++;
                continue;

            }
            $sessionReg = SessionReg::where(["matric_number"=>$row[0],"session"=>$request->input("session")])->update(["payment_option"=>$request->payment_option_id,"payment_option_assigner_id"=>$user->id,"loan_amount"=>$row[1]]);
            // $studsX[] = ["matric_number"=>$row[0],"session"=>$request->input("session"),"payment_option"=>$request->payment_option_id,"payment_option_assigner_id"=>$user->id,"loan_amount"=>$row[1]];
        }
        // SessionReg::upsert($studsX,['session','matric_number'],['payment_option','payment_option_assigner_id','loan_amount']);
        // return  $studsX;
        return back();
    }

    public function removePaymentOption(Request $request)
    {
        $this->validate($request, [
            "session_reg_id" => "required",
        ]);
        $sessReg = SessionReg::find($request->session_reg_id)->first();

        $sessReg->payment_option = null;
        $sessReg->save();

        return back();
    }
}
