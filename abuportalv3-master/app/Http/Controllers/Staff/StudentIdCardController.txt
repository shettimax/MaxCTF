<?php

namespace App\Http\Controllers\Staff;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Auth;
use App\Models\User;
use App\Models\Level;
use App\Models\Programme;
use App\Models\ProgrammeType;

class StudentIdCardController extends Controller
{
    //Staff authorisation

    public function __construct()
    {
        $this->middleware(['auth:staff']);
    }

    protected function view()
    {
        $user = Auth::user();
        return view('pages.staff.reports.idcards.printcards');
    }

    protected function storeCards($programme)
    {
        $prog = Programme::find($programme);

        $records = DB::table("students")
            ->join("student_biodatas", "student_biodatas.student_id", "=", "students.id")
            ->leftjoin("programmes", "students.programme_id", "=", "programmes.id")
            ->join("departments", "departments.programme_id", "=", "programmes.id")
            ->join("faculties", "faculties.department_id", "=", "faculties.id")
            ->where("students.programme_id", "=", $prog)
            ->select("students.matric_number", "departments.name as departmentname", " programmes.name as programname")->get();


        $output = '
              <button style="float: right;" type="button" class="btn btn-primary selectedrecords"
                        data-target="#usermodal">
                    <span class="ti-eye">&nbsp;View Selected</span>
                </button>
                <br/><br/>
                <table id="studenttable" class="table table-bordered table-striped table-responsive nowrap">
                        <thead class="thead-light">
                        <tr class="text-dark text-uppercase">
                            <th class="no-sort">
                                ID
                            </th>
                            <th>Matric Number</th>
                            <th>Surname</th>
                            <th>Other names</th>
                            <th>Department</th>
                            <th>Programme</th>
                            <th>Sex/Blood Group</th>
                            <th>Date of Birth</th>
                            <th>State of Origin</th>
                            <th>Phone Number</th>
                            <th>Next of Kin</th>
                            <th>NOK Phone Number</th>
                            <th>View</th>
                            <th>Check all&nbsp;&nbsp;<input name="check_all" class="check_all" type="checkbox"></th>
                        </tr>
                        </thead><tbody>';
        if (count($records)) {
            foreach ($records as $row) {

                $othername = isset($row["othernames"]) ? " " . $row["othernames"] : "";
                $output .= '
		<tr>
			<td>' . $row["id"] . '</td>
			<td>' . $row["matricnumber"] . '</td>
			<td>' . $row["surname"] . '</td>
			<td>' . $row["firstname"] . $othername . '</td>
			<td>' . $row["departmentname"] . '</td>
			<td>' . $row["programname"] . '</td>
			<td>' . $row["gender"] . '/' . $row["bloodgroup"] . '</td>
			<td>' . $row["dob"] . '</td>
			<td>' . $row["statename"] . '</td>
			<td>' . $row["gsm"] . '</td>
			<td>' . $row["nok"] . '</td>
			<td>' . $row["nokgsm"] . '</td>
			<td>
				<a name="print" class="btn btn-info btn-xs print" href="view-idcard.php?id=' . $row["id"] . '" target="_blank" ><span class="ti-eye"></span></a>
 			</td>
			<td class="text-center">
                <input value="' . $row["id"] . '" name="studentid[]" class="selectedforprint" type="checkbox" >
  			</td>
		</tr>
		';
            }
        } else {
            $output .= '
	<tr>
		<td colspan="14" align="center">Data not found</td>
	</tr>
	';
        }
        $output .= '</tbody></table>';

        $output .= '<br/><br/>
<button style="float: right;" type="button" class="btn btn-primary selectedrecords"
                        data-target="#usermodal">
                    <span class="ti-eye">&nbsp;View Selected</span>
                </button>';
        return $output;


    }
}
