<?php

namespace App\Http\Controllers\Form;

use App\Models\CandidateForm;
use App\Models\Candidate;
use App\Models\CandidateFormType;
use App\Models\Faculty;
use App\Models\FeeManager;
use App\Models\FormSetting;
use App\Http\Controllers\Controller;
use App\Models\Programme;
use App\Models\Student;
use App\Models\Transaction;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Mockery\Exception;
use App\Http\Middleware\CheckAge;

class CandidateFormController extends Controller
{

    public function __construct()
    {
        $this->middleware("auth:candidate");
        $this->middleware("hasEmail")->except(["emailPost", "email"]);
    }

    public function email(Request $request)
    {

        $candidate = Auth::user();
        return view("pages.forms.auth.editEmail", compact("candidate"));
    }

    public function emailPost(Request $request)
    {
        // $this->validate($request, ["email" => "required|email|unique:candidates,email"]);
        $candidate = Auth::user();
        $candidate1 = Candidate::where('email',$request->email)->where('id','<>',$candidate->id)->first();
        if($candidate1){
            return back()->withErrors(['email'=>'Email already taken.']);
        }
        $candidate->email = $request->email;
        $candidate->nin = $request->nin;
        $candidate->save();

        return redirect(route("forms.dashboard"));

    }

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index()
    {
        //
        $candidate = Auth::user();
        foreach ($candidate->transactions() as $transaction) {
            $transaction->verify();
        }
        $candidateForms = $candidate->candidateForms();
        $types = CandidateFormType::whereNotIn('id', [1, 2,10])->get();
        $programmes = Programme::all();
        $faculties = Faculty::whereIn("is_other_institute", ['1', '2'])->get();
        return view("pages.forms.myform.index", compact("candidate", "candidateForms", "faculties", "types", "programmes"));
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function form(Request $request, $id)
    {
        //

        $candidate = Auth::user();
        $candidate_id=$candidate->id;
        foreach ($candidate->transactions() as $transaction) {
            $transaction->verify();
        }
        $interUniversity= null;
        $query = DB::table("candidate_forms")
            ->join("candidates", "candidates.id", "=", "candidate_forms.candidate_id")
            ->join("candidate_biodatas AS bio", "candidates.id", "=", "bio.candidate_id")
            ->join("candidate_contacts AS contact", "candidates.id", "=", "contact.candidate_id")
            ->join("form_settings", "form_settings.id", "=", "candidate_forms.form_setting_id")
            ->leftJoin("programmes", "form_settings.programme_id", "=", "programmes.id")
            ->leftJoin("departments", "programmes.department_id", "=", "departments.id")
            ->leftJoin("faculties", "departments.faculty_id", "=", "faculties.id")
            ->join("lgas", "lgas.id", "=", "bio.lga_id")
            ->join("states", "states.id", "=", "lgas.state_id")
            ->where("candidate_forms.candidate_id","=",$candidate_id)
            ->select("states.name AS statename", "faculties.name AS faculty", "candidates.username AS RegNum", "candidates.email AS email", "contact.gsm","programmes.name AS prog")
            ->first();
        $candidateForm = CandidateForm::where(["candidate_id" => $candidate->id, "id" => $id])->first();
//        if($candidateForm)
        if ($candidateForm) {//5681367046019509225

            $fType = $candidateForm->candidateFormType();
            if ($fType->id == 1 || $fType->id == 2) {
                return view("pages.forms.myform.view_putme", compact("candidateForm", "candidate", "query"));
            }
            if($fType->id == 22){
                $interUniversity = !empty(trim($candidateForm->school_attended))?json_decode($candidateForm->school_attended):null;
            }

//            if($id==5681367046019511949){
//                return $candidateForm->school_attended;
//            }
            return view("pages.forms.myform.view_others", compact("candidateForm", "candidate",'interUniversity'));
        } else {
            return redirect(route("form.buy.index"));
        }
    }

    public function formPost(Request $request, $id)
    {
        //

        $candidate = Auth::user();
        $candidateForm = CandidateForm::where(["candidate_id" => $candidate->id, "id" => $id])->first();
        if($candidateForm){
            $candidateForm->jamb_number = $request->jamb_number;
            $candidateForm->jamb_score = $request->jamb_score;
            $candidateForm->jamb_year = $request->jamb_year;
            $candidateForm->save();
        }
        return redirect(route("form.buy.form",[$id]));
    }


    public function formSettings(Request $request, $id)
    {
        $candidate = Auth::user();

        if($cf = CandidateForm::where(["form_setting_id"=>$id,"candidate_id"=>$candidate->id])->first()){
            //return $id;
        }else{
            $cf = new CandidateForm;
            $cf->form_setting_id = $id;
            $cf->candidate_id = $candidate->id;
            $cf->date_started = now();
            $cf->date_submitted = null;
            $cf->admission_status = "pending";
            $cf->payment_status = "Not Paid";
            $cf->jamb_score = "0";
            $cf->save();
        }
        //return $cf;
        return redirect(route("form.buy.form",[$cf->id]));

    }

    /**
     * Store a newly created resource in storage.
     *
     * @param \Illuminate\Http\Request $request
     * @return \Illuminate\Http\Response
     */
    public function pay(Request $request, $id)
    {
        //
        $candidate = Auth::user();
        $candidate_id=$candidate->id;
        // return $candidate->transactions();
        foreach ($candidate->transactions() as $transaction) {
            $transaction->verify();
        }
        $candidateBiodata = $candidate->biodata();
        $candidateContact = $candidate->contact();
        $candidateForm = CandidateForm::where(["candidate_id" => $candidate->id, "id" => $id])->first();
        $formSettings = FormSetting::where(["id" => $candidateForm->form_setting_id])->first();
        if ($candidateForm) {
//            Todo: Generate Transaction Id and RRR then load Page
            $type = $candidateForm->candidateFormType();
            $transaction = FeeManager::generateTransactionCode($candidateForm->id, "FRM", $candidateForm->formSetting->session, $type->code);
            $transaction = Transaction::where("transaction_code", $transaction)->first();
            $transaction->verify();
            $programme = $formSettings->programme();
            $department = $programme->department();
            $faculty = $department->faculty();
            $session = $candidateForm->formSetting->session;
            $biodata = $candidate->biodata();
            $message = "";
            if ($transaction->invoice_number == $transaction->transaction_code) {

                $mert = Transaction::MERCHANTID;
                $api_key = Transaction::APIKEY;
//                $responseurl="https://spgs.abu.edu.ng/portal/transaction/fees/response";$hash="";
                $responseurl = "https://putme.abu.edu.ng/buy/pay";
                $hash = "";
                $concatString = Transaction::MERCHANTID . (($formSettings->candidate_form_type_id == 1 || $formSettings->candidate_form_type_id == 2)?Transaction::SERVICETYPEID:Transaction::OTHERFORMSSERVICEID) . $transaction->transaction_code . intval($transaction->transaction_amount) . Transaction::APIKEY;
                $hash = hash('sha512', $concatString);
                $data = [
//                "merchantId"=>Transaction::MERCHANTID,
                    "serviceTypeId" => ($formSettings->candidate_form_type_id == 1 || $formSettings->candidate_form_type_id == 2)?Transaction::SERVICETYPEID:Transaction::OTHERFORMSSERVICEID,
//                "amt"=>$trans->transaction_amount,
                    "amount" => intval($transaction->transaction_amount),
//                "responseurl"=>$responseurl,
//                "hash"=>$hash,
                    "payerName" => $candidate->getFullName(),
                    "description" => ($formSettings->candidate_form_type_id == 1 || $formSettings->candidate_form_type_id == 2)?"ABU Post UTME Admission Screening":"ABU eForms Purchase",
                    "payerEmail" => $candidate->email,
                    "payerPhone" => $biodata->gsm,
                    "orderId" => $transaction->transaction_code,
                    "customFields" => [
                        ["name" => "PayerID", "value" => $candidate->username, "type" => "All"],
                        ["name" => "Session", "value" => $session, "type" => "All"],
                    ]
                ];
                $data_string = json_encode($data);
                try {
                    $ch = curl_init("https://login.remita.net/remita/exapp/api/v1/send/api/echannelsvc/merchant/api/paymentinit");

                    curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
                    curl_setopt($ch, CURLOPT_POSTFIELDS, $data_string);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
                        "Authorization: remitaConsumerKey=$mert,remitaConsumerToken=$hash",
                        'Content-Type: application/json',
                        'Content-Length: ' . strlen($data_string)
                    ));
                    $response = curl_exec($ch);
                    curl_close($ch);
                    $response = substr($response, 7);
                    $response = substr($response, 0, -1);
                    $response = json_decode($response);
                    if ($response->statuscode == "025") {
                        $transaction->invoice_number = $response->RRR;
                        $transaction->save();
                    } else {
                        $message = "Failed to generate RRR please try again later.";
                    }
                } catch (\Exception $e) {
                    try {
                        $concatString = $transaction->transaction_code . Transaction::APIKEY . Transaction::MERCHANTID;
                        $hash = hash('sha512', $concatString);
//                        https://login.remita.net/remita/ecomm/{merchantId}/{OrderID}/{hash}/orderstatus.reg
                        $ch = curl_init("https://login.remita.net/remita/ecomm/" . Transaction::MERCHANTID . "/" . $transaction->transaction_code . "/" . $hash . "/orderstatus.reg");
                        curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");
                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                        $response = curl_exec($ch);
                        $response = json_decode($response);
                        if (!empty($response)) {
                            $transaction->invoice_number = $response->RRR;
                            $transaction->save();
                        }
                    } catch (\Exception $e) {

                    }
                }


            }
            return view("pages.forms.myform.pay", compact("transaction", "candidate", "faculty", "programme", "department", "session", "candidateBiodata", "candidateContact", "type", "candidateForm"));

        } else {
            return redirect(route("form.buy.index"));
        }
    }

    /**
     * Display the specified resource.
     *
     * @param int $id
     * @return \Illuminate\Http\Response
     */
    public function completedForm(Request $request, $id)
    {
        //
        $candidate = Auth::user();
        $candidateForm = CandidateForm::where(["candidate_id" => $candidate->id, "id" => $id])->first();
        if ($candidateForm) {
            $candidateBiodata = $candidate->biodata();
            $candidateContact = $candidate->contact();
            $type = $candidateForm->candidateFormType();
            $transaction = $candidateForm->transactions()[0];
            $programme = $candidateForm->programme();
            $department = $programme->department()->first();
            $faculty = $department->faculty()->first();
            $session = $candidateForm->formSetting->session;
            return view("pages.forms.myform.view_completed_form", compact("candidate", "candidateForm", "candidateContact", "candidateBiodata", "programme", "faculty", "department", "session", "transaction", "type"));

        } else {
            return redirect(route("form.buy.index"));
        }

    }

    public function printResultSlip(Request $request, $id)
    {
        //
        $candidate = Auth::user();
        $candidateForm = CandidateForm::where(["candidate_id" => $candidate->id, "id" => $id])->first();
        if ($candidateForm) {
            $candidateBiodata = $candidate->biodata();
            $candidateContact = $candidate->contact();
            $type = $candidateForm->candidateFormType();
            $transaction = $candidateForm->transactions()[0];
            $programme = $candidateForm->programme();
            $department = $programme->department()->first();
            $faculty = $department->faculty()->first();
            $session = $candidateForm->formSetting->session;
            return view("pages.forms.notification.view_result", compact("candidate", "candidateForm", "candidateContact", "candidateBiodata", "programme", "faculty", "department", "session", "transaction", "type"));

        } else {
            return redirect(route("form.buy.index"));
        }

    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param int $id
     * @return \Illuminate\Http\Response
     */
    public function openForms(Request $request)
    {
        //
       $programmes = Programme::join("form_settings", "programmes.id", "=", "form_settings.programme_id")
            ->join("candidate_form_types", "candidate_form_types.id", "=", "form_settings.candidate_form_type_id")
            ->join("departments","departments.id","=","programmes.department_id")
            ->select([
                "programmes.name AS programme", "form_price", "session", "short_desc",
                "start_date", "late_start_date", "end_date", "duration", "department_id"
                ,"candidate_form_types.name AS type","require_ref_response","programmes.programme_type_id","form_settings.id AS fs_id"
            ])
            ->where("candidate_form_types.id","!=",10)
            ->whereDate("start_date","<=",today())
            ->whereDate("end_date",">=",today());
       if( $request->search !="" ){
           $programmes = $programmes->whereRaw("programmes.name LIKE '%{$request->search}%'");
       }

       if( $request->faculty !="" ){
           $programmes = $programmes->where("departments.faculty_id","=",$request->faculty);
       }
       if( $request->department !="" ){
           $programmes = $programmes->where("departments.id","=",$request->department);
       }
       if( $request->programme !="" ){
           $programmes = $programmes->where("programmes.id","=",$request->programme);
       }
       if( $request->type !="" ){
           $programmes = $programmes->where("candidate_form_types.id","=",$request->type);
       }
        $programmes = $programmes->get();

        return  view("pages.forms.myform.ajax.open",compact("programmes"));

    }

    /**
     * Update the specified resource in storage.
     *
     * @param \Illuminate\Http\Request $request
     * @param int $id
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request, $id)
    {
        //
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param int $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id)
    {
        //
    }

    public function updateMatric(Request $request, $id)
    {
//        return $request;
        $candidate = Auth::user();
        $candidateForm = CandidateForm::where(["candidate_id" => $candidate->id, "id" => $id])->first();
        if($candidateForm){
            $candidateForm->jamb_number = $request->matric_number;
            $candidateForm->jamb_score = $request->cgpa;
            $student = Student::where("matric_number",$request->matric_number)->first();
            if($student){
                $candidateForm->student_id = $student->id;
            }
            $candidateForm->save();

        }
        return back();
    }

    public function updateInterUni(Request $request, $id)
    {
//        return $request;
        $request->validate([
            'school'=>'required',
            'reg_number'=>'required',
            'cgpa'=>'required',
            'transcript' => 'required|file|mimes:jpg,jpeg,png,pdf|max:2048', // Example validation rules
        ]);
        $candidate = Auth::user();
        $candidateForm = CandidateForm::where(["candidate_id" => $candidate->id, "id" => $id])->first();
        if($candidateForm){
            $fileName = '';
            if ($request->hasFile('transcript')) {
                $file = $request->file('transcript');
                $fileName = time() . '_' . $file->getClientOriginalName(); // Rename the file
                $file->storeAs(public_path('uploads'), $fileName); // Store the file in the 'uploads' directory
                // You can also use other storage options like s3, public etc. depending on your setup
            }

            $json = [
                    'school'=>$request->school,
                    'reg_number'=>$request->reg_number,
                    'level'=>$request->level,
                    'cgpa'=>$request->cgpa,
                    'transcript'=>$fileName
            ];
            $candidateForm->school_attended = json_encode($json);
            $candidateForm->save();

        }
        return back();
    }


    public function updateInterUniFile(Request $request,$id)
    {
        // Assuming $fileName contains the name of the file you want to retrieve
        $candidateForm = CandidateForm::find($id);
        $school_attended = json_decode($candidateForm->school_attended);
        $filePath = 'uploads/' . $school_attended->transcript;

        // Check if the file exists
        if (Storage::exists($filePath)) {
            // File exists, retrieve it
            $fileContents = Storage::get($filePath);

            // Now you can do whatever you want with the file contents
            // For example, return a response with the file contents
            return response($fileContents, 200)
                ->header('Content-Type', Storage::mimeType($filePath));
        } else {
            // File does not exist
            abort(404);
        }

    }

    public function searchpix()
    {
        if ($this->access(Auth::user(), "student.search.picture"))
            // return view("pages.errors.nopermission");
            return view('pages.staff.form.applicant.search.view');
    }

    public function destroyCandPhoto(Request $request)
    {
        $user = Auth::user();
        $data = $request->candUsername;
        $cand = Candidate::where("username", "=", $data)->first();
        if (!$user->canAccess("student.search.picture", $cand)) {
            return redirect('', 403);
        }
        $candidate = $cand->username;

        $image_path = public_path() . '/candidatepics/' . $candidate . '.JPG';
        if (file_exists($image_path)) {
            unlink($image_path);

            if ($candidate) {
                session()->flash('success', 'Candidate photo deleted successfully!');

            } else {
                session()->flash('error', 'Something is wrong while deleting photo!');
            }
        }
        return redirect()->back();
    }


}
