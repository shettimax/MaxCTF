<?php

namespace App\Http\Controllers\Form;

use App\Models\Candidate;
use App\Models\CandidateBiodata;
use App\Models\CandidateFormType;
use App\Models\Faculty;
use App\Http\Controllers\Controller;
use App\Models\Programme;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Validation\ValidationException;
use Mockery\Exception;

class LoginController extends Controller
{
    //
    public function __construct()
    {
        $this->middleware("guest")->except(["logout"]);
    }

    public function showLogin()
    {
        Auth::guard("candidate")->logout();
        Auth::guard("staff")->logout();
        Auth::guard("student")->logout();
        return view("pages.forms.auth.index");
    }

    public function putme()
    {
        return view("pages.forms.auth.putme");
    }

    public function login(Request $request)
    {
        //        return $request;
        $usr = strrev(substr(decrypt($request->ye6h0pls_zxsa_eqwas__), 0, -7));
        $pswd = strrev(substr(decrypt($request->lvjnsv_hbbd_nkskjs_rn__), 0, -8));
        $credentials = ["username" => $request->$usr, "password" => $request->$pswd];
        $candidate = Candidate::where("username", "=", $request->$usr)->first();
        if ($candidate) {
            if (substr($candidate->password, 0, 4) != "$2y$") {
                $candidate->password = bcrypt($candidate->password);
                $candidate->save();
            }
            if (Auth::guard("candidate")->attempt($credentials, 1)) {
                foreach ($candidate->transactions() as $transaction) {
                    $transaction->verify();
                }
                return redirect(route("forms.dashboard"));
            }
        }

        return back()->withErrors(["login.message" => "Invalid Credentials!"]);

    }

    public function register(Request $request)
    {
        try {
            $this->validate($request, Candidate::$signuprules);
            $candidate = new Candidate();
            $candidate->email = $request->email;
            $candidate->username = $request->email;
            $candidate->status = "Active";
            $candidate->email_token = "";
            $candidate->password = bcrypt($request->password);
            $candidate->save();

            $biodata = new CandidateBiodata();
            $biodata->candidate_id = $candidate->id;
            $biodata->surname = $request->surname;
            $biodata->firstname = $request->firstname;
            $biodata->othernames = $request->othernames;
            $biodata->gender = $request->gender;
            $biodata->save();

            //            return $request;
            return back()->withErrors(["loginSuccessful" => "yay!"]);

        } catch (ValidationException $exception) {
            // Check if the error is about email uniqueness
            if ($exception->errors() && isset($exception->errors()['email'])) {
                $emailErrors = $exception->errors()['email'];
                foreach ($emailErrors as $error) {
                    if (strpos($error, 'has already been taken') !== false || strpos($error, 'unique') !== false) {
                        // Email already exists, get the candidate info
                        $existingCandidate = Candidate::where('username', $request->email)->first();
                        if ($existingCandidate) {
                            $biodata = CandidateBiodata::where('candidate_id', $existingCandidate->id)->first();
                            if ($biodata) {
                                $fullName = trim($biodata->surname . ' ' . $biodata->firstname . ' ' . $biodata->othernames);
                                return back()->withErrors(["email" => "Email has been used by {$existingCandidate->username}->{$fullName}, Please use another email"]);
                            } else {
                                return back()->withErrors(["email" => "Email has been used by {$existingCandidate->username}"]);
                            }
                        }
                    }
                }
            }
            // If it's a validation error but not email uniqueness, return the validation errors
            return back()->withErrors($exception->errors());
        } catch (\Exception $exception) {
            return back()->withErrors(["email" => "Sorry, something went wrong!!"]);
        }

    }

    public function logout(Request $request)
    {
        Auth::guard("candidate")->logout();
        $request->session()->invalidate();
        return redirect(route("forms.home"));
    }

    public function availableProgrammes(Request $request)
    {
        $programmes = DB::table("form_settings")
            ->join("programmes", "programmes.id", "=", "form_settings.programme_id")
            ->join("candidate_form_types", "candidate_form_types.id", "=", "form_settings.candidate_form_type_id")
            ->whereDate("start_date", "<=", today())
            ->whereDate("end_date", ">=", today())
            ->whereNotIn("candidate_form_type_id", [1, 2])
            ->select("candidate_form_types.*", "programmes.name AS programme", "form_settings.*")
            ->get();
        $ptypes = CandidateFormType::all();
        $faculties = Faculty::all();
        return view("pages.forms.dashboard.available", compact("programmes", "ptypes", "faculties"));
    }

    public function spgsProgrammes()
    {
        return $programmes = DB::table("form_settings")
            ->join("programmes", "programmes.id", "=", "form_settings.programme_id")
            ->join("candidate_form_types", "candidate_form_types.id", "=", "form_settings.candidate_form_type_id")
            ->join('programme_types', 'programme_types.id', '=', 'programmes.programme_type_id')
            // ->whereDate("start_date", "<=", today())
            // ->whereDate("end_date", ">=", today())
            ->where('prog_type_code', '=', 'PG')
            ->select("candidate_form_types.*", "programmes.name AS programme", "form_settings.*")
            ->get();

        return view('pages.forms.auth.spgs-programmes', compact('programmes'));
    }
}
