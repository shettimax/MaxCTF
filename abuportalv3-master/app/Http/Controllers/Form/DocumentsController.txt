<?php

namespace App\Http\Controllers\Form;

use App\Http\Controllers\Controller;
use App\Models\Candidate;
use App\Models\CandidateDocument;
use App\Services\ExternalFileService;
use Exception;
use Illuminate\Contracts\Foundation\Application;
use Illuminate\Contracts\View\Factory;
use Illuminate\Contracts\View\View;
use Illuminate\Http\JsonResponse;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class DocumentsController extends Controller
{
    protected $externalFileService;

    public function __construct(ExternalFileService $externalFileService)
    {
        $this->middleware(["auth:candidate"]);
        $this->externalFileService = $externalFileService;
    }

    public function index()
    {
        $candidate = Auth::guard("candidate")->user();
        if (!$candidate->admitted())
            return redirect()->route('forms.dashboard');

        $documents = CandidateDocument::where('candidate_id', Auth::id())->first()->documents ?? [];

        // Get external URLs for documents
        $documentsWithUrls = [];
        foreach ($documents as $doc) {
            $doc['external_url'] = $this->externalFileService->getUrl($doc['document']);
            $documentsWithUrls[] = $doc;
        }

        return view('pages.forms.profile.documents', compact('documentsWithUrls','documents'));
    }

    public function upload(Request $request): RedirectResponse
    {
        try {
            $request->validate([
                'file' => 'required|file|mimes:jpg,jpeg,png,pdf|max:200',
                'type' => 'required|string|max:255',
            ]);

            $candidate = Auth::user();
            $type = $request->input('type');

            $extension = $request->file('file')->getClientOriginalExtension();
            $docName = $candidate->id . '-' . strtolower(str_replace(' ', '-', $type)) . '.' . $extension;
            $documentPath = "candidate/documents/$docName";

            // Upload to external server
            $result = $this->externalFileService->uploadWithRetry($request->file('file'), $documentPath, [
                'category' => 'candidate_document',
                'candidate_id' => $candidate->id,
                'document_type' => $type,
                'original_name' => $docName,
                'size' => $request->file('file')->getSize(),
                'mime_type' => $request->file('file')->getMimeType()
            ]);

            if (!$result['success']) {
                Log::error('Failed to upload candidate document to external server', [
                    'candidate_id' => $candidate->id,
                    'type' => $type,
                    'error' => $result['error']
                ]);

                return redirect()->back()->with('error', 'Failed to upload document: ' . $result['error']);
            }

            // Store document reference in database
            $candidateDocs = CandidateDocument::firstOrCreate(['candidate_id' => $candidate->id, 'documents' => []]);
            $docs = $candidateDocs->documents ?? [];

            $replaced = false;
            foreach ($docs as &$doc) {
                if ($doc['type'] == $type) {
                    $doc['document'] = $documentPath;
                    $doc['external_id'] = $result['external_id'];
                    $doc['external_url'] = $result['url'];
                    $doc['uploaded_at'] = now()->toISOString();
                    $replaced = true;
                    break;
                }
            }

            if (!$replaced) {
                $docs[] = [
                    'document' => $documentPath,
                    'external_id' => $result['external_id'],
                    'external_url' => $result['url'],
                    'type' => $type,
                    'uploaded_at' => now()->toISOString(),
                ];
            }

            $candidateDocs->documents = $docs;
            $candidateDocs->save();

            Log::info('Candidate document uploaded successfully to external server', [
                'candidate_id' => $candidate->id,
                'type' => $type,
                'external_id' => $result['external_id'],
                'url' => $result['url']
            ]);

            return redirect()->back()->with('success', 'Document uploaded successfully to external server.');

        } catch (Exception $e) {
            Log::error('Exception during candidate document upload', [
                'candidate_id' => Auth::id(),
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            return redirect()->back()->with('error', 'Upload failed: ' . $e->getMessage());
        }
    }

    /**
     * Delete document from external server and database
     */
    public function delete(Request $request): RedirectResponse
    {
        try {
            $request->validate([
                'document_path' => 'required|string',
                'type' => 'required|string'
            ]);

            $candidate = Auth::user();
            $documentPath = $request->input('document_path');
            $type = $request->input('type');

            // Delete from external server
            if ($this->externalFileService->delete($documentPath)) {
                // Remove from database
                $candidateDocs = CandidateDocument::where('candidate_id', $candidate->id)->first();
                if ($candidateDocs) {
                    $docs = $candidateDocs->documents ?? [];
                    $docs = array_filter($docs, function($doc) use ($type) {
                        return $doc['type'] !== $type;
                    });

                    $candidateDocs->documents = array_values($docs);
                    $candidateDocs->save();
                }

                Log::info('Candidate document deleted successfully from external server', [
                    'candidate_id' => $candidate->id,
                    'type' => $type,
                    'path' => $documentPath
                ]);

                return redirect()->back()->with('success', 'Document deleted successfully.');
            } else {
                return redirect()->back()->with('error', 'Failed to delete document from external server.');
            }

        } catch (Exception $e) {
            Log::error('Exception during candidate document deletion', [
                'candidate_id' => Auth::id(),
                'error' => $e->getMessage()
            ]);

            return redirect()->back()->with('error', 'Deletion failed: ' . $e->getMessage());
        }
    }
}
