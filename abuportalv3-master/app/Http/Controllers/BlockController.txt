<?php

namespace App\Http\Controllers;
use App\Models\Hostel;;
use App\Models\Block;;
use App\Models\Accommodation;;

use Auth;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Validator;

class BlockController extends Controller {

    /**
     * Display a listing of the resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function index(Request $request, $hid=null) {
        //
        $arrdata = array();
        if($hid != null){
            $selectedhostel = Hostel::find($hid);
            $arrdata['selectedhostel']= $selectedhostel;
        }
        $hostels = Hostel::all();
        $arrdata['hostels']= $hostels;
        return view('pages.staff.accommodation.block.index', $arrdata);
    }

    public function getBlockHTMLList(Request $request) {
        $id = $request->query->get('hostel_id');
        //echo $id; exit;
        $hostel = Hostel::findOrFail($id);
        $blocks = $hostel->blocks;
        //var_dump($blocks); exit();
        return view('pages.staff.accommodation.block.blocklist', array('blocks' => $blocks, 'hostel'=>$hostel));
    }

    public function getBlockOptions(Request $request) {
        $id = $request->query->get('hostel_id');
        //echo $id; exit;
        $hostel = Hostel::findOrFail($id);
        $blocks = $hostel->blocks;
        //var_dump($blocks); exit();
        return view('pages.staff.accommodation.block.blockoptions', array('blocks' => $blocks));
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create(Request $request, $id=null) {
        //
        if($id == null){
            $id = $request->query->get('id');
        }
        $hostel = Hostel::findOrFail($id);
        return view("pages.staff.accommodation.block.create", array('hostel'=>$hostel));
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\Response
     */
    public function store(Request $request) {
        //

        $validator = Validator::make($request->all(), [
                    'name' => 'required',
                    'studcat' => 'required',
                    'gender' => 'required|in:male,female',
                    'fee' => 'nullable|numeric|min:0',
                    'studtype' => 'required|array',
                    'hostel_id' => 'required|numeric'
        ]);
        if ($validator->fails()) {
            return redirect()->route('accommodation.admin.block.create',['id'=>$request->request->get('hostelid')])
                            ->withErrors($validator)
                            ->withInput();
        }

        $studtype = $request->request->get('studtype');
        $progcode = Accommodation::getStudTypeSpec($studtype);
        $block = new Block();
        $block->name = $request->request->get('name');
        $block->studcat = $request->request->get('studcat');
        $block->gender = $request->request->get('gender');
        $block->studtype = $progcode;
        $block->status = $request->request->get('status');
        $block->hostel_id = $request->request->get('hostelid');
        $block->fee = $request->request->get('fee');
        $block->save();
        return redirect()->route('accommodation.admin.block.show', array('id' => $block->id));
    }

    /**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function show(Request $request, $id = null) {
        if ($id == null) {
            $id = $request->query->get('id');
        }
        $block = Block::findOrFail($id);

        return view("pages.staff.accommodation.block.view", array("block" => $block));
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function edit(Request $request, $id = null) {
        if ($id == null) {
            $id = $request->query->get('id');
        }
        $block = Block::findOrFail($id);
        return view("pages.staff.accommodation.block.edit", array("block" => $block));
        //
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request) {
        //
        $validator = Validator::make($request->all(), [
                    'name' => 'required',
                    'studcat' => 'required',
                    'gender' => 'required|in:male,female',
                    'fee' => 'nullable|numeric|min:0',
                    'studtype' => 'required|array'
        ]);
        if ($validator->fails()) {
            return redirect()->route('accommodation.admin.block.edit',['id'=>$request->request->get('block_id')])
                            ->withErrors($validator)
                            ->withInput();
        }

        $block = Block::findOrFail($request->request->get('block_id'));
        $block->name = $request->request->get('name');
        $block->studcat = $request->request->get('studcat');
        $block->gender = $request->request->get('gender');
        $studtype = $request->request->get('studtype');
        $progcode = Accommodation::getStudTypeSpec($studtype);
        $block->studtype = $progcode;
        $block->status = $request->request->get('status');
        if ($request->request->get('blockroomfee') == 'fee') {
            $block->fee = null;
        } else {
            $block->fee = $request->request->get('fee');
        }
        $block->save();
        $request->session()->flash('success', 'Block update was successful!');
        return redirect()->route('accommodation.admin.block.show', array('id' => $block->id));
    }

    /**
     * Toggle the status of the block
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function toggleStatus(Request $request, $id = null) {
        if ($id == null) {
            $id = $request->query->get('id');
        }

        $block = Block::findOrFail($id);
        if ($block->status == '1') {
            $block->status = '0';
        } else {
            $block->status = '1';
        }
        $block->save();
        return view("pages.staff.accommodation.block.view", array("block" => $block));
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id) {
        //
    }

    public function getReservableBlockOptions(Request $request) {
        $hostelid = ($request->query('hostelid')) ? ($request->query('hostelid')) : (null);
        $isadmin = ($request->query->get('isadmin') == '1' ? (true) : (false));
        $blocks = array();
        if (!(null === $hostelid || $hostelid == "")) {
            $hostel = Hostel::where([['id', $hostelid]])->first();
            if ($hostel) {
                if ($isadmin) {
                    $studentid = $request->query->get('student_id');
                    $student = Student::findOrFail($studentid);
                } else {
                    $student = Auth::user();
                }
                $blocks = $hostel->getReservableBlock($student, $isadmin);
            }
            /**
            $genderopt = ['gender', strtolower(Auth::user()->gender)];
            $hostelopt = ['hostel_id', $hostelid];
            $options = [$hostelopt, ['status', '1'], $genderopt];
            $options = array_filter($options);
            //print_r($options);exit();
            $blocks = Block::where($options)->orderBy('name', 'asc')->get();
             */
        }

        if ($isadmin) {
            return view("partialpages.hostel.blockoptions", array("blocks" => $blocks));
        } else {
            return view("partialpages.hostel.blockoptions", array("blocks" => $blocks));
        }
    }


}
