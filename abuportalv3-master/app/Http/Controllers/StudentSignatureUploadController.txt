<?php

namespace App\Http\Controllers;

use App\Services\ExternalFileService;
use App\Services\FileStorageMigrationService;
use Exception;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Intervention\Image\Facades\Image;

class StudentSignatureUploadController extends Controller
{
    protected ExternalFileService $externalFileService;
    protected FileStorageMigrationService $migrationService;

    /**
     * Display a listing of the resource.
     *
     * @return Response
     */
    public function __construct(ExternalFileService $externalFileService, FileStorageMigrationService $migrationService)
    {
        $this->middleware(['auth:student', 'mmode']);
        $this->externalFileService = $externalFileService;
        $this->migrationService = $migrationService;
    }

    public function index()
    {
        $student = Auth::user();
        $matricNumber = $student->matric_number;

        // Get signature URL using migration service (with fallback)
        $url = $this->migrationService->getStudentSignatureUrl($matricNumber, true);

        return view('pages.student.profile.signatureupload', compact('url'));
    }

    public function uploadSignature(Request $request)
    {
        try {
            $student = Auth::user();
            $matricNumber = $student->matric_number;

            $this->validate($request, [
                'file' => 'required|image|mimes:jpeg,jpg|max:120'
            ], [
                'file.required' => 'Please select a file to upload.',
                'file.image' => 'The file must be an image.',
                'file.mimes' => 'The file must be a JPEG or JPG image.',
                'file.max' => 'The file size must not exceed 120 KB.'
            ]);

            $file = $request->file('file');
            $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";

            // Process image if needed
            $fileToUpload = $file;
            if (in_array($file->getMimeType(), ['image/jpeg', 'image/jpg', 'image/png'])) {
                // Create optimized signature image
                $image = Image::make($file);
                $image->resize(300, 150, function ($constraint) {
                    $constraint->aspectRatio();
                    $constraint->upsize();
                });

                // Save processed image temporarily
                $tempPath = storage_path('app/temp/' . $fileName);

                // Ensure temp directory exists
                if (!file_exists(dirname($tempPath))) {
                    mkdir(dirname($tempPath), 0755, true);
                }

                $image->save($tempPath, 90); // Save with 90% quality

                // Create a new UploadedFile instance for the processed image
                $fileToUpload = new UploadedFile(
                    $tempPath,
                    $fileName,
                    'image/jpeg',
                    null,
                    true
                );
            }

            // Check if external service is configured
            if (!$this->externalFileService->isConfigured()) {
                Log::warning('ExternalFileService not configured, saving locally as fallback', [
                    'matric_number' => $matricNumber
                ]);
                
                // Fallback: Save locally
                $localPath = public_path('studentsigns/' . $fileName);
                if (!file_exists(dirname($localPath))) {
                    mkdir(dirname($localPath), 0755, true);
                }
                
                if ($fileToUpload instanceof UploadedFile && $fileToUpload->getRealPath() !== $file->getRealPath()) {
                    // Move processed file
                    copy($fileToUpload->getRealPath(), $localPath);
                } else {
                    $file->move(dirname($localPath), $fileName);
                }
                
                // Clean up temp file if it exists
                if (isset($tempPath) && file_exists($tempPath)) {
                    unlink($tempPath);
                }
                
                Log::info('Student signature saved locally', [
                    'matric_number' => $matricNumber,
                    'path' => $localPath
                ]);

                return redirect()->route('signatureupload.index')
                    ->with('success', 'Signature uploaded successfully!')
                    ->with('uploaded', true);
            }

            // Log upload attempt
            Log::info('Attempting to upload student signature', [
                'matric_number' => $matricNumber,
                'file_name' => $fileName,
                'file_size' => $file->getSize(),
                'mime_type' => $file->getMimeType(),
                'external_service_configured' => $this->externalFileService->isConfigured()
            ]);

            // Upload to external server
            // Note: The external server uses 'original_name' from options to determine the filename
            $result = $this->externalFileService->uploadStudentSignature(
                $fileToUpload,
                $matricNumber,
                [
                    'category' => 'student_signature',
                    'original_name' => $fileName,  // Use matric number as original_name so server saves it with correct name
                    'size' => $file->getSize(),
                    'filename' => $fileName  // Also set filename for attach() method
                ]
            );

            // Clean up temp file if it exists
            if (isset($tempPath) && file_exists($tempPath)) {
                unlink($tempPath);
            }

            // Log result
            Log::info('Upload result received', [
                'matric_number' => $matricNumber,
                'success' => $result['success'] ?? false,
                'error' => $result['error'] ?? null,
                'url' => $result['url'] ?? null
            ]);

            if ($result['success']) {
                Log::info('Student signature uploaded successfully to external server', [
                    'matric_number' => $matricNumber,
                    'external_id' => $result['external_id'] ?? null,
                    'url' => $result['url'] ?? null
                ]);

                // Redirect back with success message and flag to show signature
                return redirect()->route('signatureupload.index')
                    ->with('success', 'Signature uploaded successfully!')
                    ->with('uploaded', true);
            } else {
                $errorMessage = $result['error'] ?? 'Unknown error occurred';
                $errorDetails = $result['details'] ?? 'No additional details available';
                
                Log::error('Failed to upload student signature to external server', [
                    'matric_number' => $matricNumber,
                    'error' => $errorMessage,
                    'details' => $errorDetails,
                    'result' => $result
                ]);

                // Provide more detailed error message
                $userMessage = 'Failed to upload signature. ';
                if (str_contains($errorMessage, 'not configured') || str_contains($errorMessage, 'Missing required')) {
                    $userMessage .= 'The upload service is not properly configured. Please contact the administrator.';
                } else {
                    $userMessage .= $errorMessage;
                }

                return redirect()->back()->with('error', $userMessage);
            }

        } catch (\Illuminate\Validation\ValidationException $e) {
            return redirect()->back()
                ->withErrors($e->errors())
                ->withInput();
        } catch (Exception $exception) {
            Log::error('Exception during student signature upload', [
                'matric_number' => $matricNumber ?? 'unknown',
                'error' => $exception->getMessage(),
                'trace' => $exception->getTraceAsString()
            ]);

            return redirect()->back()->with('error', 'Upload failed: ' . $exception->getMessage());
        }
    }

    public static function checkSignatureExist(string $matricNumber)
    {
        try {
            $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
            $url = "https://static.abu.edu.ng/uploads/student/signatures/" . $fileName;
            
            $response = Http::timeout(5)->head($url);

            return $response->successful() &&
                in_array($response->header('Content-Type'), ['image/jpeg', 'image/jpg']);
        } catch (\Exception $e) {
            return false;
        }
    }
}
