<?php

namespace App\Http\Controllers;
use App\Models\Hostel;
use App\Models\Block;
use App\Models\Accommodation;
use Illuminate\Http\Request;
use Illuminate\Http\Response;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Validator;

class StaffBlockController extends Controller {

    public function __construct() {
        $this->middleware('auth:staff');

    }
    public function index(Request $request, $hid=null) {
        //accommodation.admin.block.index
        $user = Auth::user();
        $permission = "accommodation.admin.block.index";
        if (!$this->access($user,$permission)){
            return response()->json(["status" => 401, "message" => "You have no permission to do this operation"]);

        }
        $arrdata = array();
        if($hid != null){
            $selectedhostel = Hostel::find($hid);
            $arrdata['selectedhostel']= $selectedhostel;
        }
        $hostels = Hostel::all();
        $arrdata['hostels']= $hostels;
        return view('pages.staff.accommodation.block.index', $arrdata);
    }

    public function getBlockHTMLList(Request $request) {
        $id = $request->query->get('hostelid');
        $hostel = Hostel::findOrFail($id);
        $blocks = $hostel->blocks;
        return view('pages.staff.accommodation.block.blocklist', array('blocks' => $blocks, 'hostel'=>$hostel));
    }

    public function getBlockOptions(Request $request) {
        $id = $request->query->get('hostelid');
        $hostel = Hostel::findOrFail($id);
        $blocks = $hostel->blocks;
        return view('pages.staff.accommodation.block.blockoptions', array('blocks' => $blocks));
    }

    /**
     * Show the form for creating a new resource.
     *
     * @return \Illuminate\Http\Response
     */
    public function create(Request $request, $id=null) {
        //
        if($id == null){
            $id = $request->query->get('id');
        }
        $hostel = Hostel::findOrFail($id);
        return view("pages.staff.accommodation.block.create", array('hostel'=>$hostel));
    }

    /**
     * Store a newly created resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @return \Illuminate\Http\RedirectResponse
     */
    public function store(Request $request)
    {
        //

        $validator = Validator::make($request->all(), [
            'blockname' => 'required',
            'studcat' => 'required',
            'gender' => 'required|in:male,female',
            'fee' => 'nullable|numeric|min:0',
            'studtype' => 'required|array',
            'hostelid' => 'required|numeric'
        ]);
        if ($validator->fails()) {
            return redirect()->route('accommodation.admin.block.create', ['id' => $request->request->get('hostelid')])
                ->withErrors($validator)
                ->withInput();
        }

        $studtype = $request->input('studtype');
        $progcode = Accommodation::getStudTypeSpec($studtype);
        $block = new Block();
        $block->name = $request->input('blockname');
        $block->studcat = $request->input('studcat');
        $block->gender = $request->input('gender');
        $block->studtype = $progcode;
        $block->status = $request->input('status');
        $block->hostel_id = $request->input('hostelid');
        $block->fee = ($request->input('blockfee') > 0) ? ($request->input('blockfee')) : (null);
        $block->save();
        return redirect()->route('accommodation.admin.block.show', array('id' => $block->id));

    }

    /**
     * Display the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function show(Request $request, $id = null) {
        if ($id == null) {
            $id = $request->query->get('id');
        }
        $block = Block::findOrFail($id);

        return view("pages.staff.accommodation.block.view", array("block" => $block));
    }

    /**
     * Show the form for editing the specified resource.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function edit(Request $request, $id = null) {
        if ($id == null) {
            $id = $request->query->get('id');
        }
        $block = Block::findOrFail($id);
        return view("pages.staff.accommodation.block.edit", array("block" => $block));
        //
    }

    /**
     * Update the specified resource in storage.
     *
     * @param  \Illuminate\Http\Request  $request
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function update(Request $request) {
        //
        $validator = Validator::make($request->all(), [
            'blockname' => 'required',
            'studcat' => 'required',
            'gender' => 'required|in:male,female',
            'fee' => 'nullable|numeric|min:0',
            'studtype' => 'required|array'
        ]);
        if ($validator->fails()) {
            return redirect()->route('accommodation.admin.block.edit',['id'=>$request->input('blockid')])
                ->withErrors($validator)
                ->withInput();
        }

        $block = Block::findOrFail($request->input('blockid'));
        $block->name = $request->input('blockname');
        $block->studcat = $request->input('studcat');
        $block->gender = $request->input('gender');
        $studtype = $request->input('studtype');
        $progcode = Accommodation::getStudTypeSpec($studtype);
        $block->studtype = $progcode;
        $block->status = $request->input('status');
        if ($request->input('blockroomfee') == 'fee') {
            $block->fee = null;
        } else {
            $block->fee = $request->input('blockfee');
        }
        $block->save();
        $request->session()->flash('success', 'Block update was successful!');
        return redirect()->route('accommodation.admin.block.show', array('id' => $block->id));
    }

    /**
     * Toggle the status of the block
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function toggleStatus(Request $request, $id = null) {
        if ($id == null) {
            $id = $request->query->get('id');
        }

        $block = Block::findOrFail($id);
        if ($block->status == '1') {
            $block->status = '0';
        } else {
            $block->status = '1';
        }
        $block->save();
        return view("pages.staff.accommodation.block.view", array("block" => $block));
    }

    /**
     * Remove the specified resource from storage.
     *
     * @param  int  $id
     * @return \Illuminate\Http\Response
     */
    public function destroy($id) {
        //
    }

    public function getBlocks($hostelId) {
        return Block::where('hostel_id', $hostelId)->get();
    }

}