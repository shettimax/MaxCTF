<?php


namespace App\Http\Remita;


use App\Models\Transaction;
use GuzzleHttp\Client;
use GuzzleHttp\Exception\GuzzleException;
use App\Models\Student;

class Remita
{

    /**
     * @var $private_key
     */
    protected $private_key;

    /**
     *
     * @var $api_url
     *
     */
    protected $api_url = 'https://login.remita.net/remita/';
    /**
     *
     * @var $demo_api_url
     *
     */
    protected $FORMSERVICEID = '931530395';
    protected $FEESERVICEID = '10002';


    /**
     * @var $client
     *
     */
    protected $client;

    //Construction

    public function __construct()
    {
        // Trim Key


        // Generate Authorization String
        $base_uri = $this->api_url;

        $this->client = new Client([
            'base_uri' => $base_uri,
            'protocols' => ['https']
        ]);
    }

    private function request($url,$type,$header,$body)
    {
        return $this->client->request($type,$url,[
            'headers' => array_merge(
                [
                    'Content-Type' => 'application/json'
                ],
                $header
            ),
            "json"=>$body
        ]);

    }

    private function serviceType($code){
        $serviceTypes = [
            "UG"=>Transaction::FEESERVICETYPEID,
            "AD"=>Transaction::DPFEESSERVICETYPEID,
            "HD"=>Transaction::DPFEESSERVICETYPEID,
            "DP"=>Transaction::DPFEESSERVICETYPEID,
            "ND"=>Transaction::DPFEESSERVICETYPEID,
            "PD"=>Transaction::DPFEESSERVICETYPEID,
            "LV"=>Transaction::LVTFEESSERVICETYPEID,
            "PG"=>Transaction::PGFEESERVICETYPEID
        ];
        return $serviceTypes[$code];
    }

    public function generateRRR(Transaction $transaction)
    {
        $student = $transaction->student();
        $biodata = $student->biodata();
        $mert = Transaction::MERCHANTID;
        $api_key = Transaction::APIKEY;
        $session = $transaction->session;
        $servType = $this->serviceType(strtoupper($student->mode_of_entry));
        $concatString = Transaction::MERCHANTID . $servType . $transaction->transaction_code . intval($transaction->transaction_amount) . $api_key;
        $hash = hash('sha512', $concatString);
        $data = [
            "serviceTypeId" => $servType,
            "amount" => intval($transaction->transaction_amount),
            "payerName" => $student->getFullName(),
            "description" => "Registration Charges",
            "payerEmail" => $biodata->email,
            "payerPhone" => $biodata->gsm,
            "orderId" => $transaction->transaction_code,
            "customFields" => [
                ["name" => "Matric No", "value" => $student->matric_number, "type" => "All"],
                ["name" => "Session", "value" => $session, "type" => "All"],
                ["name" => "Transaction Code", "value" => $transaction->transaction_code, "type" => "All"],
            ]
        ];
        $data_string = json_encode($data);
        $response = $this->request(
            "exapp/api/v1/send/api/echannelsvc/merchant/api/paymentinit",
            "POST",
            [
                'Authorization' => "remitaConsumerKey=$mert,remitaConsumerToken=$hash",
                "Content-Type"=>"application/json",
                "Content-Length"=>strlen($data_string)
            ],
            $data);
        $response = substr($response, 7);
        $response = substr($response, 0, -1);
        $responseObj = json_decode($response->getBody()->getContents());
        if($responseObj->ResponseCode=='00' && $responseObj->ResponseDesc=='Success'){
            $student->wallet_number = $responseObj->AccountNo;
            $student->save();
            return 1;
        }

        return $responseObj->ResponseCode;
    }


    public function verify($transaction)
    {

        if( $this->payment_status =="Waived" || in_array($this->branch_id,['548','549']) || $this->session < 2019)
            return;
        try {

            $hash = hash("sha512",$transaction->invoice_number.Transaction::APIKEY.Transaction::MERCHANTID);
            $ch = curl_init("https://login.remita.net/remita/ecomm/".(Transaction::MERCHANTID)."/".$transaction->invoice_number."/$hash/status.reg");
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
            curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "GET");
            $response = curl_exec($ch);
            $response = json_decode($response);
            if(isset($response->status)){
                if($response->status == "01" || $response->status == "00"){
                    $payment_date = str_replace("AM","",$response->paymentDate);
                    $payment_date = trim(str_replace("PM","",$payment_date));
                    $transaction_date = str_replace("AM","",$response->transactiontime);
                    $transaction_date = trim(str_replace("PM","",$transaction_date));
                    $transaction->transaction_amount = $response->amount;
                    $transaction->payment_date = $payment_date;
                    $transaction->transaction_date = $transaction_date;
                    $transaction->payment_status = "Paid";
                    $transaction->save();
                }else{
//                    $this->payment_status = "Not Paid";
                    $transaction->save();

                }
            }
        }catch (\Exception $e){

        }
        $student = $transaction->student();
        $requestArr = [
            "IDType"=>"ABU-Student","IDValue"=>$transaction->transaction_code,
            "WalletAccount"=>$student->wallet_number,
            "PurposeCode"=>"FEE",
            "Narration"=>"Payment ".$transaction->session,
            "Amount"=>$transaction->transaction_amount,

        ];
        $response = $this->request("/SchoolCollection/PaymentInstruction","POST",['ServiceId' => $this->PAYMENTSERVICEID,"TranID"=>$transaction->transaction_code."-09199"],$requestArr);
        return [
            $responseObj = json_decode($response->getBody()->getContents())
        ];
        if($responseObj->ResponseCode=='00' && $responseObj->ResponseDesc=='Success'){
            $transaction->payment_status = "Paid";
            $transaction->save();
            return 1;
        }

        return $responseObj->ResponseCode;

    }


}
