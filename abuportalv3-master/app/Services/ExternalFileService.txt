<?php

namespace App\Services;

use Illuminate\Http\UploadedFile;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;
use Exception;

class ExternalFileService
{
    protected $apiUrl;
    protected $apiKey;
    protected $timeout;
    protected $retryAttempts;

    public function __construct()
    {
        try {
            // Use external-files config as primary source, fallback to filesystems
            $this->apiUrl = config('external-files.api_url') ?? config('filesystems.external.api_url', 'https://static.abu.edu.ng/api');
            $this->apiKey = config('external-files.api_key') ?? config('filesystems.external.api_key', '');
            $this->timeout = config('external-files.timeout') ?? config('filesystems.external.timeout', 30);
            $this->retryAttempts = config('external-files.retry_attempts') ?? config('filesystems.external.retry_attempts', 3);

            // Ensure URL doesn't end with slash for consistent endpoint building
            $this->apiUrl = rtrim($this->apiUrl, '/');

            // Validate required configuration
            if (empty($this->apiUrl) || empty($this->apiKey)) {
                Log::warning('ExternalFileService: Missing required configuration values', [
                    'api_url' => $this->apiUrl,
                    'api_key_set' => !empty($this->apiKey)
                ]);
            }

            Log::info('ExternalFileService initialized', [
                'api_url' => $this->apiUrl,
                'timeout' => $this->timeout,
                'retry_attempts' => $this->retryAttempts
            ]);
        } catch (\Exception $e) {
            Log::error('ExternalFileService: Error during initialization', [
                'error' => $e->getMessage()
            ]);

            // Set default values if configuration fails
            $this->apiUrl = 'https://static.abu.edu.ng/api';
            $this->apiKey = '';
            $this->timeout = 30;
            $this->retryAttempts = 3;
        }
    }

    /**
     * Check if the service is properly configured
     */
    public function isConfigured(): bool
    {
        return !empty($this->apiUrl) &&
            !empty($this->apiKey) &&
            $this->apiUrl !== 'https://your-external-server.com/api';
    }

    /**
     * Upload file to external server
     */
    public function upload(UploadedFile $file, string $path, array $options = []): array
    {
        try {
            // Extract filename from path or use provided filename in options, fallback to original name
            $fileName = $options['filename'] ?? (!empty($path) ? basename($path) : $file->getClientOriginalName());
            
            $response = Http::timeout($this->timeout)
                ->withHeaders([
                    'Authorization' => 'Bearer ' . $this->apiKey,
                    'Accept' => 'application/json',
                ])
                ->attach('file', $file->get(), $fileName)
                ->post($this->apiUrl . '/upload', [
                    'path' => $path,
                    'options' => json_encode($options)
                ]);

            if ($response->successful()) {
                $data = $response->json();
                Log::info('File uploaded successfully to external server', [
                    'path' => $path,
                    'external_id' => $data['id'] ?? null,
                    'url' => $data['url'] ?? null
                ]);

                return [
                    'success' => true,
                    'external_id' => $data['id'] ?? null,
                    'url' => $data['url'] ?? null,
                    'path' => $data['path'] ?? $path,
                    'size' => $data['size'] ?? $file->getSize(),
                    'mime_type' => $data['mime_type'] ?? $file->getMimeType()
                ];
            }

            Log::error('Failed to upload file to external server', [
                'path' => $path,
                'status' => $response->status(),
                'response' => $response->body()
            ]);

            return [
                'success' => false,
                'error' => 'Upload failed: ' . $response->status(),
                'details' => $response->body()
            ];

        } catch (Exception $e) {
            Log::error('Exception during file upload to external server', [
                'path' => $path,
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString()
            ]);

            return [
                'success' => false,
                'error' => 'Upload exception: ' . $e->getMessage()
            ];
        }
    }

    /**
     * Upload file with retry mechanism
     */
    public function uploadWithRetry(UploadedFile $file, string $path, array $options = []): array
    {
        $attempt = 0;

        while ($attempt < $this->retryAttempts) {
            $result = $this->upload($file, $path, $options);

            if ($result['success']) {
                return $result;
            }

            $attempt++;
            Log::warning("Upload attempt {$attempt} failed, retrying...", [
                'path' => $path,
                'error' => $result['error'] ?? 'Unknown error'
            ]);

            if ($attempt < $this->retryAttempts) {
                sleep(2); // Wait 2 seconds before retry
            }
        }

        return [
            'success' => false,
            'error' => "Upload failed after {$this->retryAttempts} attempts"
        ];
    }

    /**
     * Get file URL from external server
     */
    public function getUrl(string $path): ?string
    {
        try {
            $response = Http::timeout($this->timeout)
                ->withHeaders([
                    'Authorization' => 'Bearer ' . $this->apiKey,
                    'Accept' => 'application/json',
                ])
                ->get($this->apiUrl . '/file/url', [
                    'path' => $path
                ]);

            if ($response->successful()) {
                $data = $response->json();
                return $data['url'] ?? null;
            }

            Log::warning('Failed to get file URL from external server', [
                'path' => $path,
                'status' => $response->status()
            ]);

            return null;

        } catch (Exception $e) {
            Log::error('Exception getting file URL from external server', [
                'path' => $path,
                'error' => $e->getMessage()
            ]);
            return null;
        }
    }

    /**
     * Delete file from external server
     */
    public function delete(string $path): bool
    {
        try {
            // Use POST method with form data as the upload handler expects
            $response = Http::timeout($this->timeout)
                ->withHeaders([
                    'Authorization' => 'Bearer ' . $this->apiKey,
                    'Accept' => 'application/json',
                ])
                ->asForm() // Explicitly set content type to application/x-www-form-urlencoded
                ->post($this->apiUrl . '/file/delete', [
                    'path' => $path
                ]);

            if ($response->successful()) {
                Log::info('File deleted successfully from external server', ['path' => $path]);
                return true;
            }

            Log::warning('Failed to delete file from external server', [
                'path' => $path,
                'status' => $response->status(),
                'response' => $response->body()
            ]);

            return false;

        } catch (Exception $e) {
            Log::error('Exception deleting file from external server', [
                'path' => $path,
                'error' => $e->getMessage()
            ]);
            return false;
        }
    }

    /**
     * Check if file exists on external server
     */
    public function exists(string $path): bool
    {
        try {
            $response = Http::timeout($this->timeout)
                ->withHeaders([
                    'Authorization' => 'Bearer ' . $this->apiKey,
                    'Accept' => 'application/json',
                ])
                ->get($this->apiUrl . '/file/exists', [
                    'path' => $path
                ]);

            return $response->successful() && $response->json('exists', false);

        } catch (Exception $e) {
            Log::error('Exception checking file existence on external server', [
                'path' => $path,
                'error' => $e->getMessage()
            ]);
            return false;
        }
    }

    /**
     * Get file metadata from external server
     */
    public function getMetadata(string $path): ?array
    {
        try {
            $response = Http::timeout($this->timeout)
                ->withHeaders([
                    'Authorization' => 'Bearer ' . $this->apiKey,
                    'Accept' => 'application/json',
                ])
                ->get($this->apiUrl . '/file/metadata', [
                    'path' => $path
                ]);

            if ($response->successful()) {
                return $response->json();
            }

            return null;

        } catch (Exception $e) {
            Log::error('Exception getting file metadata from external server', [
                'path' => $path,
                'error' => $e->getMessage()
            ]);
            return null;
        }
    }

    /**
     * Test connection to external server
     */
    public function testConnection(): array
    {
        try {
            $response = Http::timeout($this->timeout)
                ->withHeaders([
                    'Accept' => 'application/json',
                ])
                ->get($this->apiUrl . '/status');

            if ($response->successful()) {
                $data = $response->json();
                Log::info('External file server connection test successful', $data);

                return [
                    'success' => true,
                    'status' => 'online',
                    'server_info' => $data,
                    'response_time' => $response->handlerStats()['total_time'] ?? null
                ];
            }

            Log::warning('External file server connection test failed', [
                'status' => $response->status(),
                'response' => $response->body()
            ]);

            return [
                'success' => false,
                'status' => 'offline',
                'error' => 'Server returned status: ' . $response->status(),
                'response' => $response->body()
            ];

        } catch (Exception $e) {
            Log::error('Exception during external file server connection test', [
                'error' => $e->getMessage()
            ]);

            return [
                'success' => false,
                'status' => 'error',
                'error' => $e->getMessage()
            ];
        }
    }

    /**
     * Get service configuration for debugging
     */
    public function getConfig(): array
    {
        return [
            'api_url' => $this->apiUrl,
            'api_key_set' => !empty($this->apiKey),
            'api_key_length' => strlen($this->apiKey),
            'timeout' => $this->timeout,
            'retry_attempts' => $this->retryAttempts,
            'is_configured' => $this->isConfigured()
        ];
    }

    /**
     * Get default file paths from configuration
     */
    public function getDefaultPaths(): array
    {
        return config('external-files.paths', []);
    }

    /**
     * Get file size limits from configuration
     */
    public function getFileLimits(): array
    {
        return config('external-files.limits', []);
    }

    /**
     * Get allowed file types from configuration
     */
    public function getAllowedTypes(): array
    {
        return config('external-files.allowed_types', []);
    }

    /**
     * Upload student photo with standardized path
     */
    public function uploadStudentPhoto($file, string $matricNumber, array $options = []): array
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $path = config('external-files.paths.student_photos', 'student/photos') . '/' . $fileName;

        return $this->uploadWithRetry($file, $path, array_merge([
            'category' => 'student_photo',
            'matric_number' => $matricNumber
        ], $options));
    }

    /**
     * Upload student signature with standardized path
     */
    public function uploadStudentSignature($file, string $matricNumber, array $options = []): array
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $path = config('external-files.paths.student_signatures', 'student/signatures') . '/' . $fileName;

        return $this->uploadWithRetry($file, $path, array_merge([
            'category' => 'student_signature',
            'matric_number' => $matricNumber,
            'filename' => $fileName,  // For attach() method
            'original_name' => $fileName  // External server uses this to determine the saved filename
        ], $options));
    }

    /**
     * Get student photo URL
     */
    public function getStudentPhotoUrl(string $matricNumber): ?string
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $path = config('external-files.paths.student_photos', 'student/photos') . '/' . $fileName;

        if ($this->exists($path)) {
            return $this->getUrl($path);
        }

        return null;
    }

    /**
     * Get student signature URL
     */
    public function getStudentSignatureUrl(string $matricNumber): ?string
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $path = config('external-files.paths.student_signatures', 'student/signatures') . '/' . $fileName;

        if ($this->exists($path)) {
            return $this->getUrl($path);
        }

        return null;
    }

    /**
     * Delete student photo
     */
    public function deleteStudentPhoto(string $matricNumber): bool
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $path = config('external-files.paths.student_photos', 'student/photos') . '/' . $fileName;

        return $this->delete($path);
    }

    /**
     * Delete student signature
     */
    public function deleteStudentSignature(string $matricNumber): bool
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $path = config('external-files.paths.student_signatures', 'student/signatures') . '/' . $fileName;

        return $this->delete($path);
    }

    /**
     * Check if student photo exists
     */
    public function studentPhotoExists(string $matricNumber): bool
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $path = config('external-files.paths.student_photos', 'student/photos') . '/' . $fileName;

        return $this->exists($path);
    }

    /**
     * Check if student signature exists
     */
    public function studentSignatureExists(string $matricNumber): bool
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $path = config('external-files.paths.student_signatures', 'student/signatures') . '/' . $fileName;

        return $this->exists($path);
    }

    // ============================================
    // CANDIDATE SPECIFIC HELPER METHODS
    // ============================================

    /**
     * Upload candidate document to external server
     */
    public function uploadCandidateDocument(UploadedFile $file, int $candidateId, string $documentType): array
    {
        $extension = $file->getClientOriginalExtension();
        $docName = $candidateId . '-' . strtolower(str_replace(' ', '-', $documentType)) . '.' . $extension;
        $documentPath = "candidate/documents/{$docName}";

        return $this->uploadWithRetry($file, $documentPath, [
            'category' => 'candidate_document',
            'candidate_id' => $candidateId,
            'document_type' => $documentType,
            'original_name' => $file->getClientOriginalName(),
            'size' => $file->getSize(),
            'mime_type' => $file->getMimeType()
        ]);
    }

    /**
     * Upload candidate photo to external server
     */
    public function uploadCandidatePhoto(UploadedFile $file, int $candidateId): array
    {
        $extension = $file->getClientOriginalExtension();
        $photoName = $candidateId . '_photo.' . $extension;
        $photoPath = "candidate/photos/{$photoName}";

        return $this->uploadWithRetry($file, $photoPath, [
            'category' => 'candidate_photo',
            'candidate_id' => $candidateId,
            'original_name' => $file->getClientOriginalName(),
            'size' => $file->getSize(),
            'mime_type' => $file->getMimeType()
        ]);
    }

    /**
     * Get candidate photo URL
     */
    public function getCandidatePhotoUrl(int $candidateId): ?string
    {
        $photoPath = "candidate/photos/{$candidateId}_photo.jpg";

        if ($this->exists($photoPath)) {
            return $this->getUrl($photoPath);
        }

        // Try alternative extensions
        $extensions = ['jpeg', 'png'];
        foreach ($extensions as $ext) {
            $photoPath = "candidate/photos/{$candidateId}_photo.{$ext}";
            if ($this->exists($photoPath)) {
                return $this->getUrl($photoPath);
            }
        }

        return null;
    }

    /**
     * Get candidate document URL
     */
    public function getCandidateDocumentUrl(int $candidateId, string $documentType): ?string
    {
        $docName = $candidateId . '-' . strtolower(str_replace(' ', '-', $documentType));

        // Try common extensions
        $extensions = ['pdf', 'jpg', 'jpeg', 'png'];
        foreach ($extensions as $ext) {
            $documentPath = "candidate/documents/{$docName}.{$ext}";
            if ($this->exists($documentPath)) {
                return $this->getUrl($documentPath);
            }
        }

        return null;
    }

    /**
     * Check if candidate photo exists
     */
    public function candidatePhotoExists(int $candidateId): bool
    {
        $extensions = ['jpg', 'jpeg', 'png'];
        foreach ($extensions as $ext) {
            $photoPath = "candidate/photos/{$candidateId}_photo.{$ext}";
            if ($this->exists($photoPath)) {
                return true;
            }
        }
        return false;
    }

    /**
     * Check if candidate document exists
     */
    public function candidateDocumentExists(int $candidateId, string $documentType): bool
    {
        $docName = $candidateId . '-' . strtolower(str_replace(' ', '-', $documentType));

        $extensions = ['pdf', 'jpg', 'jpeg', 'png'];
        foreach ($extensions as $ext) {
            $documentPath = "candidate/documents/{$docName}.{$ext}";
            if ($this->exists($documentPath)) {
                return true;
            }
        }
        return false;
    }

    /**
     * Delete candidate document
     */
    public function deleteCandidateDocument(int $candidateId, string $documentType): bool
    {
        $docName = $candidateId . '-' . strtolower(str_replace(' ', '-', $documentType));

        $extensions = ['pdf', 'jpg', 'jpeg', 'png'];
        foreach ($extensions as $ext) {
            $documentPath = "candidate/documents/{$docName}.{$ext}";
            if ($this->exists($documentPath)) {
                return $this->delete($documentPath);
            }
        }
        return false;
    }

    /**
     * Delete candidate photo
     */
    public function deleteCandidatePhoto(int $candidateId): bool
    {
        $extensions = ['jpg', 'jpeg', 'png'];
        foreach ($extensions as $ext) {
            $photoPath = "candidate/photos/{$candidateId}_photo.{$ext}";
            if ($this->exists($photoPath)) {
                return $this->delete($photoPath);
            }
        }
        return false;
    }
}
