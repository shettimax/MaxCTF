<?php

namespace App\Services;

use App\Services\ExternalFileService;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;

class FileStorageMigrationService
{
    protected ExternalFileService $externalFileService;
    protected array $fallbackPaths = [
        'student_photos' => [
            'local' => 'studentpics',
            'default' => 'studentpics/user.png'
        ],
        'student_signatures' => [
            'local' => 'studentsigns',
            'default' => 'studentsigns/user.png'
        ],
        'candidate_photos' => [
            'local' => 'candidatepics',
            'default' => 'studentpics/user.png'
        ]
    ];

    public function __construct(ExternalFileService $externalFileService)
    {
        $this->externalFileService = $externalFileService;
    }

    /**
     * Get student photo URL with fallback logic
     */
    public function getStudentPhotoUrl(string $matricNumber, bool $useExternal = true): string
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";

        if ($useExternal && $this->externalFileService->isConfigured()) {
            $externalUrl = $this->externalFileService->getStudentPhotoUrl($matricNumber);
            if ($externalUrl) {
                return $externalUrl;
            }
        }

        // Fallback to local storage
        $localPath = public_path("studentpics/{$fileName}");
        if (file_exists($localPath)) {
            return asset("studentpics/{$fileName}");
        }

        // Default image
        return asset($this->fallbackPaths['student_photos']['default']);
    }

    /**
     * Get student signature URL with fallback logic
     */
    public function getStudentSignatureUrl(string $matricNumber, bool $useExternal = true): string
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";

        if ($useExternal && $this->externalFileService->isConfigured()) {
            $externalUrl = $this->externalFileService->getStudentSignatureUrl($matricNumber);
            if ($externalUrl) {
                return $externalUrl;
            }
        }

        // Fallback to local storage
        $localPath = public_path("studentsigns/{$fileName}");
        if (file_exists($localPath)) {
            return asset("studentsigns/{$fileName}");
        }

        // Default image
        return asset($this->fallbackPaths['student_signatures']['default']);
    }

    /**
     * Migrate single student photo from local to external
     */
    public function migrateStudentPhoto(string $matricNumber): array
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $localPath = public_path("studentpics/{$fileName}");

        if (!file_exists($localPath)) {
            return [
                'success' => false,
                'error' => 'Local file does not exist',
                'path' => $localPath
            ];
        }

        try {
            // Create UploadedFile instance from local file
            $uploadedFile = new \Illuminate\Http\UploadedFile(
                $localPath,
                $fileName,
                'image/jpeg',
                null,
                true
            );

            $result = $this->externalFileService->uploadStudentPhoto(
                $uploadedFile,
                $matricNumber,
                ['migrated_from_local' => true]
            );

            if ($result['success']) {
                Log::info("Successfully migrated student photo", [
                    'matric_number' => $matricNumber,
                    'external_url' => $result['url']
                ]);
            }

            return $result;

        } catch (\Exception $e) {
            Log::error("Failed to migrate student photo", [
                'matric_number' => $matricNumber,
                'error' => $e->getMessage()
            ]);

            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }

    /**
     * Migrate single student signature from local to external
     */
    public function migrateStudentSignature(string $matricNumber): array
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        $localPath = public_path("studentsigns/{$fileName}");

        if (!file_exists($localPath)) {
            return [
                'success' => false,
                'error' => 'Local file does not exist',
                'path' => $localPath
            ];
        }

        try {
            // Create UploadedFile instance from local file
            $uploadedFile = new \Illuminate\Http\UploadedFile(
                $localPath,
                $fileName,
                'image/jpeg',
                null,
                true
            );

            $result = $this->externalFileService->uploadStudentSignature(
                $uploadedFile,
                $matricNumber,
                ['migrated_from_local' => true]
            );

            if ($result['success']) {
                Log::info("Successfully migrated student signature", [
                    'matric_number' => $matricNumber,
                    'external_url' => $result['url']
                ]);
            }

            return $result;

        } catch (\Exception $e) {
            Log::error("Failed to migrate student signature", [
                'matric_number' => $matricNumber,
                'error' => $e->getMessage()
            ]);

            return [
                'success' => false,
                'error' => $e->getMessage()
            ];
        }
    }

    /**
     * Get migration status for a student
     */
    public function getStudentMigrationStatus(string $matricNumber): array
    {
        return [
            'matric_number' => $matricNumber,
            'photo' => [
                'local_exists' => $this->hasLocalPhoto($matricNumber),
                'external_exists' => $this->externalFileService->studentPhotoExists($matricNumber),
                'external_url' => $this->externalFileService->getStudentPhotoUrl($matricNumber)
            ],
            'signature' => [
                'local_exists' => $this->hasLocalSignature($matricNumber),
                'external_exists' => $this->externalFileService->studentSignatureExists($matricNumber),
                'external_url' => $this->externalFileService->getStudentSignatureUrl($matricNumber)
            ]
        ];
    }

    /**
     * Check if local photo exists
     */
    private function hasLocalPhoto(string $matricNumber): bool
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        return file_exists(public_path("studentpics/{$fileName}"));
    }

    /**
     * Check if local signature exists
     */
    private function hasLocalSignature(string $matricNumber): bool
    {
        $fileName = str_replace("/", "_", strtoupper($matricNumber)) . ".JPG";
        return file_exists(public_path("studentsigns/{$fileName}"));
    }

    /**
     * Get configuration for migration
     */
    public function getMigrationConfig(): array
    {
        return [
            'external_service_configured' => $this->externalFileService->isConfigured(),
            'external_service_online' => $this->externalFileService->testConnection()['success'] ?? false,
            'fallback_paths' => $this->fallbackPaths,
            'migration_mode' => config('external-files.migration_mode', 'gradual') // gradual, immediate, disabled
        ];
    }
}
