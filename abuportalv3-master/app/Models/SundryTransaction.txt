<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class SundryTransaction extends Model
{
    //
    public static function generateTransactionID()
    {

        $random = mt_rand(intval(100000000),intval(999999999));
        while(isset(SundryTransaction::where(["transaction_code"=>"PSC".$random])->first()->id)){
            $random = mt_rand(intval(100000000),intval(999999999));
        }
        return "PSC".$random;
    }

    public static function paySundry1($candform,$amount)
    {
//        $candform = CandidateForm::find($candidate_form_id);
        $localTrans = SundryTransaction::where(["payer_id"=>$candform->id,"session"=>$candform->formSetting->session,"payer_type"=>"Applicant"])->orderBy("payment_status","DESC")->get();
        $totalAmountPaid = 0;
        if(count($localTrans) === 0){
            $localTran = new SundryTransaction();
            $localTran->payer_id = $candform->id;
            $localTran->transaction_amount = $amount;
            $localTran->payment_status = "Not Paid";
            $localTran->transaction_code = SundryTransaction::generateTransactionID();
            $localTran->session = $candform->formSetting->session;
            $localTran->save();
            $localTrans[] = $localTran;
        }else{
            $pendingAmount = 0;
            $amountPaid = 0;
            foreach ($localTrans as $trans){
                if( $trans->payment_status=="Paid" )
                    $amountPaid += $trans->transaction_amount;
                else{
                    $pendingAmount += $trans->transaction_amount;
                }
            }
            if($amount > ($amountPaid + $pendingAmount) ){
                $localTran = new SundryTransaction();
                $localTran->payer_id = $candform->id;
                $localTran->transaction_amount = $amount - $amountPaid;
                $localTran->payment_status = "Not Paid";
                $localTran->transaction_code  = SundryTransaction::generateTransactionID();
                $localTran->session = $candform->formSetting->session;
                $localTran->save();
                $localTrans[] = $localTran;
            }
            $totalAmountPaid = $amountPaid;

        }
        return ["transactions"=>$localTrans,"totalAmountPaid"=>$totalAmountPaid,"amountPayable"=>$amount];

    }

    public static function paySundryStudent(Student $student, $amount, $session, $type = null)
    {
        $localTrans = SundryTransaction::where(["payer_id" => $student->id, 'code' => 'PSC', "session" => $session, "payer_type" => "Student"])->orderBy("payment_status", "DESC")->get();
        $totalAmountPaid = 0;
        if (count($localTrans) === 0) {
            $localTran = new SundryTransaction();
            $localTran->payer_id = $student->id;
            $localTran->transaction_amount = $amount;
            $localTran->payment_status = "Not Paid";
            $localTran->transaction_code = SundryTransaction::generateTransactionID();
            $localTran->payer_type = "Student";
            $localTran->code = "PSC";
            $localTran->session = $session;
            $localTran->save();
            $localTrans[] = $localTran;
        } else {
            $pendingAmount = 0;
            $amountPaid = 0;
            foreach ($localTrans as $trans) {
                if ($trans->payment_status == "Paid" || $trans->payment_status == "Waived")
                    $amountPaid += $trans->transaction_amount;
                else {
                    $pendingAmount += $trans->transaction_amount;
                }
            }
            if ($amount > ($amountPaid + $pendingAmount)) {
                $localTran = new SundryTransaction();
                $localTran->payer_id = $student->id;
                $localTran->transaction_amount = $amount - $amountPaid;
                $localTran->payment_status = "Not Paid";
                $localTran->transaction_code = SundryTransaction::generateTransactionID();
                $localTran->payer_type = "Student";
                $localTran->code = "PSC";
                $localTran->session = $session;
                $localTran->save();
                $localTrans[] = $localTran;
            }
            $totalAmountPaid = $amountPaid;

        }
        return ["transactions" => $localTrans, "totalAmountPaid" => $totalAmountPaid, "amountPayable" => $amount];

    }

    public static function payVivaStudent(Student $student,$amount,$session)
    {
        $localTrans = SundryTransaction::where(["payer_id"=>$student->id,"session"=>$session,"payer_type"=>"Student"])->orderBy("payment_status","DESC")->get();
        $totalAmountPaid = 0;
        if(count($localTrans) === 0){
            $localTran = new SundryTransaction();
            $localTran->payer_id = $student->id;
            $localTran->transaction_amount = $amount;
            $localTran->payment_status = "Not Paid";
            $localTran->transaction_code = SundryTransaction::generateTransactionID();
            $localTran->payer_type = "Student";
            $localTran->session = $session;
            $localTran->save();
            $localTrans[] = $localTran;
        }else{
            $pendingAmount = 0;
            $amountPaid = 0;
            foreach ($localTrans as $trans){
                if( $trans->payment_status=="Paid" )
                    $amountPaid += $trans->transaction_amount;
                else{
                    $pendingAmount += $trans->transaction_amount;
                }
            }
            if($amount > ($amountPaid + $pendingAmount) ){
                $localTran = new SundryTransaction();
                $localTran->payer_id = $student->id;
                $localTran->transaction_amount = $amount - $amountPaid;
                $localTran->payment_status = "Not Paid";
                $localTran->transaction_code = SundryTransaction::generateTransactionID();
                $localTran->session = $session;
                $localTran->save();
                $localTrans[] = $localTran;
            }
            $totalAmountPaid = $amountPaid;

        }
        return ["transactions"=>$localTrans,"totalAmountPaid"=>$totalAmountPaid,"amountPayable"=>$amount];

    }


    public function paidSundryCharges(Student $student,$amount,$session,$type=null)
    {
        $localTrans = SundryTransaction::where(["payer_id"=>$student->id,"session"=>$session,"payer_type"=>"Student"])->orderBy("payment_status","DESC")->get();
        $totalAmountPaid = 0;
        if(count($localTrans) === 0){
            $localTran = new SundryTransaction();
            $localTran->payer_id = $student->id;
            $localTran->transaction_amount = $amount;
            $localTran->payment_status = "Not Paid";
            $localTran->transaction_code = SundryTransaction::generateTransactionID();
            $localTran->payer_type = "Student";
            $localTran->session = $session;
            $localTran->save();
            $localTrans[] = $localTran;
        }else{
            $pendingAmount = 0;
            $amountPaid = 0;
            foreach ($localTrans as $trans){
                if( $trans->payment_status=="Paid" || $trans->payment_status=="Waived" )
                    $amountPaid += $trans->transaction_amount;
                else{
                    $pendingAmount += $trans->transaction_amount;
                }
            }
            if($amount > ($amountPaid + $pendingAmount) ){
                $localTran = new SundryTransaction();
                $localTran->payer_id = $student->id;
                $localTran->transaction_amount = $amount - $amountPaid;
                $localTran->payment_status = "Not Paid";
                $localTran->transaction_code = SundryTransaction::generateTransactionID();
                $localTran->session = $session;
                $localTran->save();
                $localTrans[] = $localTran;
            }
            $totalAmountPaid = $amountPaid;

        }
        return ["transactions"=>$localTrans,"totalAmountPaid"=>$totalAmountPaid,"amountPayable"=>$amount];

    }
}
