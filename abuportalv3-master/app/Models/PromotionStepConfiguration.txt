<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class PromotionStepConfiguration extends Model
{
    use HasFactory;

    protected $fillable = [
        'promotion_exercise_id',
        'step_id',
        'complex_id',
        'faculty_id',
        'department_id',
        'approver_type',
        'approver_role',
        'approver_user_id',
        'order',
        'status'
    ];

    protected $casts = [
        'complex_id' => 'integer',
        'faculty_id' => 'integer',
        'department_id' => 'integer',
        'approver_user_id' => 'integer',
    ];

    public function promotionExercise()
    {
        return $this->belongsTo(PromotionExercise::class);
    }

    public function step()
    {
        return $this->belongsTo(PromotionStep::class);
    }

    public function complex()
    {
        return $this->belongsTo(Complex::class);
    }

    public function faculty()
    {
        return $this->belongsTo(Faculty::class);
    }

    public function department()
    {
        return $this->belongsTo(Department::class);
    }

    public function approverUser()
    {
        return $this->belongsTo(User::class, 'approver_user_id');
    }

    public function progress()
    {
        return $this->hasMany(PromotionProgress::class);
    }

    public function scopeActive($query)
    {
        return $query->where('status', 'Active');
    }

    public function scopeForComplex($query, $complexId)
    {
        return $query->where(function($q) use ($complexId) {
            $q->where('complex_id', $complexId)
              ->orWhereNull('complex_id');
        });
    }

    public function scopeForFaculty($query, $facultyId)
    {
        return $query->where(function($q) use ($facultyId) {
            $q->where('faculty_id', $facultyId)
              ->orWhereNull('faculty_id');
        });
    }

    public function scopeForDepartment($query, $departmentId)
    {
        return $query->where(function($q) use ($departmentId) {
            $q->where('department_id', $departmentId)
              ->orWhereNull('department_id');
        });
    }

    public function scopeOrdered($query)
    {
        return $query->orderBy('order');
    }
}
