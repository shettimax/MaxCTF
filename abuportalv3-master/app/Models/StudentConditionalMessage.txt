<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class StudentConditionalMessage extends Model
{
    //
    public function student()
    {
        return Student::find($this->student_id);
    }

    public function conditional_messages()
    {
        return [
            "seen_messages_ids" => explode(',',$this->seen_messages),
            "answered_messages_ids" => explode(',',$this->answered_messages)
        ];

    }

    public function unread_conditional_messages()
    {
        return ConditionalMessage::whereNotIn('id',$this->conditional_messages()['seen_messages_ids'])
            ->get();
    }

    public function unanswered_conditional_messages()
    {
        return ConditionalMessage::whereNotIn('id',$this->conditional_messages()['answered_messages_ids'])
            ->where("message_type","=","answer")
            ->get();
    }

    public function hasSeen($conditional_message_id)
    {
        $cm = $this->conditional_messages();
        if(!in_array($conditional_message_id,$cm["seen_messages_ids"])){
            $cm["seen_messages_ids"][] = $conditional_message_id;
            $this->seen_messages = implode(',',$cm['seen_messages_ids']);
            $this->save();
        }

    }

    public function hasAgreed($conditional_message_id)
    {
        $cm = $this->conditional_messages();
        if(!in_array($conditional_message_id,$cm["answered_messages_ids"])){
            $cm["answered_messages_ids"][] = $conditional_message_id;
            $this->answered_messages = implode(',',$cm['answered_messages_ids']);
            $this->save();
        }

    }
}
