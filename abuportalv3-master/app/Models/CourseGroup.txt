<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class CourseGroup extends Model
{
    public function course(){
        return $this->belongsTo(Course::class);
    }

    public function courseperiods(){
        return $this->hasMany(CoursePeriod::class)->join('facilities', 'facilities.id', '=', 'course_periods.facility_id')->select('facilities.id as facility_id', 'course_periods.id as course_period_id', 'course_periods.day', 'course_periods.start', 'course_periods.end');
    }

    public function courselecturers(){
        return $this->hasMany(CourseLecturer::class);
    }

    public function employees()
    {
        return $this->belongsToMany(Employee::class, 'course_lecturers');
    }

    public function students()
    {
        return $this->belongsToMany(Student::class, 'course_registrations');
    }

    public static function highestSession()
    {
        return CourseGroup::orderBy('session',"DESC")->groupBy('session')->first()->session;
    }

    public function registeredStudentCount()
    {
        return CourseRegistration::where(['course_group_id'=>$this->id])->count();
    }

    public function canBeRegistered()
    {
        return $this->registeredStudentCount() < $this->maxsize;
    }
}
