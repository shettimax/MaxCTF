<?php
/**
 * Simple test script to verify the upload handler setup
 * Run this from command line: php test_setup.php
 * Or access via browser: http://your-domain.com/test_setup.php
 */

echo "=== External File Server Setup Test ===\n\n";

// Test 1: Check if upload_handler.php exists
echo "1. Checking upload_handler.php existence... ";
if (file_exists('upload_handler.php')) {
    echo "✓ Found\n";
} else {
    echo "✗ Not found\n";
    exit(1);
}

// Test 2: Check if directories can be created
echo "2. Testing directory creation... ";
$testDir = '/tmp/upload_test_' . uniqid();
if (mkdir($testDir, 0755, true)) {
    echo "✓ Success\n";
    rmdir($testDir);
} else {
    echo "✗ Failed\n";
}

// Test 3: Test upload_handler response (simulate direct access)
echo "3. Testing upload_handler direct access... ";
ob_start();
$_SERVER['REQUEST_METHOD'] = 'GET';
$_SERVER['REQUEST_URI'] = '/upload_handler.php';
include 'upload_handler.php';
$output = ob_get_clean();

if (!empty($output)) {
    $response = json_decode($output, true);
    if (isset($response['status']) && $response['status'] === 'online') {
        echo "✓ Handler responds correctly\n";
        echo "   Server: " . $response['server'] . "\n";
        echo "   Version: " . $response['version'] . "\n";
    } else {
        echo "✗ Unexpected response\n";
        echo "   Response: " . substr($output, 0, 100) . "...\n";
    }
} else {
    echo "✗ No response\n";
}

// Test 4: Check if we can create a test file
echo "4. Testing file operations... ";
$testFile = '/tmp/test_upload_' . uniqid() . '.txt';
if (file_put_contents($testFile, 'test content')) {
    echo "✓ File write successful\n";
    if (unlink($testFile)) {
        echo "   File cleanup successful\n";
    }
} else {
    echo "✗ File write failed\n";
}

// Test 5: Check PHP extensions
echo "5. Checking PHP extensions...\n";
$required = ['json', 'fileinfo', 'mbstring'];
foreach ($required as $ext) {
    echo "   - $ext: ";
    if (extension_loaded($ext)) {
        echo "✓ Loaded\n";
    } else {
        echo "✗ Missing\n";
    }
}

// Test 6: Check configuration
echo "6. Checking PHP configuration...\n";
echo "   - file_uploads: " . (ini_get('file_uploads') ? '✓ Enabled' : '✗ Disabled') . "\n";
echo "   - upload_max_filesize: " . ini_get('upload_max_filesize') . "\n";
echo "   - post_max_size: " . ini_get('post_max_size') . "\n";
echo "   - max_execution_time: " . ini_get('max_execution_time') . "s\n";

echo "\n=== Test Complete ===\n";

// If running via web, show as HTML
if (isset($_SERVER['HTTP_HOST'])) {
    echo "<script>document.body.innerHTML = '<pre>' + document.body.textContent + '</pre>';</script>";
}
?>
