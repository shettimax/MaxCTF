# Apache Configuration for External File Server
# Place this in your Apache sites-available directory or include it in your main config

<VirtualHost *:80>
    ServerName static.abu.edu.ng
    ServerAdmin webmaster@your-external-server.com
    DocumentRoot /var/www/

    # Enable rewrite engine
    RewriteEngine On

    # API endpoints for file operations - route all to upload_handler.php
    RewriteRule ^/api/upload/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/file/exists/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/file/url/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/file/delete/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/file/metadata/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/status/?$ /upload_handler.php [L,QSA]

    # Fallback for any other /api/ requests
    RewriteRule ^/api/(.*)$ /upload_handler.php?endpoint=$1 [L,QSA]

    # Serve uploaded files directly
    Alias /uploads /var/www/uploads
    <Directory /var/www/uploads>
        Options -Indexes
        AllowOverride None
        Require all granted

        # Set proper MIME types
        AddType application/pdf .pdf
        AddType application/vnd.openxmlformats-officedocument.spreadsheetml.sheet .xlsx
        AddType application/vnd.ms-excel .xls
        AddType text/csv .csv
        AddType image/jpeg .jpg .jpeg
        AddType image/png .png

        # Security headers
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
    </Directory>

    # Main web directory
    <Directory /var/www/>
        Options -Indexes -FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/external_file_error.log
    CustomLog ${APACHE_LOG_DIR}/external_file_access.log combined

    # PHP settings
    <FilesMatch \.php$>
        SetHandler application/x-httpd-php
    </FilesMatch>

    # Disable access to sensitive files
    <FilesMatch "\.(log|conf|env|key)$">
        Require all denied
    </FilesMatch>
</VirtualHost>

# HTTPS Configuration (recommended for production)
<VirtualHost *:443>
    ServerName your-external-server.com
    ServerAdmin webmaster@your-external-server.com
    DocumentRoot /var/www/

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /path/to/your/certificate.crt
    SSLCertificateKeyFile /path/to/your/private.key
    SSLCertificateChainFile /path/to/your/chain.crt

    # Enable rewrite engine
    RewriteEngine On

    # API endpoints for file operations - route all to upload_handler.php
    RewriteRule ^/api/upload/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/file/exists/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/file/url/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/file/delete/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/file/metadata/?$ /upload_handler.php [L,QSA]
    RewriteRule ^/api/status/?$ /upload_handler.php [L,QSA]

    # Fallback for any other /api/ requests
    RewriteRule ^/api/(.*)$ /upload_handler.php?endpoint=$1 [L,QSA]

    # Serve uploaded files directly
    Alias /uploads /var/www/uploads
    <Directory /var/www/uploads>
        Options -Indexes
        AllowOverride None
        Require all granted

        # Set proper MIME types
        AddType application/pdf .pdf
        AddType application/vnd.openxmlformats-officedocument.spreadsheetml.sheet .xlsx
        AddType application/vnd.ms-excel .xls
        AddType text/csv .csv
        AddType image/jpeg .jpg .jpeg
        AddType image/png .png

        # Security headers
        Header always set X-Content-Type-Options nosniff
        Header always set X-Frame-Options DENY
        Header always set X-XSS-Protection "1; mode=block"
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    </Directory>

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/external_file_error.log
    CustomLog ${APACHE_LOG_DIR}/external_file_access.log combined

    # PHP settings
    <FilesMatch \.php$>
        SetHandler application/x-httpd-php
    </FilesMatch>

    # Security settings
    <Directory /var/www/>
        Options -Indexes -FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # Disable access to sensitive files
    <FilesMatch "\.(log|conf|env|key)$">
        Require all denied
    </FilesMatch>
</VirtualHost>
