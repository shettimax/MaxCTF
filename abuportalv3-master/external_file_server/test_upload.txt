<?php
/**
 * Test Script for External File Server
 * Use this to test if your file server is working correctly
 */

// Configuration - Update these values
$config = [
    'api_url' => 'https://your-external-server.com/api',
    'api_key' => 'your-secret-api-key-here',
    'test_file' => 'test_upload.txt'
];

// Create test file
$testContent = "This is a test file created at " . date('Y-m-d H:i:s') . "\n";
file_put_contents($config['test_file'], $testContent);

echo "ðŸ§ª Testing External File Server\n";
echo "================================\n\n";

// Test 1: File Upload
echo "1ï¸âƒ£ Testing File Upload...\n";
$uploadResult = testFileUpload($config);
if ($uploadResult['success']) {
    echo "âœ… Upload successful!\n";
    echo "   File ID: {$uploadResult['id']}\n";
    echo "   URL: {$uploadResult['url']}\n";
    echo "   Path: {$uploadResult['path']}\n\n";

    $uploadedPath = $uploadResult['path'];
} else {
    echo "âŒ Upload failed: {$uploadResult['error']}\n\n";
    exit(1);
}

// Test 2: Check File Exists
echo "2ï¸âƒ£ Testing File Existence Check...\n";
$existsResult = testFileExists($config, $uploadedPath);
if ($existsResult['success']) {
    echo "âœ… File exists check successful!\n";
    echo "   Exists: " . ($existsResult['exists'] ? 'Yes' : 'No') . "\n\n";
} else {
    echo "âŒ File exists check failed: {$existsResult['error']}\n\n";
}

// Test 3: Get File URL
echo "3ï¸âƒ£ Testing Get File URL...\n";
$urlResult = testGetFileUrl($config, $uploadedPath);
if ($urlResult['success']) {
    echo "âœ… Get URL successful!\n";
    echo "   URL: {$urlResult['url']}\n\n";
} else {
    echo "âŒ Get URL failed: {$urlResult['error']}\n\n";
}

// Test 4: Get File Metadata
echo "4ï¸âƒ£ Testing Get File Metadata...\n";
$metadataResult = testGetMetadata($config, $uploadedPath);
if ($metadataResult['success']) {
    echo "âœ… Get metadata successful!\n";
    echo "   Size: {$metadataResult['size']} bytes\n";
    echo "   MIME Type: {$metadataResult['mime_type']}\n";
    echo "   Created: {$metadataResult['created_at']}\n\n";
} else {
    echo "âŒ Get metadata failed: {$metadataResult['error']}\n\n";
}

// Test 5: File Download (verify content)
echo "5ï¸âƒ£ Testing File Download...\n";
$downloadResult = testFileDownload($urlResult['url']);
if ($downloadResult['success']) {
    echo "âœ… File download successful!\n";
    echo "   Content matches: " . ($downloadResult['content_matches'] ? 'Yes' : 'No') . "\n\n";
} else {
    echo "âŒ File download failed: {$downloadResult['error']}\n\n";
}

// Test 6: Delete File
echo "6ï¸âƒ£ Testing File Deletion...\n";
$deleteResult = testFileDelete($config, $uploadedPath);
if ($deleteResult['success']) {
    echo "âœ… File deletion successful!\n\n";
} else {
    echo "âŒ File deletion failed: {$deleteResult['error']}\n\n";
}

// Cleanup
unlink($config['test_file']);

echo "ðŸŽ‰ All tests completed!\n";
echo "Your external file server is working correctly.\n";

/**
 * Test file upload
 */
function testFileUpload($config) {
    $ch = curl_init();

    $postData = [
        'file' => new CURLFile($config['test_file']),
        'path' => 'test',
        'options' => json_encode(['category' => 'test', 'test' => true])
    ];

    curl_setopt_array($ch, [
        CURLOPT_URL => $config['api_url'] . '/upload',
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $postData,
        CURLOPT_HTTPHEADER => [
            'Authorization: Bearer ' . $config['api_key'],
            'Accept: application/json'
        ],
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_TIMEOUT => 30
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($response === false) {
        return ['success' => false, 'error' => 'cURL error'];
    }

    $data = json_decode($response, true);

    if ($httpCode === 200 && isset($data['success']) && $data['success']) {
        return ['success' => true, 'id' => $data['id'], 'url' => $data['url'], 'path' => $data['path']];
    } else {
        return ['success' => false, 'error' => $data['error'] ?? 'Unknown error'];
    }
}

/**
 * Test file existence check
 */
function testFileExists($config, $path) {
    $ch = curl_init();

    curl_setopt_array($ch, [
        CURLOPT_URL => $config['api_url'] . '/file/exists?path=' . urlencode($path),
        CURLOPT_HTTPHEADER => [
            'Authorization: Bearer ' . $config['api_key'],
            'Accept: application/json'
        ],
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_TIMEOUT => 30
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($response === false) {
        return ['success' => false, 'error' => 'cURL error'];
    }

    $data = json_decode($response, true);

    if ($httpCode === 200 && isset($data['exists'])) {
        return ['success' => true, 'exists' => $data['exists']];
    } else {
        return ['success' => false, 'error' => $data['error'] ?? 'Unknown error'];
    }
}

/**
 * Test get file URL
 */
function testGetFileUrl($config, $path) {
    $ch = curl_init();

    curl_setopt_array($ch, [
        CURLOPT_URL => $config['api_url'] . '/file/url?path=' . urlencode($path),
        CURLOPT_HTTPHEADER => [
            'Authorization: Bearer ' . $config['api_key'],
            'Accept: application/json'
        ],
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_TIMEOUT => 30
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($response === false) {
        return ['success' => false, 'error' => 'cURL error'];
    }

    $data = json_decode($response, true);

    if ($httpCode === 200 && isset($data['url'])) {
        return ['success' => true, 'url' => $data['url']];
    } else {
        return ['success' => false, 'error' => $data['error'] ?? 'Unknown error'];
    }
}

/**
 * Test get file metadata
 */
function testGetMetadata($config, $path) {
    $ch = curl_init();

    curl_setopt_array($ch, [
        CURLOPT_URL => $config['api_url'] . '/file/metadata?path=' . urlencode($path),
        CURLOPT_HTTPHEADER => [
            'Authorization: Bearer ' . $config['api_key'],
            'Accept: application/json'
        ],
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_TIMEOUT => 30
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($response === false) {
        return ['success' => false, 'error' => 'cURL error'];
    }

    $data = json_decode($response, true);

    if ($httpCode === 200 && isset($data['size'])) {
        return ['success' => true, 'size' => $data['size'], 'mime_type' => $data['mime_type'], 'created_at' => $data['created_at']];
    } else {
        return ['success' => false, 'error' => $data['error'] ?? 'Unknown error'];
    }
}

/**
 * Test file download
 */
function testFileDownload($url) {
    $ch = curl_init();

    curl_setopt_array($ch, [
        CURLOPT_URL => $url,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_TIMEOUT => 30
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($response === false) {
        return ['success' => false, 'error' => 'cURL error'];
    }

    if ($httpCode === 200) {
        $originalContent = file_get_contents('test_upload.txt');
        $contentMatches = trim($response) === trim($originalContent);

        return ['success' => true, 'content_matches' => $contentMatches];
    } else {
        return ['success' => false, 'error' => "HTTP error: {$httpCode}"];
    }
}

/**
 * Test file deletion
 */
function testFileDelete($config, $path) {
    $ch = curl_init();

    $postData = ['path' => $path];

    curl_setopt_array($ch, [
        CURLOPT_URL => $config['api_url'] . '/file/delete',
        CURLOPT_POST => true,
        CURLOPT_POSTFIELDS => $postData,
        CURLOPT_HTTPHEADER => [
            'Authorization: Bearer ' . $config['api_key'],
            'Accept: application/json'
        ],
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_SSL_VERIFYPEER => false,
        CURLOPT_TIMEOUT => 30
    ]);

    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    curl_close($ch);

    if ($response === false) {
        return ['success' => false, 'error' => 'cURL error'];
    }

    $data = json_decode($response, true);

    if ($httpCode === 200 && isset($data['success']) && $data['success']) {
        return ['success' => true];
    } else {
        return ['success' => false, 'error' => $data['error'] ?? 'Unknown error'];
    }
}
?>
