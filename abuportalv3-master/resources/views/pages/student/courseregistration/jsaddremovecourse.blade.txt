<script type = "text/javascript">
    //Toggles checkbox to add/remove course in/from DB and Preview
    $(document).on('click', '.register-course-chkbox', function(){
        //Gets the course code to be rendered on preview row
        coursecode = $(this).parent().prev().prev().prev().prev().prev().prev().prev().html();
        coursetitle = $(this).parent().prev().prev().prev().prev().prev().prev().html();
        //Gets the course unit to be rendered on preview row
        courseunit = $(this).parent().prev().prev().prev().prev().prev().html();
        //Global variable that keeps selected course credit unit
        ctcur = courseunit;
        //Gets the previously set groupids
        oldlecturegroupid = $(this).attr("lecture_group_id");
        oldlabgroupid = $(this).attr("lab_group_id");
        //An gloabl array variable to keep the group ids of the currently selected course via checkbox
        currentcoursegroupids = [];
        //A global variable array variable to keep the id of the current course selected via checkbox
        currentcourseid = $(this).attr("course_id");
        //A global variable array variable to keep the coursecode of the current course selected via checkbox for validation purpose
        currentcoursecode = coursecode;



        if($(this).prop("checked") == true){
            //Clears existing entries on checkbox
            $("#add-course-modal .course_validation_error").html("");
            $("#add-course-modal input[name='coursecode']").val("");
            $("#add-course-modal .coursedetails").html("");
            //Renders the header on the modal dialog
            $("#add-course-modal .coursedetails").html("<strong>"+coursecode + " - " + coursetitle+"</strong>");
            //Gets the current selected groupids
            newlecturegroupid = $(this).parent().prev().prev().children().first().find("option:selected").val();
            newlabgroupid = $(this).parent().prev().children().first().find("option:selected").val();
            //Gets the course group no to be rendered on preview row
            lecturegroupno = $(this).parent().prev().prev().children().first().find("option:selected").text();
            labgroupno = $(this).parent().prev().children().first().find("option:selected").text();
            //Keeps the number of available groups for Labs
            configuredlabgroups = $(this).parent().prev().children().first().find("option").length;

            //Checks if lecture group is selected otherwise show validation message via an alert
            if(newlecturegroupid != ""){
                //Check if labs are schedules and lab group is not selected otherwise show validation message via an alert
                if((configuredlabgroups > 1) && newlabgroupid == ""){
                    alert("Lab group must be selected for this course");
                    $(this).prop("checked", false);
                }else{
                    //Checks for exhaustive maximum credit unit
                    if((getTcur() + (courseunit*1))>maxregistrationunit){
                        alert("You have exhausted your maximum credit unit");
                    }else{
                        //Loads modal for verification of add course operation
                        $("#add-course-modal").modal();
                        //Keeps course group ids for old and new selection of course groups. This will be sent to DB
                        currentcoursegroupids.push(newlecturegroupid+"-"+oldlecturegroupid); currentcoursegroupids.push(newlabgroupid+"-"+oldlabgroupid);
                        //Ensures proper display of lecture/lab group nos on preview area
                        coursegroups = (labgroupno == "None") ? [lecturegroupno] : [lecturegroupno, labgroupno];
                        //Stores html for adding a new row to preview area
                        $("#add-course-modal input[name='preview-tr-html']").val("<tr class = 'preview-tr-"+$(this).attr("course_id")+"'><td>"+coursecode+"</td><td class = 'preview-course-unit'>"+courseunit+"</td><td>"+coursegroups.join("/")+"</td></tr>");
                    }
                    //Uncheck the checkbox. Checkbox will only be checked if insertion is successful via ajax
                    $(this).prop("checked", false);
                }
            }else{
                alert("Lecture group must be selected");
                $(this).prop("checked", false);
            }

        }else if($(this).prop("checked") == false){
            //Remove course from DB
            //Clears existing entries on checkbox
            $("#delete-course-modal .course_validation_error").html("");
            $("#delete-course-modal input[name='coursecode']").val("");
            $("#delete-course-modal .coursedetails").html("");
            //Renders the header on the modal dialog
            $("#delete-course-modal .coursedetails").html("<strong>"+coursecode + " - " + coursetitle+"</strong>");
            //Gets the current selected groupids
            currentcoursegroupids.push(oldlecturegroupid); currentcoursegroupids.push(oldlabgroupid);
            $(this).prop("checked", true);
            $("#delete-course-modal").modal();
        }
    });

    $(document).on('click', '#add-course-btn', function(){

        console.log(currentcoursegroupids);

        //Validates entry for course code on dialog. If valid then perform ajax insert
        if($("#add-course-modal input[name='coursecode']").val() != currentcoursecode){
            $("#add-course-modal .course_validation_error").html("Provide a course code that matches your selection");
        }else{
            //************************Needed to perform ajax request*********************/
            $.ajaxSetup({headers: {'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content')}});
            //****************************************************************************/
            $.ajax({type: 'GET',
                url: '@php echo route('courseregistration.addcourse') @endphp',
                data: {coursegroupids: currentcoursegroupids},
                success: function(data){
                    //Sets the coursegroup ids for both lecture and lab available on checkbox to new course group ids
                    console.log(data);
                    if(data.length == 2)
                        $("input[course_id='"+currentcourseid+"']").attr("lab_group_id", data[1]);
                    $("input[course_id='"+currentcourseid+"']").attr("lecture_group_id", data[0]);
                    //Adds to a new row preview area
                    $("#courses-preview-table").append($("#add-course-modal input[name='preview-tr-html']").val())
                    //Ensure checkbox remain checked
                    $("input[course_id='"+currentcourseid+"']").prop("checked", true);
                    //Closes the modal
                    $("#add-course-modal").modal("hide")
                    //Updates the interface for tcur
                    a = ctcur * 1;
                    b = $(".tcur").html() * 1;
                    c = a+b;
                    $(".tcur").html(c);
                }
            });
        }
    });




    $(document).on('click', '#delete-course-btn', function(){
        //Validates entry for course code on dialog. If valid then perform ajax delete
        if($("#delete-course-modal input[name='coursecode']").val() != currentcoursecode){
            $("#delete-course-modal .course_validation_error").html("Provide a course code that matches your selection");
        }else{
            console.log(currentcoursegroupids);
            //************************Needed to perform ajax request*********************/
            $.ajaxSetup({headers: {'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content')}});
            //****************************************************************************/
            $.ajax({type: 'GET',
                url: '@php echo route('courseregistration.deletecourse') @endphp',
                data: {coursegroupids: currentcoursegroupids},
                success: function(data){
                    //Sets the coursegroup ids for both lecture and lab available on checkbox to new course group ids
                    console.log(data);
                    if(data.length == 2)
                        $("input[course_id='"+currentcourseid+"']").attr("lab_group_id", data[1]);
                    $("input[course_id='"+currentcourseid+"']").attr("lecture_group_id", data[0]);
                    //Remove existing row from preview
                    $(".preview-tr-"+currentcourseid).remove();
                    //Ensure checkbox remain checked
                    $("input[course_id='"+currentcourseid+"']").prop("checked", false);
                    //Closes the modal
                    $("#delete-course-modal").modal("hide")
                    a = ctcur * 1;
                    b = $(".tcur").html() * 1;
                    c = b-a;
                    $(".tcur").html(c);
                }
            });
        }
    });
</script>
