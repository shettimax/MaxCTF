<meta name="_token" content="{!! csrf_token() !!}" />
<script type = "text/javascript">
    $(document).ready(function(){


        //Sets active semester on form on selection of either First or Second Semester, then submits to controller
        $(document).on("click", ".activatesemester", function(){
            $("input[name='activesemester']").val($(this).prop("id"));
        });

        //Calls the getTcur Function to Render Total Credit Unit on Form
        $(".tcur").html(getTcur());

        //Renders registered Compulsory/Elective Course Groups
        //************************Needed to perform ajax request*********************/
        $.ajaxSetup({headers: {'X-CSRF-TOKEN': $('meta[name="_token"]').attr('content')}});
        //****************************************************************************/
        //Set selection for compulsory courses already rendered
        $.ajax({type: 'POST',
            url: '@php echo route('courseregistration.getregcompcoursegroups',[$session]) @endphp', //Ajax call accesses course_registrations table
            data:{
                activesemester: $("input[name='activesemester']").val() //Active semester selected
            },
            success: function(data) {
                // console.log(data)
                electivecourses = [];
                if (data.length > 0) {
                    $.each(data, function (idx, val) {

                        //if course is compulsory by finding a matching course group id
                        if ($(".lg > option[value = '" + val.pivot.course_group_id + "']").length != 0) {
                            optionelem = $(".lg > option[value = '" + val.pivot.course_group_id + "']").prop("selected", true);
                            inputchkelem = optionelem.closest("tr").children().last().children("input");
                            inputchkelem.prop('checked', true);
                            inputchkelem.attr('course_id', val.course_id);
                            if(val.grouptype == "LT")
                                inputchkelem.attr('lecture_group_id', val.pivot.course_group_id);
                            else
                                inputchkelem.attr('lab_group_id', val.pivot.course_group_id);

                        } else { // Otherwise if course is elective and could not find a matching course group id
                            //Populate an array of elective courses group ids
                            electivecourses.push(val.pivot.course_group_id);

                        }
                        // console.log(electivecourses);
                    });


                    //Get elective courses configured groups and set selection for elective courses, then renders them as part of the course form
                    if (electivecourses.length > 0) {
                        $.ajax({
                            type: 'POST',
                            url: '@php echo route('courseregistration.getregelectcoursegroups',[$session]) @endphp', //Ajax call accesses course_groups table
                            data: {
                                groupids: electivecourses
                            },
                            success: function (data) {
                                console.log(data,8);
                                //Gets last row serial number
                                sn =$(".xCountx").length;
                                $.each(data, function (idx1, val1) {

                                    sn = sn + 1;
                                    course = idx1.split(" &&& "); coursecode = course[0]; coursetitle = course[1]; courseunit = course[2]; course_id = course[3];
                                    //Gets a dropdown that contains preconfigured course groups for both lab and lectures groups
                                    coursegroups = getConfiguredCourseGroups(course_id);
                                    lecturedropdown = coursegroups[0]; labdropdown = coursegroups[1];
                                    //Append new rows to existing rows on course registration form
                                    $("#courses-to-register-table").append("<tr><td class='xCountx'>" + sn + "</td><td>" + coursecode + "</td><td>" + coursetitle + "</td><td>" + courseunit + "</td><td>E</td><td><a href='#' class='course-info' course_id='"+course_id+"'><i class = 'fa fa-info-circle' style = 'line-height:3; color: blue;'></i></a></td><td>" + lecturedropdown + "</td><td>" + labdropdown + "</td><td><input type = 'checkbox' class = 'register-course-chkbox' course_id = "+course_id+" lecture_group_id = '' lab_group_id = ''></td></tr>");
                                    //Sets the active course group id for a registered course (Both lecture and Lab)
                                    $.each(val1, function (idx2, val2) {
                                        coursegroup = val2.split(" &&& "); coursegroupid = coursegroup[0]; grouptype = coursegroup[1];
                                        if ($(".lg > option[value = '" + coursegroupid + "']").length != 0) {
                                            selectedoption = $(".lg > option[value = '" + coursegroupid + "']").prop("selected", true);
                                            selectedoption.closest("tr").children().last().children("input").prop('checked', true)
                                            if(grouptype == "LT")
                                                selectedoption.closest("tr").children().last().children("input").attr('lecture_group_id', coursegroupid);
                                            else
                                                selectedoption.closest("tr").children().last().children("input").attr('lab_group_id', coursegroupid);
                                        }
                                    });
                                });
                            }
                        });
                    }
                }
            }
        });
    });
</script>
