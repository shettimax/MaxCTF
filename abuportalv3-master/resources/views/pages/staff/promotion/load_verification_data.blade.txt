<style>
.verification-actions {
    text-align: center;
    white-space: nowrap;
}

.verification-actions .btn {
    margin: 2px 0;
    min-width: 80px;
    font-size: 11px;
    padding: 4px 8px;
}

.verification-actions .btn i {
    margin-right: 3px;
}
</style>

<div class="table-responsive">
    <table class="table table-bordered table-striped" id="verificationTable">
        <thead>
            <tr>
                <th>
                    <input type="checkbox" id="selectAll">
                </th>
                <th>S/N</th>
                <th>Action</th>
                <th>Year</th>
                <th>Complex</th>
                <th>Faculty</th>
                <th>Department</th>
                <th>Title</th>
                <th>Personnel No</th>
                <th>Name</th>
                <th>DOFAPT</th>
                <th>DOC</th>
                <th>DOLP</th>
                <th>Present Salary Step</th>
                <th>Publications</th>
                <th>Unit Status</th>
                <th>Faculty Status</th>
                <th>Complex Status</th>
                <th>Recommended Rank</th>
                <th>APC Recommendation</th>
                <th>Verification Status</th>
                <th>Verification Remark</th>
                <th>Verified By</th>
                <th>Verified At</th>
            </tr>
        </thead>
        <tbody>
            @foreach($staffs as $staff)
                @php
                    $c = json_decode($staff->publications);
                    $c = is_array($c) ? count($c) : 0;
                    $rank = \App\Models\Rank::find($staff->recommended_rank_id);
                    $rankOnEmpl = \App\Models\Rank::find($staff->rank_on_empl_id);

                    // Format verification status
                    $verificationStatusClass = '';
                    switch($staff->verification_status) {
                        case 'Pending':
                            $verificationStatusClass = 'status-pending';
                            break;
                        case 'Approved':
                            $verificationStatusClass = 'status-approved';
                            break;
                        case 'Rejected':
                            $verificationStatusClass = 'status-rejected';
                            break;
                    }

                    // Staff info for modal (as plain text for data attribute)
                    $staffInfo = "Name: {$staff->title} {$staff->name}\nPersonnel No: {$staff->personnel_no}\nDepartment: {$staff->department_name}\nFaculty: {$staff->faculty_name}\nComplex: {$staff->complex_name}\nRecommended Rank: {$staff->recommended_rank}\nCurrent Status: {$staff->verification_status}";
                @endphp
                <tr>
                    <td>
                        <input type="checkbox" name="staff_ids[]" value="{{ $staff->id }}">
                    </td>
                    <td>{{ $loop->index + 1 }}</td>
                    <td>
                        <div class="verification-actions">
                            <button type="button" class="btn btn-sm btn-primary verify-btn"
                                    data-id="{{ $staff->id }}"
                                    data-staff-info="{{ htmlspecialchars($staffInfo) }}">
                                <i class="fa fa-edit"></i> Verify
                            </button>
                            <br><br>
                            <button type="button" class="btn btn-sm btn-info view-cv-btn"
                                    data-id="{{ $staff->id }}"
                                    data-personnel-no="{{ $staff->personnel_no }}"
                                    data-name="{{ $staff->name }}">
                                <i class="fa fa-file-text"></i> View CV
                            </button>
                            <br><br>
                            <button type="button" class="btn btn-sm btn-success view-summary-btn"
                                    data-id="{{ $staff->id }}"
                                    data-personnel-no="{{ $staff->personnel_no }}"
                                    data-name="{{ $staff->name }}">
                                <i class="fa fa-list-alt"></i> Summary Sheet
                            </button>
                        </div>
                    </td>
                    <td>{{ $staff->year }}</td>
                    <td>{{ $staff->complex_name }}</td>
                    <td>{{ $staff->faculty_name }}</td>
                    <td>{{ $staff->department_name }}</td>
                    <td>{{ $staff->title }}</td>
                    <td>{{ $staff->personnel_no }}</td>
                    <td>{{ $staff->name }}</td>
                    <td>{{ $staff->dofapt }}</td>
                    <td>{{ $staff->doc }}</td>
                    <td>{{ $staff->dolp }}</td>
                    <td>{{ $staff->present_salary_step }}</td>
                    <td>{{ $c }}</td>
                    <td>{{ $staff->unit_status }}</td>
                    <td>{{ $staff->faculty_status }}</td>
                    <td>{{ $staff->complex_status }}</td>
                    <td>{{ $staff->recommended_rank }}</td>
                    <td>{{ $staff->central_apc_recommendation }}</td>
                    <td>
                        <span class="verification-status {{ $verificationStatusClass }}">
                            {{ $staff->verification_status ?? 'Pending' }}
                        </span>
                    </td>
                    <td>
                        @if($staff->verification_remark)
                            <span title="{{ $staff->verification_remark }}">
                                {{ Str::limit($staff->verification_remark, 50) }}
                            </span>
                        @else
                            <span class="text-muted">-</span>
                        @endif
                    </td>
                    <td>
                        @if($staff->verified_by)
                            {{ \App\Models\User::find($staff->verified_by)->name ?? 'Unknown' }}
                        @else
                            <span class="text-muted">-</span>
                        @endif
                    </td>
                    <td>
                        @if($staff->verified_at)
                            {{ \Carbon\Carbon::parse($staff->verified_at)->format('d M Y H:i') }}
                        @else
                            <span class="text-muted">-</span>
                        @endif
                    </td>
                </tr>
            @endforeach
        </tbody>
    </table>

    @if(count($staffs) > 0)
        <div class="row mt-20">
            <div class="col-md-12">
                <div class="alert alert-info">
                    <strong>Total Records:</strong> {{ count($staffs) }} recommendations found.
                    <br>
                    <strong>Note:</strong> Only APC recommended promotions that haven't been council approved are shown here.
                </div>
            </div>
        </div>
    @else
        <div class="row mt-20">
            <div class="col-md-12">
                <div class="alert alert-warning">
                    <strong>No Records Found:</strong> No promotion recommendations found matching your criteria.
                </div>
            </div>
        </div>
    @endif
</div>

<script>
$(document).ready(function() {
    // Initialize DataTable
    $('#verificationTable').DataTable({
        "pageLength": 25,
        "order": [[ 1, "asc" ]], // Order by S/N column
        "columnDefs": [
            { "orderable": false, "targets": [0, 2] } // Disable ordering on checkbox (0) and action (2) columns
        ]
    });

    // Select all checkbox
    $('#selectAll').on('change', function() {
        $('input[name="staff_ids[]"]').prop('checked', $(this).is(':checked'));
    });

    // Update select all when individual checkboxes change
    $('input[name="staff_ids[]"]').on('change', function() {
        var totalCheckboxes = $('input[name="staff_ids[]"]').length;
        var checkedCheckboxes = $('input[name="staff_ids[]"]:checked').length;

        if (checkedCheckboxes === totalCheckboxes) {
            $('#selectAll').prop('checked', true);
        } else {
            $('#selectAll').prop('checked', false);
        }
    });

    // View CV button handler
    $(document).on('click', '.view-cv-btn', function() {
        var personnelNo = $(this).data('personnel-no');
        var name = $(this).data('name');

        console.log('View CV clicked for:', personnelNo, name);
        console.log('Making request to:', '{{ route("staff.employee.find") }}');
        console.log('Request data:', {personnel_no: personnelNo});

        // First, we need to get the employee ID from personnel number
        $.get('{{ route("staff.employee.find") }}', {personnel_no: personnelNo})
            .done(function(response) {
                console.log('CV Response:', response);
                if (response.success && response.employee_id) {
                    // Open CV in new window/tab using the correct route
                    var cvUrl = '{{ route("staff.profile.cv.generate.html", ":employee_id") }}'.replace(':employee_id', response.employee_id);
                    console.log('Opening CV URL:', cvUrl);
                    window.open(cvUrl, '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
                } else {
                    console.error('CV Error:', response);
                    alert('Employee not found for personnel number: ' + personnelNo + '\nResponse: ' + JSON.stringify(response));
                }
            })
            .fail(function(xhr, status, error) {
                console.error('CV AJAX Error:', error, xhr.responseText);
                alert('Error finding employee with personnel number: ' + personnelNo + '\nError: ' + error + '\nResponse: ' + xhr.responseText);
            });
    });

    // View Summary Sheet button handler
    $(document).on('click', '.view-summary-btn', function() {
        var personnelNo = $(this).data('personnel-no');
        var name = $(this).data('name');

        // First, we need to get the employee ID from personnel number
        $.get('{{ route("staff.employee.find") }}', {personnel_no: personnelNo})
            .done(function(response) {
                console.log('Summary Response:', response);
                if (response.success && response.employee_id) {
                    // Create a form to submit to the summary POST route
                    var form = $('<form method="POST" action="{{ route("staff.profile.summary") }}" target="_blank">');
                    form.append('<input type="hidden" name="_token" value="' + $('meta[name="csrf-token"]').attr('content') + '">');
                    form.append('<input type="hidden" name="employee_id" value="' + response.employee_id + '">');
                    form.append('<input type="hidden" name="year" value="' + new Date().getFullYear() + '">');
                    console.log('Submitting summary form for employee ID:', response.employee_id);
                    $('body').append(form);
                    form.submit();
                    form.remove();
                } else {
                    console.error('Summary Error:', response);
                    // alert('Employee not found for personnel number: ' + personnelNo + '\nResponse: ' + JSON.stringify(response));
                }
            })
            .fail(function(xhr, status, error) {
                console.error('Summary AJAX Error:', error, xhr.responseText);
                // alert('Error finding employee with personnel number: ' + personnelNo + '\nError: ' + error + '\nResponse: ' + xhr.responseText);
            });
    });
});
</script>
