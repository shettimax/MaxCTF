<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <title>Document</title>
    <style>
        table.tspace td {
            margin: 46px;
        }
    </style>
</head>
<body>

    <center><H1>AHMADU BELLO UNIVERSITY,ZARIA</H1></center>
    <center><h4>Case of Recommendation for the {{$year}} Promotion Excercise</h4></center>
    {{-- <table width="100%">
        <tr>
            <td>SUMMARY SHEET</td>
            <td></td>
        </tr>
        <tr>
            <td style="text-align: left;">COMPLEX:{{$complex?$complex->name:""}}</td>
            <td style="text-align: right;">Faculty/Director:{{$faculty->name}}</td>
        </tr>
    </table> --}}
    <table width="100%" border="2">
        <tr>
            <th>S/N</th>
            <th>Case No</th>
            <th>P.No</th>
            <th>Name(surname first in capital letters)</th>
            <th>Department</th>
            <th>Faculty/Unit/Centre</th>
            <th>Qualification with Dates</th>
            <th>Date of First Appointment with Rank</th>
            <th>Date of Confirmation of Appointment</th>
            <th>Present Ranks & Salary with Step</th>
            <th>Date of Last Promotion, Redesignation and number of Publication</th>
            <th>1988 Guidelines Requirements for promotion & Candidates' Attainments/Performance</th>
            <th>Candidate Attainments for the Promotion</th>
            <th>Complex Recommendation</th>
        </tr>
       @foreach ($employees as $employee)

       @php

        // $year = $request->year;
        $dofp = $employee->date_of_first_appointment;//Carbon::parse($request->dofp)->format('jS F Y');
        $dolp= $employee->date_of_last_promotion;//Carbon::parse($request->dolp)->format('jS M, Y');
        $dofc= $employee->date_of_confirmation;//Carbon::parse($request->dofc)->format('jS F Y');
        $dord= $employee->date_of_redesignation;//Carbon::parse($request->dofc)->format('jS F Y');
        //$yearOfLastPromotion = $employee->date_of_last_promotion->format('Y');
        $nop = 0;//$request->nop;
        $rankonapp = App\Models\Rank::find($employee->rank_on_employment);
        $rankonapp = $rankonapp?$rankonapp->name:"";
        $presentrank = App\Models\Rank::find($employee->rank_id);
        $presentrank = $presentrank?$presentrank->name:"";
        $presentsalary = App\Models\SalaryGradeLevel::find($employee->salary_grade_level_id)->grade;
        $req = 1998;//explode(',',$request->req);
//        $att = explode(',',$request->att);
////        $sup = $request->sup;
        $employee_id = $employee->id;
        $title = $employee->title;
        $department = $employee->department?$employee->department:App\Models\Department::find(1);
        $faculty = App\Models\Faculty::find($department->faculty_id);
        $pno = strtolower($employee->personnel_no);
        $indexOfP = strpos($pno,"p");

        $publications = App\Models\EmployeePublication::selectRaw('type, COUNT(employee_id) as count')
            ->where(['employee_id'=>$employee_id])
            ->groupBy('type')
            ->get();

        $supervisions = App\Models\EmployeeSupervision::selectRaw('year, COUNT(employee_id) as count')
            ->where(['employee_id'=>$employee_id])
            ->groupBy('year')
            ->get();

        $complexStatus =  App\Models\PromotionRecomendation::select('unit_recommendation', 'complex_status')
            ->where('employee_id', $employee->id)
            ->where('year', $year)
            ->first();
        $qualifications = App\Models\EmployeeQualification::join("qualifications","qualifications.id","=","employee_qualifications.type")
            ->orderBy('ordering','DESC')
            ->where(['employee_id'=>$employee_id,'category'=>'Academic'])
            ->select(['qualification','course',DB::raw("YEAR(date) AS year")])
            ->get();    //employee_qualifications

        $pno = $pno;//strtoupper(substr($pno,0,$indexOfP+1)).".".number_format(substr($pno,$indexOfP+1),0);//

        $dept = $department;
        $fac = $faculty;
        $complex = $fac->complex();
        $dean = $fac->deanName();
        $cch = $complex?$complex->chairmanName():"";
        $string = $complex?$complex->name:"";
        preg_match('/\((.*?)\)/', $string, $matches);
        $letter = $matches[1]; // This will contain "B"
        @endphp

       <tr>
        <td>{{$loop->iteration}}</td>
        <td>{{$letter}}{{$loop->iteration}}</td>
        <td>{{$pno}}</td>
        <td>{{$employee->fullName()}}</td>
        <td>{{$department?$department->name:""}}</td>
        <td>{{$fac?$fac->name:""}}</td>
        <td>
            <ol type="i">

                @foreach($qualifications as $q)
                    <li>{{$q->qualification}} {{$q->course}} {{$q->year}}</li>
                @endforeach

            </ol>
        </td>
        <td>{{$dofp}} {{$rankonapp}}</td>
        <td>{{$dofc}}</td>
        <td>{{$presentrank}} {{ $presentsalary }}</td>
        <td>
            {{$dolp}} <br>Redesignation <br>{{$dord?:'Nill'}}
        </td>
        <td>
            <div>
                <h3>Guideline Requirement</h3>
                @if(count($qualifications))
                <ol type="i">
                    @php

                        $lpro=\Carbon\Carbon::parse($employee->date_of_last_promotion);
                         $yearOfLastPromotion=$lpro->format('Y');
                        $c=$year - $yearOfLastPromotion;
                    @endphp
                    <li>{{ $qualifications[0]->qualification }} {{ $qualifications[0]->course }}</li>
                    <li>{{$c}} years waiting period </li>
                </ol>
                @endif
            </div>

        </td>
        <td>
            <div>
                <h3>Attainment/Performance</h3>
                @if(count($qualifications))
                <ol type="i">
                    @php
                        $year = \Carbon\Carbon::now()->year;
                        $lpro=\Carbon\Carbon::parse($employee->date_of_last_promotion);
                         $yearOfLastPromotion=$lpro->format('Y');
                        $c=$year - $yearOfLastPromotion;
                    @endphp
                    <li>{{ $qualifications[0]->qualification }} {{ $qualifications[0]->course }}</li>
                    <li>{{$c}} years waiting period </li>
                </ol>
                @endif
                <h3>Publications</h3>
            @if (!$publications->isEmpty())
                    <table class="tspace">

                    <thead>
                    <tr>
                        <th>Type</th>
                        <th>Count</th>
                    </tr>
                    </thead>
                    <tbody>
                    @foreach ($publications as $publication)
                        <tr>
                            <td>{{ $publication->type }}</td>
                            <td>{{ $publication->count }} </td>
                            {{--{{ \Illuminate\Support\Str::plural('employee', $publication->count) }}--}}
                        </tr>
                    @endforeach

                    </tbody>
                </table>
                @else
                    <p>Nil</p>
                @endif
            </div>
            @if (!$supervisions->isEmpty())
            <table>
                <h3>Supervision</h3>
                <thead>
                <tr>
                    <th>Type</th>
                    <th>Count</th>
                </tr>
                </thead>
                <tbody>
                @foreach ($supervisions as $supervision)
                    <tr>
                        <td>{{ $supervision->year }}</td>
                        <td>{{ $supervision->count }}</td>
                        {{--{{ \Illuminate\Support\Str::plural('employee', $publication->count) }}--}}
                    </tr>
                @endforeach
                </tbody>
            </table>
            @else
                <p>Nil</p>
            @endif
        </td>
        <td>
            @if($complexStatus)
                @if($complexStatus->complex_status != 'Pending')
                    {{ $complexStatus->complex_status }}<br>
                    {{ $complexStatus->unit_recommendation }}
                @else
                    {{ $complexStatus->complex_status }}
                @endif
            @endif
        </td>
    </tr>
       @endforeach
    </table>

    <br>
    <br>


</body>
</html>
