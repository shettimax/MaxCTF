@extends("layout.staff.master")
@section("pageTitle")
    Update Candidate Programme Assignments
@endsection
@section("content")
    <style>
        /* Ensure important messages are never hidden */
        .alert.alert-danger,
        .alert.alert-warning,
        .permanent-notice {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            position: relative !important;
        }

        /* Prevent any fade effects on important messages */
        .alert.alert-danger *,
        .alert.alert-warning *,
        .permanent-notice * {
            display: block !important;
            visibility: visible !important;
        }
    </style>

    <section>
        <div class="col-md-11 blog-pull-right mt-12">
            @if(session('success'))
                <span class="alert alert-success" id="success"
                      style="border-radius:0;height: 48px;padding: 8px;margin-left: 320px;">
                    {{ session('success') }}
                </span>
                <script>
                    setTimeout(function () {
                        $("#success").fadeOut();
                    }, 4000);
                </script>
            @endif

            @if($errors->has('errors'))
                <div class="alert alert-danger" id="errors" style="border-radius:0;margin-left: 320px;">
                    <ul>
                        @foreach($errors->get('errors') as $error)
                            <li>{{ $error }}</li>
                        @endforeach
                    </ul>
                </div>
                <script>
                    setTimeout(function () {
                        $("#errors").fadeOut();
                    }, 8000);
                </script>
            @endif
        </div>

        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="bg-lightest border-1px p-30 mb-0">
                        <h3 class="text-theme-colored mt-0 pt-5">Update Candidate Programme Assignments</h3>
                        <hr>

                        <!-- Prominent Notice -->
                        <div class="alert alert-warning permanent-notice" style="border: 3px solid #e74c3c; margin-bottom: 25px; position: relative;">
                            <h6 class="mb-2">
                                <i class="fa fa-exclamation-circle"></i> <strong>CRITICAL INFORMATION:</strong>
                            </h6>
                            <p class="mb-1"><strong>Before uploading:</strong> Ensure you have selected the correct Session and Candidate Form Type, and that your Excel file contains the exact programme names as configured in the system.</p>

                            <!-- Permanent Sticky Note -->
                            <div class="mt-3 p-2" style="background-color: #fff3cd;  border-radius: 5px;">
                                <strong><i class="fa fa-thumb-tack"></i> PERMANENT REMINDER:</strong>
                                <ul class="mb-0 mt-1">
                                    <li>✓ Select the correct Session (e.g., 2024/2025)</li>
                                    <li>✓ Select the correct Candidate Form Type (PUTME or Direct Entry)</li>
                                    <li>✓ Ensure Excel programme names match exactly</li>
                                    <li>✓ Verify JAMB numbers exist in the system</li>
                                </ul>
                                <p>Upload an Excel file with two columns:</p>
                                <ul>
                                    <li><strong>Column A:</strong> JAMB Number (Candidate's username)</li>
                                    <li><strong>Column B:</strong> Programme Name (exact name as configured in the system)</li>
                                </ul>
                                <p><strong>Note:</strong> The first row should contain headers. Data processing starts from row 2.</p>
                                <p><strong>Important:</strong> You must select both the Session and Candidate Form Type (PUTME or Direct Entry) to ensure the correct form settings are used.</p>



                                <div class="mt-2">
                                    <a href="{{ route('candidate.update.programme.template') }}" class="btn btn-sm btn-outline-info">
                                        <i class="fa fa-download"></i> Download Excel Template
                                    </a>
                                </div>
                            </div>
                        </div>


                        <table class="table table-bordered table-condensed table-striped variations">
                            <thead>
                            <tr style="font-size: 12px;">
                                <th>JAMB Number</th>
                                <th>Programme Name</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td>12345678AB</td>
                                <td>Computer Science</td>
                            </tr>
                            <tr>
                                <td>87654321CD</td>
                                <td>Electrical Engineering</td>
                            </tr>
                            </tbody>
                        </table>

                        <form id="programmeupdate" name="programmeupdate"
                              action="{{ route('candidate.update.programme.bulk.post') }}" method="post"
                              enctype="multipart/form-data">
                            @csrf

                            <!-- Form Header Notice -->


                            <div class="row">
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label>Session <span class="text-danger">*</span></label>
                                        <select name="session" class="form-control required" required>
                                            <option value="">--Select Session--</option>
                                            @foreach(range(date("Y"),date("Y")-2) as $session)
                                                <option value="{{$session}}" {{ old('session') == $session ? 'selected' : '' }}>
                                                    {{$session}}/{{$session+1}}
                                                </option>
                                            @endforeach
                                        </select>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <div class="form-group">
                                        <label>Candidate Form Type <span class="text-danger">*</span></label>
                                        <select name="candidate_form_type" class="form-control required" required>
                                            <option value="">--Select Type--</option>
                                            @foreach($candidateFormTypes as $type)
                                                <option value="{{$type['id']}}" {{ old('candidate_form_type') == $type['id'] ? 'selected' : '' }}>
                                                    {{$type['name']}}
                                                </option>
                                            @endforeach
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label>Excel File <span class="text-danger">*</span></label>
                                        <input name="form_attachment" class="file form-control" type="file"
                                               data-show-upload="false" data-show-caption="true"
                                               accept=".xlsx,.xls" required>
                                        <small class="form-text text-muted">Only .xlsx and .xls files are allowed</small>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <a href="{{ route('candidate.update.programme.template') }}" class="btn btn-info btn-sm mt-20 pt-10 pb-10" target="_blank">
                                    <i class="fa fa-download"></i> Download Excel Template
                                </a>
                                <button type="submit" class="btn btn-primary btn-theme-colored btn-sm mt-20 pt-10 pb-10"
                                        data-loading-text="Processing...">
                                    <i class="fa fa-upload"></i> Update Programme Assignments
                                </button>
                                <a href="{{ route('candidate.add.bulk') }}" class="btn btn-secondary btn-sm mt-20 pt-10 pb-10 ml-2">
                                    <i class="fa fa-arrow-left"></i> Back to Bulk Upload
                                </a>
                            </div>

                            <!-- Processing Status -->
                            <div class="mt-3 p-2" style="background-color: #e2e3e5; border: 1px solid #d6d8db; border-radius: 5px;">
                                <small class="text-muted">
                                    <i class="fa fa-info-circle"></i> <strong>Processing Info:</strong>
                                    Files are processed in batches of 100 candidates for optimal performance.
                                    Progress will be shown during processing.
                                </small>
                            </div>
                        </form>


                        @if(isset($availableProgrammes) && count($availableProgrammes) > 0)
                        <div class="mt-4">
                            <h5><i class="fa fa-list text-info"></i> Available Programmes for {{ date('Y') }}/{{ date('Y')+1 }} Session:</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <h6><i class="fa fa-graduation-cap text-primary"></i> PUTME/DE Programmes:</h6>
                                    @php
                                        $putmeProgrammes = $availableProgrammes->filter(function($programme) {
                                            return \App\Models\FormSetting::where('programme_id', $programme->id)
                                                ->where('session', date('Y'))
                                                ->where('candidate_form_type_id', 1)
                                                ->exists();
                                        });
                                    @endphp
                                    @if($putmeProgrammes->count() > 0)
                                        <ul class="list-unstyled">
                                            @foreach($putmeProgrammes as $programme)
                                                <li><i class="fa fa-check text-success"></i> {{ $programme->name }}</li>
                                            @endforeach
                                        </ul>
                                    @else
                                        <p class="text-muted">No PUTME programmes configured for this session</p>
                                    @endif
                                </div>

                            </div>
                        </div>
                        @endif
                    </div>
                </div>
            </div>
        </div>
    </section>
@endsection
